----
title: "EDE Group Project"
author: "Gaby Czarniak, Mara Michel, Sam Sedar"
date: "2023-11-14"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(lubridate)
library(here); here()
library(rvest)
library(cowplot)
library(agricolae)
library(dplyr)
library(tidyverse)
library(lubridate)
library(trend)
library(zoo) 
library(Kendall)
library(tseries)
library(sf)
library(leaflet)
library(mapview); mapviewOptions(fgb = FALSE)

getwd()
```



```{r Data Load}

#Loading Data into Raw Data folder

plant <- read.csv(here('Data/Raw/PLNT21.csv'),
                  stringsAsFactors = FALSE, skip = 1, 
                  colClasses = c('FIPSST' = 'character', 
                                 'FIPSCNTY' = 'character',
                                 'ORISPL' = 'character'))

gen <- read.csv(here('Data/Raw/GEN21.csv'), 
                stringsAsFactors = FALSE, skip = 1, 
                  colClasses = c('ORISPL' = 'character'))

income <- read.csv(here('Data/Raw/PovertyEstimates.csv'), 
                  stringsAsFactors = TRUE, skip = 4)

unemployment <- read.csv(here('Data/Raw/Unemployment.csv'), 
                  stringsAsFactors = TRUE, skip = 4)


gen20 <- read.csv(here('Data/Raw/GEN20.csv'), 
                stringsAsFactors = FALSE, skip = 1, 
                  colClasses = c('ORISPL' = 'character'))


```


```{r}
#####  DATA WRANGLING  #####

#eGRID Data

#Selecting columns of interest from plant data
plant_select <- plant %>%
  select(PSTATABB, ORISPL, FIPSST, FIPSCNTY, PLFUELCT, NAMEPCAP,
         PLNGENAN,PLSO2RTA, PLCO2RTA, PLCH4RTA, PLN2ORTA, PLCO2AN, 
         PLSO2AN,PLCH4AN, CNTYNAME, LAT,
         LON, COALFLAG) %>%
  filter(PSTATABB == "NC") %>%
  unite(FIPS_Code, FIPSST, FIPSCNTY, sep = "")

plant_select$PLNGENAN <- as.numeric(plant_select$PLNGENAN)
plant_select$PLCO2RTA <- as.numeric(plant_select$PLCO2RTA)
plant_select$PLCO2AN <- as.numeric(plant_select$PLCO2AN)
plant_select$NAMEPCAP <- as.numeric(plant_select$NAMEPCAP)



#Combining Generator and Plant df based on ORISPL
plant_gen <- gen %>%
  inner_join(plant_select, by = 'ORISPL', 
             suffix = c("_gen", "_plant"))

plant_gen$CFACT <- as.numeric(plant_gen$CFACT)
plant_gen$GENNTOZ <- as.numeric(plant_gen$GENNTOZ)
plant_gen$NAMEPCAP_gen <- as.numeric(plant_gen$NAMEPCAP_gen)
plant_gen$GENNTAN <- as.numeric(plant_gen$GENNTAN)

#Removing duplicate state abbreviation column
plant_gen_data <- plant_gen[, -which(names(plant_gen) == "PSTATABB_plant")]


#UNEMPLOYMENT

#Selecting columns of interest: unemployment rates: 2002-2022

ue <- unemployment %>%
  select(FIPS_Code,	Unemployment_rate_2000,	Unemployment_rate_2001,	Unemployment_rate_2002,	Unemployment_rate_2003,	Unemployment_rate_2004,	Unemployment_rate_2005,	Unemployment_rate_2006,	Unemployment_rate_2007,	Unemployment_rate_2008,	Unemployment_rate_2009,	Unemployment_rate_2010,	Unemployment_rate_2011,	Unemployment_rate_2012,	Unemployment_rate_2013,	Unemployment_rate_2014,	Unemployment_rate_2015,	Unemployment_rate_2016,	Unemployment_rate_2017,	Unemployment_rate_2018,	Unemployment_rate_2019,	Unemployment_rate_2020,	Unemployment_rate_2021,	Unemployment_rate_2022)

#Merging with eGrid
ue_egrid <- merge(plant_gen_data, ue, by = "FIPS_Code")


#INCOME

#Selecting columns of interest: 
inc <- income %>%
  select(FIPS_Code, PCTPOVALL_2021, MEDHHINC_2021)

#Merging
processed_data <- merge(ue_egrid, inc, by = "FIPS_Code")

colnames(processed_data)


```

```{r}
#EXPLORATION
summary(processed_data)


```

```{r}
#Load in counties data
counties_sf<- st_read(here('Data/Spatial/cb_2018_us_county_20m.shp')) %>% 
  filter(STATEFP==37)

#Convert eGrid tabular data to spatial data
plant_gen_sf <-plant_gen_data %>% st_as_sf(coords = c('LON','LAT'), crs=4269)

#Create initial map of power plants
```


```{r}
gens_counties_map <-ggplot()+
  geom_sf(data=counties_sf)+
  geom_sf(data=plant_gen_sf,size=0.8)+
  labs(title = "Locations of NC Power Plants")

gens_counties_map

#Compute sum of nameplate capacity by county
nameplate_capacity <-plant_gen_data %>%
  group_by(CNTYNAME)%>%
  summarize(Sum_NAMEPCAP = sum(NAMEPCAP_plant))

#Join the eGrid attributes to the county spatial features
counties_sf_join <-  merge(x = counties_sf,
                           y = plant_gen_data, 
                           by.x = 'NAME', 
                           by.y = 'CNTYNAME' )

#Map total generator capacity by county
gen_cap_map <-ggplot(data=counties_sf_join)+
  geom_sf(aes(fill=NAMEPCAP_plant))
gen_cap_map

```



```{r Data Wrangling}

#Filter by North Carolina
Plant_NC <- plant %>% filter(PSTATABB=='NC')
gen_NC <-gen %>% filter(PSTATABB=='NC')

#Create Joined Plot
PowerPlants_DF <-merge(x=gen_NC,y=Plant_NC, by='ORISPL',all.x=TRUE)
```

```{r Creating income groupings}

# GENYRRET = Generator planned or actual retirement year (four-digit)
# GENYRONL - year the generator came online (four-digit)

summary(processed_data$GENYRRET) # 1161 NA's
retired_year <- processed_data$GENYRRET %>%
  na.omit()
# earliest year of plant retirement was 2021
# can't run time series analysis with this data, 
# but could run regression analysis to understand relationship between
# planned retirement and 2021 avg household income or
# 2021 retirement and 2021 unemployment
summary(retired_year)

summary(processed_data$GENYRONL) # no NA's
online_plants <- processed_data %>%
  # drop observations with NAs in GENYRONL
  # which means we don't know what year they came online
  # new number of observations should be 1175 (dropping 15 NAs)
  drop_na(GENYRONL) %>%
  select(FIPS_Code, CNTYNAME, SEQGEN, YEAR, PNAME, 
         GENID, GENSTAT, GENYRONL, NAMEPCAP_plant, 
         PLNGENAN, PLCO2AN, COALFLAG, MEDHHINC_2021,	
         Unemployment_rate_2000,	Unemployment_rate_2001,	
         Unemployment_rate_2002,	Unemployment_rate_2003,	
         Unemployment_rate_2004,	Unemployment_rate_2005,	
         Unemployment_rate_2006,	Unemployment_rate_2007,	
         Unemployment_rate_2008,	Unemployment_rate_2009,	
         Unemployment_rate_2010,	Unemployment_rate_2011,	
         Unemployment_rate_2012,	Unemployment_rate_2013,	
         Unemployment_rate_2014,	Unemployment_rate_2015,	
         Unemployment_rate_2016,	Unemployment_rate_2017,	
         Unemployment_rate_2018,	Unemployment_rate_2019,	
         Unemployment_rate_2020,	Unemployment_rate_2021,	
         Unemployment_rate_2022)
summary(online_plants)

online_year <- online_plants$GENYRONL
summary(online_year)

online_month_day_ <- rep(c("01-01-"), length(online_year))

# repeating month_day_ to fill in month and day
# for as many year entries as are found in 
# dropping NAs but may need to keep them in; decide as group
Date_Online <- paste0(online_month_day_,online_year)
summary(Date_Online)
head(Date_Online)
# 1175 observations in Date_Online

# change years to date formats
is.Date(Date_Online) # not a date
Date_Online <- as.Date(Date_Online, format = "%m-%d-%Y")
is.Date(Date_Online) # true

# ensure date column is in date format
online_plants <- online_plants %>%
  mutate(GENYRONL = Date_Online)
is.Date(online_plants$GENYRONL) # true

# identifying the county with the most power plants
county_freq_table <- table(online_plants$CNTYNAME)
view(county_freq_table)
max(county_freq_table) # 48, Robeson County
county_freq_table <- sort(county_freq_table, decreasing = TRUE)
view(county_freq_table)
robeson_online_plants <- online_plants %>%
  filter(CNTYNAME == "Robeson")
unique(robeson_online_plants$PNAME) # 44 unique power plant names
unique(robeson_online_plants$GENID) # 32 unique GENIDs

# multiple regression for just one county, Robeson 
# the one with highest total number of existing plants in 2021
# to understand relationship between year online for each power plant and unemployment 
# need to make table by year
# with 5 columns: Year, FIPS code, number of plants in existence that year, unemployment rate
robeson_year <- year(robeson_online_plants$GENYRONL)
robeson_FIPS_code <- robeson_online_plants$FIPS_Code
## MARKING WHERE GC LEFT OFF
robeson_plant_count <- tally(robeson_online_plants$PNAME, wt = NULL, sort = FALSE, name = NULL)
is.Date(robeson_online_plants$GENYRONL)

## WILL LIKELY NOT NEED 
## INCOME THRESHOLDS FOR TIME SERIES ANALYSIS
# Median Household Income for 2021
summary(processed_data$MEDHHINC_2021)

low_threshold <- 44477
medium_threshold <- 52463

# Create subsets based on income thresholds
low_income_subset <- processed_data[processed_data$MEDHHINC_2021 < low_threshold, ]

medium_income_subset <- processed_data[processed_data$MEDHHINC_2021 >= low_threshold & processed_data$MEDHHINC_2021 < medium_threshold, ]

high_income_subset <- processed_data[processed_data$MEDHHINC_2021 >= medium_threshold, ]

ts_low_income <- ts(low_income_subset$Unemployment_rate_2000:low_income_subset$Unemployment_rate_2022, start = min(low_income_subset$YEAR), end = max(low_income_subset$YEAR))


```


```{r Income and Fuel Category}

########### DATA EXPLORATION / VIZ #######################
#NC Breakdown of Fuel by Category
fuel_summarized <- processed_data %>%
  group_by(PLFUELCT) %>%
  summarise(total_generation = sum(PLNGENAN, na.rm = TRUE))
print(fuel_summarized)

#In percentages
fuel_summarized$percentage <- fuel_summarized$total_generation / sum(fuel_summarized$total_generation) * 100

#Pie chart with percent makeup of fuel in  NC
pie_chart_percentage <- ggplot(fuel_summarized, aes(x = factor(1), fill = PLFUELCT, y = percentage)) +
  geom_bar(width = 1, stat = "identity") +
  coord_polar(theta = "y") +
  labs(title = "North Carolina Primary Fuel (% of Total Annual Generation)",
       fill = "Primary Fuel Type",
       y = "Percentage of Total Generation (%)", x = NULL)
print(pie_chart_percentage)

#Relationship between income and fuel type
processed_data$MEDHHINC_2021 <- as.numeric(processed_data$MEDHHINC_2021)

#Scatter visualization
scatter_income_generation <- ggplot(processed_data, aes(x = MEDHHINC_2021, y = PLNGENAN, color = PLFUELCT)) +
  geom_point() +
  labs(title = "Relationship Between Annual Generation, Fuel Type, and Income",
       x = "Median Household Income",
       y = "Annual Generation",
       color = "Fuel Type")
print(scatter_income_generation)

#Scatter faceted
scatter_faceted_county <- ggplot(processed_data, aes(x = MEDHHINC_2021, y = PLNGENAN, color = PLFUELCT)) +
  geom_point() +
  facet_wrap(~CNTYNAME, scales = "free") +
  labs(title = "Relationship Between Annual Generation, Fuel Type, and Income by County",
       x = "Median Household Income",
       y = "Annual Generation",
       color = "Fuel Type")
print(scatter_faceted_county)

#Barplot Viz
stacked_barplot_total_generation <- ggplot(processed_data, aes(x = CNTYNAME, y = PLNGENAN, fill = PLFUELCT)) +
  geom_bar(stat = "sum", position = "stack") +
  labs(title = "Total Annual Generation by Fuel Type and County",
       x = "County",
       y = "Total Annual Generation",
       fill = "Fuel Type") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
print(stacked_barplot_total_generation)



###########SIMPLE REGRESSIONS ON INC AND GEN/CAP/NUM PLANTS ######

#Income and the number of plants

# Creating separate df with plants by FIPS_Code
county_plants_table <- table(online_plants$FIPS_Code)
view(county_plants_table)
county_plants_df <- as.data.frame(county_plants_table)
#Renaming columnnames
colnames(county_plants_df)[colnames(county_plants_df) == "Var1"] <- "FIPS_Code"
colnames(county_plants_df)[colnames(county_plants_df) == "Freq"] <- "Num_Plants"
#add in income data
merged_data <- merge(county_plants_df, income[, c("FIPS_Code", "MEDHHINC_2021")], by = "FIPS_Code", all.x = TRUE)
# Merge back to original
county_plants_df <- merged_data

#Run regression analysis
inc_plants_model <- lm(Num_Plants ~ MEDHHINC_2021, data = county_plants_df)
summary(inc_plants_model)

#Plot relationship
ggplot(county_plants_df, aes(x = MEDHHINC_2021, y = Num_Plants)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  labs(title = "Regression Analysis Between Power Plants and County Income",
       x = "Median Household Income",
       y = "Number of Power Plants")


#Income and Nameplate Capacity

#Calculate average nameplate capacity by county
average_capacity <- aggregate(NAMEPCAP_plant ~ FIPS_Code, data = online_plants, FUN = mean)

merged_data_capacity <- merge(average_capacity, income, by = "FIPS_Code")

#Generation
capacity_income_model <- lm(NAMEPCAP_plant ~ MEDHHINC_2021, data = merged_data_capacity)

#Plot
ggplot(merged_data_capacity, aes(x = MEDHHINC_2021, y = NAMEPCAP_plant)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  labs(title = "Regression Analysis Between Nameplate Capacity and County Income",
       x = "Median Household Income",
       y = "Average Nameplate Capacity")



#Income and Average Generation

#Calculate average generation by county
avg_generation <- aggregate(PLNGENAN ~ FIPS_Code, data = online_plants, FUN = mean)
merged_data_generation <- merge(avg_generation, income, by = "FIPS_Code")

#Regression
generation_income_model <- lm(PLNGENAN ~ MEDHHINC_2021, data = merged_data_generation)
summary(generation_income_model)

#Plot
ggplot(merged_data_generation, aes(x = MEDHHINC_2021, y = PLNGENAN)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  labs(title = "Regression Analysis Between Average Generation and County Income",
       x = "Median Household Income",
       y = "Total Annual Generation")



```


```{r Heat Maps}
#Create data frame of NC income data
income_NC <-income %>% 
  filter(Stabr=='NC')

#Join the income attributes to the county spatial features
income_NC_sf_join <-  merge(x = counties_sf,
                           y = income_NC, 
                           by.x = 'GEOID', 
                           by.y = 'FIPS_Code')

#Map pct in poverty by county
income_heat_map <-ggplot(data=income_NC_sf_join)+
  geom_sf(aes(fill=PCTPOV017_2021))
income_heat_map

```


---
title: "Examining Socioeconomic and Health-Related Dimensions of Power Plant Impacts in North Carolina"
author: "Gaby Czarniak, Mara Michel, Sam Sedar"
date: "12-13-2023"
output:
  bookdown::html_document2:
    toc: true
    theme: readable
    lof: yes
    lot: yes
  
---
# Research Rationale
The impetus behind this research lies in the intricate interplay between socioeconomic factors and power plants. As the global energy landscape undergoes a transformative shift toward sustainability, it becomes paramount to understand how these changes might impact communities, particularly those situated in lower-income communities. The socio-spatial lens through which this study is conducted aims to unearth patterns of power plant distribution across North Carolina. With 100 counties and a total of 843 power plants consisting of 1190 generators (US EPA, 2021), the state's unique landscape offers a rich context for investigation. The overarching question is whether certain communities bear a disproportionate burden of environmentally impactful energy sources, framing the discourse within the realms of environmental justice and equity.

As a key aspect of this exploration, the research considers the connection between power plant location and emissions and various socioeconomic indicators, including but not limited to unemployment rates. This exploration is motivated by the awareness that power plants have often served as major employers in low-income areas (Union of Concerned Scientists, 2021). This research extends its focus beyond energy sources to examine the broader impacts of power plants on health and social vulnerability, and scrutinizes disparities in pollution exposure and associated health risks at a high level, using publicly available data. Through an exploration that encompasses various socioeconomic indicators, this research contributes to a more nuanced understanding of the multifaceted impacts of power plants.

The following research questions are addressed:  
1. How does income impact power plant characteristics at the county level? \
2. Do power plant retirements have a significant impact on unemployment? \
3. Does publicly available data show a relationship between power generation and social vulnerability, health vulnerability, or environmental burden?  


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,warning = FALSE,message=FALSE)
library(tidyverse)
library(lubridate)
library(here); here()
library(rvest)
library(cowplot)
library(agricolae)
library(dplyr)
library(tidyverse)
library(lubridate)
library(trend)
library(zoo) 
library(Kendall)
library(tseries)
library(sf)
library(leaflet)
library(tseries)
library(knitr)
library(mapview); mapviewOptions(fgb = FALSE)
library(kableExtra) # See References section for source
getwd()
```
# Dataset Information
Data used in this analysis comes from a variety of sources. A brief overview of each source is outlined below and full citations can be found at the end of this report. More information on the metadata for each source can be found in the [Metadata folder](https://github.com/ssedar/CzarniakMichelSedar/tree/main/Data/Metadata) on github.


### Emissions & Generation Resource Integrated Database (eGRID)
The study utilizes the 2020 and 2021 eGRID provided by the U.S. Environmental Protection Agency to acquire essential power plant characteristics. This annually updated database offers comprehensive details on emissions, emission rates, generation, heat input, resource mix, location, and various other indicators. For the specific analyses undertaken in this research, key data elements employed included the plant Federal Information Processing Standards (FIPS) code, generation, nameplate capacity, and emissions by plant.

To process this dataset, the plant and generator sheets undergo individual modifications before being integrated. Notably, columns relevant to the analyses were selected, an additional column was introduced to consolidate state and county FIPS codes into a unified county FIPS code, and the overall dataset was filtered to North Carolina, exclusively. A parallel procedure is executed for the generator sheet before merging the two datasets using the unique ORISPL code.

It is important to highlight that although the most recent eGRID database available was from 2021, this version lacked historical generator retirement data. Consequently, the 2020 eGRID database is incorporated to facilitate the analysis of unemployment trends related to generator retirements.

### Economic Research Service Datasets: Median Household Income
To establish a nexus between power plants and socioeconomic factors, household income data is derived from data compiled by the Economic Research Service of the United States Department of Agriculture. This data includes metrics such as household income and poverty rates at the county level, with identification facilitated by the Federal Information Processing Standards (FIPS) Code. The preparation of this dataset involves the extraction of pertinent columns, specifically median household income, followed by integration with the initial eGRID dataframe. The unifying factor for this integration is the FIPS Code, which served as the common column linking the two datasets.

### Economic Research Service Datasets: Unemployment
As an additional facet of investigation, the analysis incorporates unemployment data obtained from the Economic Research Service of the United States Department of Agriculture. The dataset, spanning the years 2000 through 2021, comprises comprehensive information on the total labor force, the number of employed individuals, the number of unemployed individuals, and the unemployment rate. The data wrangling process for this dataset unfolds in two distinct stages. Initially, the columns of interest, specifically those pertaining to the unemployment rate, are  selected. Following this, the identified columns undergo appropriate conversions to their intended data types before being merged with the existing dataset, utilizing the county FIPS code as the linking identifier.

The subsequent phase of data wrangling introduces additional steps specifically tailored for conducting regression analyses between generator retirements and unemployment rates. To facilitate this analysis, the code executes a transposition of the data. This transformation presents North Carolina county unemployment rates by year in a more streamlined format, allocating a dedicated column for each year. 

### Social Vulnerability Index 
2020 data from the U.S. CDC on key vulnerability criteria including socioeconomic status, household characteristics, racial & ethnic minority status, and house type & transportation. There are four theme variables that contribute to the Overall Vulnerability index value: Socioeconomic Status (RPL_THEME1), Household Characteristics (RPL_THEME2), Racial & Ethnic Minority Status (RPL_THEME3), and Housing Type & Transportation (RPL_THEME4). The variables that contribute to each of these themes are estimated using the American Community Survey (ACS), 2016-2020 (5-year data). U.S. tracts are ranked based on percentiles. Percentile ranking values range from 0 to 1, with higher values indicating greater vulnerability. Percentile ranks are available for the 16 individual variables that feed into the four themes, the four themes, and the overall vulnerability position.

Initially, this data set was chosen because it contains socioeconomic information at the county and tract level that was not available for 2020 in other sources we reviewed. Once we began to explore the dataset, and learned it contained variables we did not previously know were publicly available at this resolution, we chose to continue working with it beyond just the unemployment and income information we were initially seeking, and expanded to consider relationships between the broader set of variables it uses.

### Environmental Justice Index 
2022 report published by the U.S. CDC on environmental burden, social vulnerability, and health vulnerability indicators. This work builds on the Environmental Protection Agency (EPA)'s EJSCREEN. The indicators (social vulnerability, environmental burden, health vulnerability, and the variables that contribute to each of them) were selected based on a literature review conducted between December 2020 and December 2021. The Environmental Justice Index describes itself as "the first national, place-based tool designed to measure the cumulative impacts of environmental burden through the lends of human health and health equity." 

After learning about the Social Vulnerability Index, we continued exploring information available on the CDC's Agency for Toxic Substances and Disease Registry site and, upon finding the EJI, were compelled to explore whether we might test hypotheses we had that generation and emissions from power plants would be correlated with increased environmental burden and health vulnerability within the year of 2021 in North Carolina, specifically. It is crucial to note that the EJI, like any tool produced for the national scale, has limitations baked into the resolution at which it provides information. We believe it is important to highlight from their data documentation, that "injustice occurs locally. High-level tools such as the EJI cannot capture all social, environmental, or health issues that a community may face." Detail on limitations and considerations can be found on page 7 of the EJI data documentation in the [Metadata folder](https://github.com/ssedar/CzarniakMichelSedar/tree/main/Data/Metadata) on github.

### Spatial Data
2020 data from Centers for Disease Control and Prevention/ Agency for Toxic Substances and Disease Registry/ Geospatial Research, Analysis, and Services Program is utilized for visualizations of data at the county level.


Table: Table 1: Dataset Information

Dataset |  Attribute    | Description
----------- |---------------| -------------
eGRID  |  Key Variables | Plant locations, production, capacity, retirements, and emissions
eGRID  |Data Hierarchy | Generators are associated to plants, plants are associated to counties and FIPS codes
eGRID  |Data Range | 2020 (dataset used only to reference historical retirement data) and 2021 (all other data)
eGRID  |Data Source |The United States Environmental Protection Agency
Income  |  Key Variables | Median Household Income, FIPS codes
Income |Data Hierarchy | Income data is associated with FIPS county code
Income |Data Range | 2021
Income |Data Source | The Economic Research Service of the United States Department of Agriculture
Unemployment  |  Key Variables | Unemployment rate, FIPS code
Unemployment    |Data Hierarchy | Unemployment rates are associated with FIPS county code
Unemployment    |Data Range | 2000 to 2021
Unemployment  |Data Source | The Economic Research Service of the United States Department of Agriculture
Social Vulnerability Index  |  Key Variables | Socioeconomic status, household characteristics, racial & ethnic minority status, and house type & transportation
Social Vulnerability Index  |Data Hierarchy | Indicator data is available at the tract level
Social Vulnerability Index  |Data Range | 2020
Social Vulnerability Index  |Data Source | The United States Centers for Disease Control and Prevention/Agency for Toxic Substances and Disease Registry Social Vulnerability Index (CDC/ATSDR SVI)
Environmental Justice Index  |  Key Variables | Environmental burden, social vulnerability, and health vulnerability
Environmental Justice Index  |Data Hierarchy | Indicator data is available at the tract level
Environmental Justice Index  |Data Range | 2020 to 2021
Environmental Justice Index  |Data Source | The United States Agency for Toxic Substances and Disease


```{r, Data_Load, echo=FALSE, warning=FALSE, error= FALSE}

#Loading Data into Raw Data folder

plant <- read.csv(here('Data/Raw/PLNT21.csv'),
                  stringsAsFactors = FALSE, skip = 1, 
                  colClasses = c('FIPSST' = 'character', 
                                 'FIPSCNTY' = 'character',
                                 'ORISPL' = 'character'))

gen <- read.csv(here('Data/Raw/GEN21.csv'), 
                stringsAsFactors = FALSE, skip = 1, 
                  colClasses = c('ORISPL' = 'character'))

gen20 <- read.csv(here('Data/Raw/GEN20.csv'),                 
                  stringsAsFactors = FALSE, skip = 1, 
                  colClasses = c('ORISPL' = 'character'))

income <- read.csv(here('Data/Raw/PovertyEstimates.csv'), 
                  stringsAsFactors = TRUE, skip = 4)

unemployment <- read.csv(here('Data/Raw/Unemployment.csv'), 
                  stringsAsFactors = TRUE, skip = 4)

SVI_county_raw <-read.csv(here('Data/Raw/SVI_NorthCarolina_county.csv'),
                  stringsAsFactors = TRUE)

EJI_countytract <-read.csv(here('Data/Raw/EBM_NorthCarolina.csv'),
                  stringsAsFactors = TRUE)

SVI_2018_tract <-read.csv(here('Data/Raw/SVI2018_NorthCarolina.csv'),
                  stringsAsFactors = TRUE)
```

# Data Wrangling
The initial step in our research, once loaded, was data wrangling on the eGRID, unemployment, and income datasets. Data wrangling, or the process of transforming raw data, was a crucial step in this research, particularly due to the diverse nature of the datasets. For the eGRID dataset, the code selects specific columns related to power plant information in North Carolina, converts certain columns to numeric format, and then combines the generator and plant data based on a common identifier. Duplicate columns are removed, resulting in the plant_gen_data dataframe. The code then proceeds to handle the unemployment dataset, selecting relevant columns covering the years 2002-2022 and merging it with the plant_gen_data dataframe using the FIPS code as a key. Similarly, the income dataset is processed by selecting specific columns, and the final step involves merging this income data with the previously created dataframe. The resulting dataset, named processed_data, contains information on power plants, unemployment rates, and income data, and the column names are displayed at the end of the code. The social vulnerability index and environmental justice datasets are wrangled within the context of Question 3.


```{r Data Wrangling, error=FALSE, warning=FALSE, include=FALSE}
######  DATA WRANGLING - BASELINE  ######

#EGRID DATA

#Selecting columns of interest from plant data
plant_select <- plant %>%
  select(PSTATABB, ORISPL, FIPSST, FIPSCNTY, PLFUELCT, NAMEPCAP,
         PLNGENAN,PLSO2RTA, PLCO2RTA, PLCH4RTA, PLN2ORTA, PLCO2AN, PLN2OAN,PLNOXAN,
         PLSO2AN,PLCH4AN, CNTYNAME, LAT,
         LON, COALFLAG) %>%
  filter(PSTATABB == "NC") %>%
  unite(FIPS_Code, FIPSST, FIPSCNTY, sep = "")

plant_select$PLNGENAN <- as.numeric(plant_select$PLNGENAN)
plant_select$PLCO2RTA <- as.numeric(plant_select$PLCO2RTA)
plant_select$PLCO2AN <- as.numeric(plant_select$PLCO2AN)
plant_select$NAMEPCAP <- as.numeric(plant_select$NAMEPCAP)


#Combining Generator and Plant df based on ORISPL
plant_gen <- gen %>%
  inner_join(plant_select, by = 'ORISPL', 
             suffix = c("_gen", "_plant"))

plant_gen$CFACT <- as.numeric(plant_gen$CFACT)
plant_gen$GENNTOZ <- as.numeric(plant_gen$GENNTOZ)
plant_gen$NAMEPCAP_gen <- as.numeric(plant_gen$NAMEPCAP_gen)
plant_gen$GENNTAN <- as.numeric(plant_gen$GENNTAN)

#Removing duplicate state abbreviation column
plant_gen_data <- plant_gen[, -which(names(plant_gen) == "PSTATABB_plant")]

#Exporting to CSV:
#write.csv(plant_gen_data,'Data/Processed/PLNT_GEN21.csv', row.names=FALSE)

#UNEMPLOYMENT DATA

#Selecting columns of interest: unemployment rates: 2002-2022

ue <- unemployment %>%
  select(FIPS_Code,	Unemployment_rate_2000,	Unemployment_rate_2001,	Unemployment_rate_2002,	Unemployment_rate_2003,	Unemployment_rate_2004,	Unemployment_rate_2005,	Unemployment_rate_2006,	Unemployment_rate_2007,	Unemployment_rate_2008,	Unemployment_rate_2009,	Unemployment_rate_2010,	Unemployment_rate_2011,	Unemployment_rate_2012,	Unemployment_rate_2013,	Unemployment_rate_2014,	Unemployment_rate_2015,	Unemployment_rate_2016,	Unemployment_rate_2017,	Unemployment_rate_2018,	Unemployment_rate_2019,	Unemployment_rate_2020,	Unemployment_rate_2021,	Unemployment_rate_2022)

#Exporting to CSV:
#write.csv(ue,'Data/Processed/Unemployment2000_2022.csv', row.names=FALSE)

#Merging with eGrid
ue_egrid <- merge(plant_gen_data, ue, by = "FIPS_Code")

#Exporting to CSV:
#write.csv(ue_egrid,'Data/Processed/Unemployment2000_2022_eGrid21.csv', row.names=FALSE)

#INCOME DATA

#Selecting columns of interest: 
inc <- income %>%
  select(FIPS_Code, PCTPOVALL_2021, MEDHHINC_2021)

#Exporting to CSV:
#write.csv(inc,'Data/Processed/Income2021.csv', row.names=FALSE)

#Merging
processed_data <- merge(ue_egrid, inc, by = "FIPS_Code")

#Exporting to CSV:
#write.csv(processed_data,'Data/Processed/Income_Unemployment_eGrid.csv', row.names=FALSE)

#Filter by North Carolina
Plant_NC <- plant %>% filter(PSTATABB=='NC')
gen_NC <-gen %>% filter(PSTATABB=='NC')

########## Initial Maps ###########
#Load in counties spatial data
counties_sf<- st_read(here('Data/Spatial/cb_2018_us_county_20m.shp')) %>%
  filter(STATEFP==37)

#Convert eGrid tabular data to spatial data
plant_gen_sf <-plant_gen_data %>% st_as_sf(coords = c('LON','LAT'), crs=4269)


########## Q3 Data Wrangling ##########

#### Attach spatial data to EJI based on census tracts ####

#Establish shared GEOID format
EJI_countytract$CountyFIPS <- stringr::str_extract(EJI_countytract$GEOID, "^.{5}")

#Get 2021 spatial census data to convert tract GEOID to mapped coordinates
spatial_tracts <- tigris::tracts(state = 37) %>% 
  st_as_sf()
class(spatial_tracts)
st_crs(spatial_tracts) # NAD1983, EPSG 4269

#Join the eGrid attributes to the county spatial features
tracts_EJI_sf_join <-  merge(x = spatial_tracts,
                           y = EJI_countytract, 
                           by.x = 'GEOID', 
                           by.y = 'GEOID' )
#Some EJI tracts did not have GEOIDs that matched the spatial tracts

#Select variables of interest
tracts_EJI_sf_select <- tracts_EJI_sf_join %>%
  select(GEOID, CountyFIPS, TRACTCE.x, StateAbbr, COUNTY, E_TOTPOP, M_TOTPOP, 
         RPL_EBM, RPL_HVM, RPL_SVM, E_PM, E_OZONE, E_DSLPM, E_COAL, EP_UNINSUR, 
         EP_AGE65, EP_ASTHMA, EP_BPHIGH, EP_CANCER, EP_MHLTH, geometry) %>%
  rename(TractCode = TRACTCE.x)

#### Power plant data by tract ####

#Check coordinates of plant geometry (point) data
st_crs(plant_gen_sf$geometry) # NAD1983, EPSG 4269

#Match coordinates of plants_NC to tract geometry
plants_within_tracts <- plant_gen_sf[tracts_EJI_sf_select,]
tracts_containing_plants <- tracts_EJI_sf_select[plant_gen_sf,]

#Convert NC eGrid tabular county data to spatial data
plants_NC_sf <- Plant_NC %>% 
  st_as_sf(coords = c('LON','LAT'), crs=4269)

#Table of plant data with the tract that corresponds to each plant
intersection_plants_EJI <- st_intersection(plants_NC_sf, tracts_EJI_sf_select)

#Exporting to CSV:
#write.csv(intersection_plants_EJI,'Data/Processed/EBM_Processed.csv', row.names=FALSE)

#Get tract-level values for generation and emissions
sums_intersection_tractlevel <- intersection_plants_EJI %>%
  group_by(GEOID)%>%
  summarize(Tract_Generation = sum(PLNGENAN),
            Tract_NAMEPCAP = sum(NAMEPCAP),
            Tract_PLNOXAN = sum(PLNOXAN),
            Tract_PLSO2AN = sum(PLSO2AN),
            Tract_PLCH4AN = sum(PLCH4AN),
            Tract_UNNOX = sum(UNNOX),
            Tract_UNSO2 = sum(UNSO2),
            Tract_UNCH4 = sum(UNCH4))

#Add tract-level spatial EJI data back in
sums_intersection_tractlevel <- merge(x = sums_intersection_tractlevel,
                                y = EJI_countytract, 
                                by.x = 'GEOID', 
                                by.y = 'GEOID' ) %>%
    select(GEOID, CountyFIPS, StateAbbr, COUNTY, E_TOTPOP, M_TOTPOP, 
          Tract_Generation, Tract_NAMEPCAP, Tract_PLNOXAN, Tract_PLSO2AN,
          Tract_PLCH4AN, Tract_UNNOX, Tract_UNSO2, Tract_UNCH4, RPL_EBM, 
          RPL_HVM, RPL_SVM, E_PM, E_OZONE, E_DSLPM, E_COAL, EP_UNINSUR, 
          EP_AGE65, EP_ASTHMA, EP_BPHIGH, EP_CANCER, EP_MHLTH, geometry)

# eGRID emissions data had many NAs
# Removing NAs for multivariate regression analyses
nona_sums_intersection_tract <- drop_na(sums_intersection_tractlevel)
```

# Exploratory Analysis
This analysis initiates data exploration and visualization for the processed_data dataframe, focusing on fuel types, income, and electricity generation in North Carolina. Figure 1 generates a pie chart to illustrate the percentage makeup of primary fuel types in North Carolina based on total annual generation. Subsequently, the scatter plot in Figure 2 depicts the relationship between median household income and total plant annual generation, with points colored by fuel type. The exploratory analysis further drills down to scatter plots excluding nuclear data and for a selected set of fuel types (COAL, SOLAR, OIL, WIND, GAS). Additionally, stacked bar plots in Figures 5 and 6  visualize the total annual generation by fuel type and county, and for better clarity, separate plots are created for the top 10 and bottom 10 counties based on median household income. These visualizations help explore and understand the relationships between fuel types, income levels, and electricity generation in different counties of North Carolina.

##### Figure 1: Pie chart illustrating the percentage distribution of primary fuel types in North Carolina based on total annual generation. {-}

```{r, Exploration, echo=FALSE, warning=FALSE, error=FALSE}

########### DATA EXPLORATION - FUEL TYPES ###########

#NC Breakdown of Fuel by Category
fuel_summarized <- processed_data %>%
  group_by(PLFUELCT) %>%
  summarise(total_generation = sum(PLNGENAN, na.rm = TRUE))

#In percentages
fuel_summarized$percentage <- fuel_summarized$total_generation / sum(fuel_summarized$total_generation) * 100

#Pie chart with percent makeup of fuel in  NC
pie_chart_percentage <- ggplot(fuel_summarized, aes(x = "", fill = PLFUELCT, y = percentage)) +
  geom_bar(width = 1, stat = "identity") +
  coord_polar(theta = "y") +
  labs(
    title = "North Carolina Primary Fuel (% of Total Annual Generation)",
    fill = "Primary Fuel Type",
    y = "Percentage of Total Generation (%)",
    x = NULL)
print(pie_chart_percentage)
```

##### Figure 2: Scatter plot illustrating the correlation between median household income and total annual generation, color-coded by fuel type. Owing to the unique characteristics of nuclear power plants, operating at significantly higher capacity factors than other sources, the plot lacks a discernible relationship, prompting necessary adjustments. {-}

```{r, income_type, echo=FALSE, warning=FALSE, error=FALSE}
#Relationship between income and fuel type
processed_data$MEDHHINC_2021 <- as.numeric(processed_data$MEDHHINC_2021)

#Scatter visualization
scatter_income_generation <- ggplot(processed_data, aes(x = MEDHHINC_2021, y = PLNGENAN, color = PLFUELCT)) +
  geom_point() +
  labs(title = "Income and Annual Generation by Fuel Type",
       x = "Median Household Income ($)",
       y = "Total Plant Annual Generation (MWh)",
       color = "Fuel Type",
caption = "")
print(scatter_income_generation)
```

##### Figure 3: Exploring energy patterns, this scatter plot analyzes the connection between median household income and total annual generation, excluding nuclear energy. The updated chart reveals a potential trend, especially around the $70,000 median income mark, where data points for generation are sparse.{-}

```{r, ex_nuclear, echo=FALSE, warning=FALSE, error=FALSE}
#Scatter ex-nuclear
scatter_income_generation_ex_nuc <- ggplot(subset(processed_data, PLFUELCT != "NUCLEAR"), 
                                     aes(x = MEDHHINC_2021, y = PLNGENAN, color = PLFUELCT)) +
  geom_point() +
  labs(title = "Relationship Between Annual Generation, Fuel Type, and Income",
       x = "Median Household Income ($)",
       y = "Total Plant Annual Generation (MWh)",
       color = "Fuel Type")
print(scatter_income_generation_ex_nuc)

```

##### Figure 4: To narrow our exploration further, we selected key energy sources: coal, gas, oil, wind, and solar.{-}

```{r, select, echo=FALSE, warning=FALSE, error=FALSE}

selected_fuel_data <- subset(processed_data, PLFUELCT %in% c("COAL", "SOLAR", "OIL", "WIND", "GAS"))

# Scatter plot for selected fuel types
scatter_income_generation_selected <- ggplot(selected_fuel_data, 
                                              aes(x = MEDHHINC_2021, y = PLNGENAN, color = PLFUELCT)) +
  geom_point() +
  labs(title = "Relationship Between Annual Generation, Fuel Type, and Income",
       x = "Median Household Income ($)",
       y = "Total Plant Annual Generation (MWh)",
       color = "Fuel Type")
print(scatter_income_generation_selected)

```

##### Figure 5: Stacked bar plot illustrating the total annual generation by fuel type in the top 10 counties (by median income) in North Carolina.{-}

```{r, top10, echo=FALSE, warning=FALSE, error=FALSE}
#Top 10 counties based on median household income
top_income_counties <- processed_data %>%
  group_by(CNTYNAME) %>%
  summarize(median_income = median(MEDHHINC_2021, na.rm = TRUE)) %>%
  top_n(10, median_income) %>%
  pull(CNTYNAME)

filtered_data_income <- processed_data %>%
  filter(CNTYNAME %in% top_income_counties)

#Stacked bar plot
stacked_barplot_top_income_counties <- ggplot(filtered_data_income, aes(x = CNTYNAME, y = PLNGENAN, fill = PLFUELCT)) +
  geom_bar(stat = "sum", position = "stack") +
  labs(title = "Total Annual Generation by Fuel Type and County \n (Top 10 by Median Income)",
       x = "County",
       y = "Total Plant Annual Generation (MWh)",
       fill = "Fuel Type") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
print(stacked_barplot_top_income_counties)
```

##### Figure 6: To get a balanced view of the total annual generation by fuel type and county, we then show the bottom 10 counties (by median income) in North Carolina. This identified Richmond county as a county of interest.{-}

```{r, bottom10, echo=FALSE, warning=FALSE, error=FALSE}
#Bottom 10 counties based on median household income
bottom_income_counties <- processed_data %>%
  group_by(CNTYNAME) %>%
  summarize(median_income = median(MEDHHINC_2021, na.rm = TRUE)) %>%
  arrange(median_income) %>%
  slice_head(n = 10) %>%
  pull(CNTYNAME)

filtered_data_bottom_income <- processed_data %>%
  filter(CNTYNAME %in% bottom_income_counties)

#Stacked bar plot
stacked_barplot_bottom_income_counties <- ggplot(filtered_data_bottom_income, aes(x = CNTYNAME, y = PLNGENAN, fill = PLFUELCT)) +
  geom_bar(stat = "sum", position = "stack") +
  labs(title = "Total Annual Generation by Fuel Type and County \n (Bottom 10 by Median Income)",
       x = "County",
       y = "Total Plant Annual Generation (MWh)",
       fill = "Fuel Type") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
print(stacked_barplot_bottom_income_counties)
```

We then created initial maps to better understand the landscape of North Carolina in terms of socioeconomic status and geographic distribution of power plants. Figure 7 below shows the mapping of power plants across the state and helped us to visualize the concentration of power plants across the state. Figure 8 maps the nameplate capacity of those power plants by county. We noticed that multiple counties, especially Richmond county, stood out as having a high concentration of capacity. Figure 9 demonstrates a heat map of the percentage of each county's population living in poverty as of 2021. Richmond county is once again a clear visual outlier on this map.

##### Figure 7: Locations of active power plants across North Carolina as of 2021. Each black dot represents a power plant.{-}

```{r Initial Maps - Power plant locations}
#Create initial map of power plants
gens_counties_map <-ggplot()+
  geom_sf(data=counties_sf)+
  geom_sf(data=plant_gen_sf,size=0.8)+
  labs(title = "Locations of NC Power Plants")+
  theme(plot.margin=unit(c(-0.50,0,0,0), "null"))
print(gens_counties_map)
```

##### Figure 8: This map shows the total nameplate capacity in Megawatts of each county in North Carolina. Multiple counties have no power plants and are blank. Richmond County is an interesting outlier which the highest capacity of all the counties.{-}
```{r Initial Maps - Nameplate capacity}

#Compute sum of nameplate capacity by county
nameplate_capacity <-plant_gen_data %>%
  group_by(CNTYNAME)%>%
  summarize(Sum_NAMEPCAP = sum(NAMEPCAP_plant))
#Join the eGrid attributes to the county spatial features
counties_sf_join <-  merge(x = counties_sf,
                           y = plant_gen_data, 
                           by.x = 'NAME', 
                           by.y = 'CNTYNAME' )
#Map total generator capacity by county
gen_cap_map <-ggplot(data=counties_sf_join)+
  geom_sf(aes(fill=NAMEPCAP_plant))+
  labs(title="Capacity by County",fill="Capacity (MW)")+
  theme(plot.margin=unit(c(-0.50,0,0,0), "null"))
print(gen_cap_map)
```

##### Figure 9: Percent of total county population living in poverty in 2021, as defined by the USDA Economic Research Service.{-}
```{r Initial Maps - Income by county}
## Heat map of Income Data by County ##
#Create data frame of NC income data
income_NC <-income %>% 
  filter(Stabr=='NC')
#Join the income attributes to the county spatial features
income_NC_sf_join <-  merge(x = counties_sf,
                           y = income_NC, 
                           by.x = 'GEOID', 
                           by.y = 'FIPS_Code')
#Map pct in poverty by county
income_heat_map <-ggplot(data=income_NC_sf_join)+
  geom_sf(aes(fill=PCTPOV017_2021))+
  labs(title= "% of County in Poverty - 2021", fill="%")+
  theme(plot.margin=unit(c(-0.50,0,0,0), "null"))
print (income_heat_map)
```

Additionally, we explored power plant emissions geographically as a final stage of our exploratory analysis. Figures 10-13 demonstrate the aggregated power plant emissions per county in 2021 for CO2, NOx, SO2, and CH4 respectively. Unfortunately eGrid did not provide data for Mercury (Hg) in 2021 so that was not analyzed. CH4 is provided in lbs while CO2, NOx, and SO2 are in short tons. For CO2 emissions, Richmond county stood out. For NOx emissions, Catawba county stood out. For SO2 emissions, Catawba, Haywood, and Person counties stood out. For CH4 emissions, Catawba and Person counties stood out.

##### Figure 10: Total CO2 Emissions in 2021 across North Carolina Power Plants.{-}
```{r Power Plant Emissions Heat Maps}
#Heat map of CO2 emissions by county
#Compute sum of CO2 Emissions by county
CO2_emissions <-plant_gen_data %>%
  drop_na(PLCO2AN)%>%
  group_by(CNTYNAME)%>%
  summarize(Sum_CO2 = sum(PLCO2AN))
#Join the eGrid attributes to the county spatial features
CO2_counties_sf_join <-  merge(x = counties_sf,
                           y = CO2_emissions, 
                           by.x = 'NAME', 
                           by.y = 'CNTYNAME')
#Map CO2 emissions by county
CO2_map <-ggplot(data=CO2_counties_sf_join)+geom_sf(data=counties_sf)+
  geom_sf(aes(fill=Sum_CO2))+
  labs(title="2021 CO2 Emissions",
       fill="CO2 Emissions (tn)")+
  theme(plot.margin=unit(c(-0.50,0,0,0), "null"))
print(CO2_map)
```

##### Figure 11: Total NOx Emissions in 2021 across North Carolina Power Plants.{-}

```{r, NOX Emissions}
#Heat map of NOx emissions by county
#Compute sum of NOx Emissions by county
NOx_emissions <-plant_gen_data %>%
  drop_na(PLNOXAN)%>%
  group_by(CNTYNAME)%>%
  summarize(Sum_NOx = sum(PLNOXAN))
#Join the eGrid attributes to the county spatial features
NOx_counties_sf_join <-  merge(x = counties_sf,
                           y = NOx_emissions, 
                           by.x = 'NAME', 
                           by.y = 'CNTYNAME')

#Map NOx emissions by county
NOx_map <-ggplot(data= NOx_counties_sf_join)+
  geom_sf(data=counties_sf)+
  geom_sf(aes(fill=Sum_NOx))+
  labs(title="2021 NOx Emissions",
       fill=" NOx Emissions (tn)")+
  theme(plot.margin=unit(c(-0.50,0,0,0), "null"))
print(NOx_map)
```

##### Figure 12: Total SO2 Emissions in 2021 across North Carolina Power Plants.{-}

```{r, SO2 Emissions}
#Heat map of SO2 emissions by county
#Compute sum of SO2 Emissions by county
SO2_emissions <-plant_gen_data %>%
  drop_na(PLSO2AN)%>%
  group_by(CNTYNAME)%>%
  summarize(Sum_SO2 = sum(PLSO2AN))
#Join the eGrid attributes to the county spatial features
SO2_counties_sf_join <-  merge(x = counties_sf,
                           y = SO2_emissions, 
                           by.x = 'NAME', 
                           by.y = 'CNTYNAME')
#Map SO2 emissions by county
SO2_map <-ggplot(data=SO2_counties_sf_join)+
  geom_sf(data=counties_sf)+
  geom_sf(aes(fill=Sum_SO2))+
  labs(title="2021 SO2 Emissions",
       fill="SO2 Emissions (tn)")+
  theme(plot.margin=unit(c(-0.50,0,0,0), "null"))
print(SO2_map)
```



```{r include=FALSE}
##### Figure 13: Total N20 Emissions in 2021 across North Carolina Power Plants.{-}
#Heat map of N2O emissions by county
#Compute sum of N2O Emissions by county
N2O_emissions <-plant_gen_data %>%
  drop_na(PLN2OAN)%>%
  group_by(CNTYNAME)%>%
  summarize(Sum_N2O = sum(PLN2OAN))
#Join the eGrid attributes to the county spatial features
N2O_counties_sf_join <- merge(x = counties_sf,
                           y = N2O_emissions, 
                           by.x = 'NAME', 
                           by.y = 'CNTYNAME')
#Map N2O emissions by county
N2O_map <-ggplot(data= N2O_counties_sf_join)+
  geom_sf(data=counties_sf)+
  geom_sf(aes(fill=Sum_N2O))+
  labs(title="2021 N2O Emissions",
       fill=" N2O Emissions (lbs)")+
  theme(plot.margin=unit(c(-0.50,0,0,0), "null"))
print(N2O_map)
```

##### Figure 13: Total CH4 Emissions in 2021 across North Carolina Power Plants.{-}

```{r, CH4 Emissions}
#Heat map of CH4 emissions by county
#Compute sum of CH4 Emissions by county
CH4_emissions <-plant_gen_data %>%
  drop_na(PLCH4AN)%>%
  group_by(CNTYNAME)%>%
  summarize(Sum_CH4 = sum(PLCH4AN))
#Join the eGrid attributes to the county spatial features
CH4_counties_sf_join <- merge(x = counties_sf,
                           y = CH4_emissions, 
                           by.x = 'NAME', 
                           by.y = 'CNTYNAME')
#Map CH4 emissions by county
CH4_map <-ggplot(data= CH4_counties_sf_join)+
  geom_sf(data=counties_sf)+
  geom_sf(aes(fill=Sum_CH4))+
  labs(title="2021 CH4 Emissions",
       fill="CH4 Emissions (lbs)")+
  theme(plot.margin=unit(c(-0.50,0,0,0), "null"))
print(CH4_map)
```

As exploratory work into the dimensions of social vulnerability, environmental burden, and health vulnerability in relation to generation and emissions across power plants in North Carolina, tests for normality were conducted on the overall index value for each of the aggregated themes (SVI, EBM, HVM). The distribution of the variables corresponding to these three overall themes of interest can be seen in Figures 14-16.

##### Figure 14: Test for normality in distribution of Social Vulnerability Module percentile ranks. Normal Q-Q Plot does not show a totally normal distribution. Distribution is skewed such that most observations fall in the second half.{-}

```{r Distribution of SVM, echo=FALSE}
#Check normal distributions of continuous variables
par(mfrow = c(1,2), mar=c(6,4,6,4))
qqnorm(nona_sums_intersection_tract$RPL_SVM, col = "navy"); qqline(nona_sums_intersection_tract$RPL_SVM)
hist(nona_sums_intersection_tract$RPL_SVM, 
     main = "Social Vulnerability \n Histogram",
     xlab = "Percentile Rank Value",
     col = "azure1",
     border = "navy")
par(mfrow = c(2,2))
#The data for the percentile ranking on overall social vulnerability does not follow a normal distribution.
```

##### Figure 15: Test for normality in distribution of Environmental Burden Module percentile ranks. Normal Q-Q Plot does not show a totally normal distribution. Distribution is skewed such that most observations fall in the second half.{-}

```{r Distribution of EBM, echo=FALSE}
#Check normal distributions of continuous variables
par(mfrow = c(1,2), mar=c(6,4,6,4))
qqnorm(nona_sums_intersection_tract$RPL_EBM, col = "darkorchid4"); qqline(nona_sums_intersection_tract$RPL_EBM)
hist(nona_sums_intersection_tract$RPL_EBM, 
     main = "Environmental Burden \nHistogram",
     xlab = "Percentile Rank Value",
     col = "lavender",
     border = "darkorchid4")
par(mfrow = c(2,2))
# hist(nona_sums_intersection_tract$RPL_EBM)
#The data for the percentile ranking on environmental burden does not follow a normal distribution.
```

##### Figure 16: Test for normality in distribution of Environmental Burden Module percentile ranks. Distribution is shows that HVM (as Percentile Rank) is ordered but not continuous, the way EBM is. EJI obtains its data on indicators from a variety of sources. RPL_HVM, specifically, can take a value of 0, 0.2, 0.4, 0.6, 0.8, or 1.0.{-}

```{r Distribution of HVM, echo=FALSE}
#Check normal distributions of continuous variables
par(mfrow = c(1,2), mar=c(6,4,6,4))
qqnorm(nona_sums_intersection_tract$RPL_HVM, col = "salmon3"); qqline(nona_sums_intersection_tract$RPL_HVM)
hist(sums_intersection_tractlevel$RPL_HVM, 
     main = "Health Vulnerability \nHistogram",
     xlab = "Percentile Rank Value",
     col = "wheat1",
     border = "salmon3")
par(mfrow = c(2,2))
# 47 entries at 0.0
# 30 entries at 0.2
# 41 at 0.4
# 45 at 0.6
# 119 at 0.8
# 28 at 1.0
# hist(nona_sums_intersection_tract$RPL_HVM)
#The data for the percentile ranking on health vulnerability does not follow a normal distribution and it is clear that the variable is not continuous, so further tests must be run. 

```

As the last set of geographic explorations, three maps were created. The first was a map of NC power plants overlaid on tract boundaries to ensure that the matching of tracts to power plants for based on spatial features for Q3 analyses was successful (see Figure 17). The second highlights tracts that contain power plants--one level deeper than county resolution, for comparison (see Figure 18). The third maps asthma prevalence across NC tracts, as a visual grounding point in relation to Q3 analyses, given that the emissions considered in this project are known to have respiratory effects in humans (see Figure 19).

##### Figure 17: Power Plants Within Tract Boundaries{-}
```{r Map of Power Plants and Tract Boundaries, echo=FALSE}
#Map of plants across NC tracts, shown over NC tract boundaries 

```

##### Figure 18: Tracts that Contain Power Plants{-}
```{r Map of Tracts Containing Plants, echo=FALSE}
#Map of just NC tracts that contain power plants


```

##### Figure 19: Mapping Asthma Prevalence Across Tracts{-}
```{r Map of Asthma Prevalence Tract Boundaries, echo=FALSE}
#Map asthma prevalence by tract

```

#   Question 1: How does income impact power plant characteristics at the county level?

### Null Hypothesis: The economic status of a community does not bear a statistically significant impact on the features of its power infrastructure.

This analysis begins by examining the impact that income has on various power plant characteristics. This first analysis uses income as the highest-level socioeconomic indicator, as income often dictates an array of follow-on indicators. Several regressions are conducted including the impact of income on the fuel type (differentiating between clean and dirty sources), number of plants, and nameplate capacity. 

Examining only the impact of income on coal plants, the estimated coefficient is approximately -134.6. This suggests that for each one-unit increase in income, the predicted value of coal generation decreases by approximately 134.6 MWh. The coefficient's p-value (0.1049) is greater than 0.05, indicating that it is not statistically significant at the 0.05 significance level. Furthermore, the R^2 suggests that only about 13.24% of the variability in coal generation is explained by income. Figure 20 below visualizes this relationship.

---

```{r IncomeAndFuel,echo=FALSE,warning=FALSE,error=FALSE}

########### DATA ANALYSIS - INCOME AND FUEL TYPE ###########

#Coal linear regression
coal_data <- subset(processed_data, PLFUELCT == "COAL")
linear_model_coal <- lm(PLNGENAN ~ MEDHHINC_2021, data = coal_data)

summary_table <- summary(linear_model_coal)$coef[-1, ]

knitr::kable(summary_table, format = "html", caption = "Linear Regression Results - Median Income Impact on Coal Generation")


```

---

##### Figure 20: Relationship of median household income ($) on coal generation (MWh) in 2021 by county.{-}

```{r warning=TRUE}
#Visualize relationship
scatter_coal <- ggplot(coal_data, aes(x = MEDHHINC_2021, y = PLNGENAN)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, color = "blue") +
  labs(title = "County Income and Coal Generation",
       x = "Median Household Income ($)",
       y = "Coal Generation (MWh)")
print(scatter_coal)
```

The linear regression shown in Figure 21 below suggests that there might be a relationship between income and solar generation. The statistically significant p-value (0.04707) indicates that there is evidence to suggest that an increase in median household income is associated with a decrease in the predicted value of solar generation However, it's important to note that the explained variance is quite low (about 0.56%), and so other factors not included in the model likely contribute to the variability in generation for solar.

---

```{r Solar,echo=FALSE,error=FALSE,warning=FALSE}

#Solar linear regression
solar_data <- subset(processed_data, PLFUELCT == "SOLAR")
linear_model_solar <- lm(PLNGENAN ~ MEDHHINC_2021, data = solar_data)

summary_table_solar <- summary(linear_model_solar)$coef[-1, ]

knitr::kable(summary_table_solar, format = "html", caption = "Linear Regression Results - Median Income Impact on Solar Generation")

```

---

##### Figure 21: Relationship of median household income ($) on solar generation (MWh) in 2021 by county.{-}

```{r, Solar plot, echo = FALSE}
#Visualize relationship
scatter_solar <- ggplot(solar_data, aes(x = MEDHHINC_2021, y = PLNGENAN)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, color = "blue") +
  labs(title = "County Income and Solar Generation",
       x = "Median Household Income ($)",
       y = "Solar Generation (MWh)")
print(scatter_solar)
```

The next stage of analysis examined if there was a relationship between the quantity of generators and median household income. The linear regression results indicate that median household income does not show a statistically significant association with the number of plants. The coefficient is estimated to be -0.0000786, with a standard error of 0.0000922, a t-value of -0.85, and a p-value of 0.3962. This suggests that, based on the available data, changes in median household income do not appear to be statistically linked to variations in the number of plants. Figure 22 below illustrates this relationship.

---

```{r VisualizationforSolar,echo=FALSE,warning=FALSE,error=FALSE}

################ DATA ANALYSIS: INCOME AND POWER PLANTS ####################

#Regression on Income and the Number of Power Plants

### Pre-Analysis Wrangling ###
online_plants <- processed_data %>%
  drop_na(GENYRONL) %>%
  select(FIPS_Code, CNTYNAME, SEQGEN, YEAR, PNAME, 
         GENID, GENSTAT, GENYRONL, NAMEPCAP_plant, 
         PLNGENAN, PLCO2AN, COALFLAG, MEDHHINC_2021,	
         Unemployment_rate_2000,	Unemployment_rate_2001,	
         Unemployment_rate_2002,	Unemployment_rate_2003,	
         Unemployment_rate_2004,	Unemployment_rate_2005,	
         Unemployment_rate_2006,	Unemployment_rate_2007,	
         Unemployment_rate_2008,	Unemployment_rate_2009,	
         Unemployment_rate_2010,	Unemployment_rate_2011,	
         Unemployment_rate_2012,	Unemployment_rate_2013,	
         Unemployment_rate_2014,	Unemployment_rate_2015,	
         Unemployment_rate_2016,	Unemployment_rate_2017,	
         Unemployment_rate_2018,	Unemployment_rate_2019,	
         Unemployment_rate_2020,	Unemployment_rate_2021,	
         Unemployment_rate_2022)

# Creating separate df with plants by FIPS_Code
county_plants_table <- table(online_plants$FIPS_Code)
view(county_plants_table)
county_plants_df <- as.data.frame(county_plants_table)

#Renaming columnnames
colnames(county_plants_df)[colnames(county_plants_df) == "Var1"] <- "FIPS_Code"
colnames(county_plants_df)[colnames(county_plants_df) == "Freq"] <- "Num_Plants"
#add in income data
merged_data <- merge(county_plants_df, income[, c("FIPS_Code", "MEDHHINC_2021")], by = "FIPS_Code", all.x = TRUE)
# Merge back to original
county_plants_df <- merged_data

### Regression Analysis ###

#Run simple regression
inc_plants_model <- lm(Num_Plants ~ MEDHHINC_2021, data = county_plants_df)

summary_table_plants <- summary(inc_plants_model)$coef[-1, ]

knitr::kable(summary_table_plants, format = "html", caption = "Linear Regression Results - Median Income Impact on Number of plants")

```

---

##### Figure 22: Relationship of Median Household Income and Number of Power Plants in NC in 2021 by county.{-}

```{r, power plants number}
#Plot relationship
ggplot(county_plants_df, aes(x = MEDHHINC_2021, y = Num_Plants)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  labs(title = "County Income and Number of Power Plants",
       x = "Median Household Income($)",
       y = "Number of Power Plants")
```


As a last step toward answering Question 1, an analysis was conducted on whether the average nameplate capacity of plants in a county is related to median household income across the data set in use, given that power plants differ in size. The linear regression on this relationship yields a coefficient of 0.0019239, accompanied by a standard error of 0.0023465. This implies that, theoretically, an increase in median household income is associated with a slight corresponding increase in Nameplate Capacity. However, the non-significant p-value of 0.4145 means we do not have sufficient evidence to reject the null hypothesis and the observed association between median household income and Nameplate Capacity may be coincidental. Figure 23 below demonstrates this relationship.

---

```{r, npcap, echo=FALSE, warning=FALSE, error=FALSE}
#Regression on Income and Nameplate Capacity

## Pre-Analysis Wrangling ##

#Calculate average nameplate capacity by county
average_capacity <- aggregate(NAMEPCAP_plant ~ FIPS_Code, data = online_plants, FUN = mean)
merged_data_capacity <- merge(average_capacity, income, by = "FIPS_Code")

## Regression Analysis ##

#Run simple regression
capacity_income_model <- lm(NAMEPCAP_plant ~ MEDHHINC_2021, data = merged_data_capacity)

summary_table_cap <- summary(capacity_income_model)$coef[-1, ]

knitr::kable(summary_table_cap, format = "html", caption = "Linear Regression Results - Median Income Impact on Nameplate Capacity")
```

---

##### Figure 23: Relationship of Median Household Income on Average Nameplate Capacity (MW) by county in 2021.{-}

```{r,nameplate capacity}

#Plot relationship
ggplot(merged_data_capacity, aes(x = MEDHHINC_2021, y = NAMEPCAP_plant)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  labs(title = "County Income and Nameplate",
       x = "Median Household Income($)",
       y = "Average Nameplate Capacity (MW)")

```

```{r Creating income groupings, echo=FALSE}

# GENYRRET = Generator planned or actual retirement year (four-digit)
# GENYRONL - year the generator came online (four-digit)

retired_year <- processed_data$GENYRRET %>%
  na.omit()
# earliest year of plant retirement was 2021
# can't run time series analysis with this data, 
# but could run regression analysis to understand relationship between
# planned retirement and 2021 avg household income or
# 2021 retirement and 2021 unemployment

online_plants <- processed_data %>%
  # drop observations with NAs in GENYRONL
  # which means we don't know what year they came online
  # new number of observations should be 1175 (dropping 15 NAs)
  drop_na(GENYRONL) %>%
  select(FIPS_Code, CNTYNAME, SEQGEN, YEAR, PNAME, 
         GENID, GENSTAT, GENYRONL, NAMEPCAP_plant, 
         PLNGENAN, PLCO2AN, COALFLAG, MEDHHINC_2021,	
         Unemployment_rate_2000,	Unemployment_rate_2001,	
         Unemployment_rate_2002,	Unemployment_rate_2003,	
         Unemployment_rate_2004,	Unemployment_rate_2005,	
         Unemployment_rate_2006,	Unemployment_rate_2007,	
         Unemployment_rate_2008,	Unemployment_rate_2009,	
         Unemployment_rate_2010,	Unemployment_rate_2011,	
         Unemployment_rate_2012,	Unemployment_rate_2013,	
         Unemployment_rate_2014,	Unemployment_rate_2015,	
         Unemployment_rate_2016,	Unemployment_rate_2017,	
         Unemployment_rate_2018,	Unemployment_rate_2019,	
         Unemployment_rate_2020,	Unemployment_rate_2021,	
         Unemployment_rate_2022)

online_year <- online_plants$GENYRONL

online_month_day_ <- rep(c("01-01-"), length(online_year))

# repeating month_day_ to fill in month and day
# for as many year entries as are found in 
# dropping NAs but may need to keep them in; decide as group
Date_Online <- paste0(online_month_day_,online_year)
# 1175 observations in Date_Online

# change years to date formats
Date_Online <- as.Date(Date_Online, format = "%m-%d-%Y")

# ensure date column is in date format
online_plants <- online_plants %>%
  mutate(GENYRONL = Date_Online)

# identifying the county with the most power plants
county_freq_table <- table(online_plants$CNTYNAME)
# view(county_freq_table)
#max(county_freq_table) # 48, Robeson County
county_freq_table <- sort(county_freq_table, decreasing = TRUE)
# view(county_freq_table)
robeson_online_plants <- online_plants %>%
  filter(CNTYNAME == "Robeson")
# unique(robeson_online_plants$PNAME) # 44 unique power plant names
# unique(robeson_online_plants$GENID) # 32 unique GENIDs

# multiple regression for just one county, Robeson 
# the one with highest total number of existing plants in 2021
# to understand relationship between year online for each power plant and unemployment 
# need to make table by year
# with 5 columns: Year, FIPS code, number of plants in existence that year, unemployment rate
robeson_year <- year(robeson_online_plants$GENYRONL)
robeson_FIPS_code <- robeson_online_plants$FIPS_Code
## MARKING WHERE GC LEFT OFF
#robeson_plant_count <- tally(robeson_online_plants$PNAME, wt = NULL, sort = FALSE, name = NULL)
#is.Date(robeson_online_plants$GENYRONL)

```

## Summary
This study's initial inquiry sought to uncover how income, a significant socioeconomic indicator, relates to power plant characteristics. The investigation focused on the fuel type, the number, and the total nameplate capacity of power plants, each representing distinct dimensions of interest. Although the study did not produce definitive and statistically significant results regarding the influence of income on the number of power plants or nameplate capacity, it is suggested that this may be due to the complexity of the energy landscape. While one might expect lower generation capacity and fewer power plants in wealthier areas due to potential opposition, it is crucial to consider that energy consumption is often linked to a higher standard of living. Consequently, having generation capacity in higher-income areas may be necessary to meet the increased demand. Although this aspect of the exploration did not yield statistically significant results, it is noteworthy that the type of fuel generation, specifically solar, displayed some significance. The analysis indicated that an increase in median household income is associated with a decrease in solar generation. However, it is important to recognize that, despite being statistically significant, the coefficient of determination (r2) suggests that the explained variance is quite modest, standing at only 0.56%.

#   Question 2: Do power plant retirements have a significant impact on unemployment?

### Null Hypothesis: The retirement of power plant generators does not have an impact on unemployment rates in the counties in which they are located.

The primary motivation behind this analysis is to delve into the nuanced equilibrium inherent in a just energy transition. The imperative of shifting energy fuel sources from carbon-intensive to fossil fuel-free must be achieved without detriment to communities. In this examination, we initially pinpoint counties in North Carolina with the highest and lowest numbers of retirements, comparing them to their respective unemployment rates over time. To conduct a more pointed analysis, a statistical examination is performed on a specific county of interest.

Power plant retirements were analyzed (using data contained in the 2020 eGRID dataset) to identify which counties had the most number of retired power plants. The full selection of power plants with historical retirements can be seen in Figure 24. Counties with no retirements were also subsequently selected to provide a comparison. 

##### Figure 24: Number of historical power plant retirements per county based on 2020 eGRID dataset{-}
```{r, Unemployment_Retirements, echo=FALSE, warning=FALSE, error=FALSE}

################ DATA ANALYSIS: UNEMPLOYMENT AND GENERATOR RETIREMENTS ################ 

### Pre-Analysis Wrangling ###

#Set to numeric
gen20$NAMEPCAP <- as.numeric(gen20$NAMEPCAP)
gen20$GENNTOZ <- as.numeric(gen20$GENNTOZ)


#Combining gen20 and plant dataframes based on ORISPL
plant_gen20 <- gen20 %>%
  inner_join(plant_select, by = 'ORISPL', 
             suffix = c("_gen", "_plant"))

#Removing duplicate state abbreviation column
plant_gen_data_20 <- plant_gen20[, -which(names(plant_gen) == "PSTATABB_plant")]

#Merging with eGrid
ue_egrid_20 <- merge(plant_gen_data_20, ue, by = "FIPS_Code")

#Merging with income
processed_data_20 <- merge(ue_egrid_20, inc, by = "FIPS_Code")


#Transposing and wrangling both in order to view:
#   1. NC county unemployment by year, where we have a column for all years rather than each year having its own column
#   2. Generator retirement by year, selecting only those with instances of retired generators

#Unemployment
transposed_ue <- ue %>%
  filter(str_starts(FIPS_Code, "37")) %>%  # Filter to include only NC
  pivot_longer(cols = starts_with("Unemployment_rate_"), 
               names_to = "Year", 
               values_to = "Unemployment") %>%
  mutate(Year = gsub("Unemployment_rate_", "", Year, fixed = TRUE)) %>%
  pivot_wider(names_from = "FIPS_Code", values_from = "Unemployment")

#Generator
generator_retirement_data <- processed_data_20 %>% 
  select(FIPS_Code, GENYRRET) %>%
  na.omit()  #showing only generators that have retired


###### EXPLORATION #######

#Use table to count the occurrences of each unique FIPS code to select counties of interest
fips_counts <- table(generator_retirement_data$FIPS_Code)

for (i in seq_along(fips_counts)) {
  fips <- names(fips_counts)[i]
  count <- fips_counts[i]
  cat("FIPS Code:", fips, "has", count, "rows.\n")}

fips_counts <- table(generator_retirement_data$FIPS_Code)#identifies 2 counties with 7 instances of retirements

```

Based on the dataset above, FIPS Code 37159 (Rowan) and 37191 (Wayne) each have the highest number of retirements at 7 rows. FIPS Code 37023  (Burke) 37041 (Chowan) 37049  (Craven) 37063 (Durham) 37067 (Forsyth) 37069 (Franklin) 37125 (Moore) each have 1 row.

In this analysis, counties experiencing both high (blue) and low (green) numbers of generator retirements, such as Rowan and Wayne (high retirements) and Burke and Craven (low retirements), are singled out. The objective is to investigate whether fluctuations in unemployment rates are influenced by generator retirements or if the rates exhibit similar trends irrespective of such retirements. Through this exploratory analysis, the goal is to discern any distinctive patterns in unemployment dynamics. Given that the plot in Figure 25 below shows instances in which the unemployment rates do not follow the hypothesized pattern, another variable was chosen for statistical analysis.

##### Figure 25: Historical unemployment rates in Wayne, Rowan, Durham, and Chowan Counties{-}
```{r, cols_interest, echo=FALSE, warning=FALSE, error=FALSE}

#Creating df for only columns.counties of interest
rowan_ue <- transposed_ue[, c("Year", "37159")]
wayne_ue <- transposed_ue[, c("Year", "37191")]
durham_ue <- transposed_ue[, c("Year", "37063")] 
Chowan_ue <- transposed_ue[, c("Year", "37049")] 

rowan_ret <-  generator_retirement_data[generator_retirement_data$FIPS_Code == 37159, ]
wayne_ret <-  generator_retirement_data[generator_retirement_data$FIPS_Code == 37191, ]
durham_ret <-  generator_retirement_data[generator_retirement_data$FIPS_Code == 37063, ]
Chowan_ret <-  generator_retirement_data[generator_retirement_data$FIPS_Code == 37049, ]


#Converting to date format
rowan_ue$Year <- as.Date(rowan_ue$Year, format = "%Y")
wayne_ue$Year <- as.Date(wayne_ue$Year, format = "%Y")
durham_ue$Year <- as.Date(durham_ue$Year, format = "%Y")
Chowan_ue$Year <- as.Date(durham_ue$Year, format = "%Y")

#Plot
combined_plot <- ggplot() +
  geom_line(data = rowan_ue, aes(x = Year, y = `37159`, color = "Rowan"), size = 1) +
  geom_line(data = wayne_ue, aes(x = Year, y = `37191`, color = "Wayne"), size = 1) +
  geom_line(data = durham_ue, aes(x = Year, y = `37063`, color = "Durham"), size = 1) +
  geom_line(data = Chowan_ue, aes(x = Year, y = `37049`, color = "Chowan"), size = 1) +
  geom_vline(xintercept = 2012, linetype = "dashed", color = "black", size = 1) +
  labs(title = "Unemployment in Wayne, Rowan, Durham, and Chowan Counties",
       x = "Year",
       y = "Unemployment Rate (%)",
       color = "Dataset") +
  scale_color_manual(values = c("Rowan" = "blue", "Wayne" = "lightblue", "Durham" = "darkgreen", "Chowan" = "lightgreen")) +
  theme(legend.title = element_blank())

print(combined_plot)
```

```{r Rowan analysis, echo=FALSE, warning=FALSE, error=FALSE}
#[REMOVIG NARRATIVE FOR THE SUMMARY SINCE COMMENTED OUT RESULTS] Contrary to the initial hypothesis, this regression indicates that for each MW increase in retired nameplate capacity, the unemployment rate unemployment rate in Rowan is expected to decrease by approximately 0.02428 percentage points. The p-value is greater than 0.05, but given that it is only marginally higher (at 0.0619) we can theoretically interpret there to be a weak relationship. It must also be understood that the sample size is small and therefore we would need much more data for any reliable conclusions. The Multiple R-squared value of 0.5346 represents the proportion of the variance in the response variable (Rowan UE (%)) that can be explained by the predictor variable retired nameplate capacity (MW).


#Selecting Rowan only
rowan_data <- generator_retirement_data[generator_retirement_data$FIPS_Code == 37159, ]

#Rename generator retirement year to year in order to combine for analysis
colnames(rowan_data)[colnames(rowan_data) == "GENYRRET"] <- "Year"

#Reformat year in rowan_ue as numeric for merging
rowan_ue$Year <- as.numeric(format(rowan_ue$Year, "%Y"))

#Merge by year
rowan_merged_data <- merge(rowan_data, rowan_ue, by = "Year", all.x = TRUE)


### Data Wrangling ###

#Renaming columnn
names(rowan_ue)[trimws(names(rowan_ue)) == "37159"] <- "Rowan UE (%)"

#Adding nameplate capacity to generator
rowan_generator_retirement_NPACP <- processed_data_20 %>% 
  select(FIPS_Code, GENYRRET, NAMEPCAP_gen) %>%
  filter(FIPS_Code == "37159") %>%  # Filter for Rowan county
  na.omit() %>% #selecting only data with retirements
  rename(Year = GENYRRET)  # Renaming the column

#Merging
rowan_merged_data_NPCAP <- merge(rowan_generator_retirement_NPACP, rowan_ue, by = "Year", all.x = TRUE)

#### Data Analysis ###

#Linear regression
lm_result <- lm(`Rowan UE (%)` ~ NAMEPCAP_gen, data = rowan_merged_data_NPCAP)
#summary(lm_result) 
```


## Summary
The examination of the impact resulting from the retirement of power plant generators failed to produce definitive results; nevertheless, it contributes to the expanding field of advocating for an environmental justice perspective. This research goes beyond the reliance on the reduction of tons of carbon dioxide equivalents in emissions as a measure of the energy transition's success. It underscores the importance of adopting a holistic approach to key performance indicators, particularly given that large power plants are often situated in rural areas where communities heavily depend on utilities for employment (Union of Concerned Scientists, 2021). The analytical methodology adheres to best practices, incorporating counties with varying numbers of retirements to control for factors external to the retirements themselves. Additionally, the analysis delves into the actual nameplate capacity of retired assets, recognizing the plausible implication that a smaller capacity may employ fewer individuals compared to a larger plant. Contrary to the initial hypothesis, the findings reveal a statistically significant relationship, wherein each megawatt increase in retired nameplate capacity is associated with a marginal decrease in the unemployment rate. However, the inherent data limitations within this relatively small sample size require cautious interpretation. It is crucial to acknowledge that while this analysis falls short of providing conclusive results, it serves as a foundation for further exploration in subsequent analyses and environmental justice research.

#   Question 3: Does publicly available data show a relationship between power generation and social vulnerability, health vulnerability, or environmental burden?

###  Null hypothesis: There is no relationship between power plant distribution and social vulnerability, health vulnerability, or environmental burden.

Having explored two major socioeconomic dimensions in relation to total annual generation, the following sections expand upon income and unemployment to consider social vulnerability, environmental burden, and health vulnerability as the final topics in scope for this project's learning objectives.

#### Sub-question: Does publicly available data show a relationship between power generation and social vulnerability?

A set of analyses was conducted to briefly explore whether there is a significant relationship between power plants and the social vulnerability index (SVI), more broadly. A linear regression of SVI themes on total annual generation by county generated results summarized in Table 7.1. 

```{r County SVI and Total Power Generation lm}

#Selecting columns of interest:
SVI_county<-SVI_county_raw %>% select(ST_ABBR, STCNTY, COUNTY, FIPS, LOCATION, 
                                      RPL_THEMES, RPL_THEME1, RPL_THEME2, 
                                      RPL_THEME3, RPL_THEME4)

#Exporting to CSV:
#write.csv(SVI_county,'Data/Processed/SVI_County_Processed.csv', row.names=FALSE)

#Calculate sum of generation by county
Total_Generation_County <-plant_gen_data %>%
  group_by(CNTYNAME)%>%
  summarize(Total_Generation = sum(PLNGENAN))

#Merge SVI and total generation by county data
Generation_SVI <-merge(x = Total_Generation_County,
                           y = SVI_county, 
                           by.x = 'CNTYNAME', 
                           by.y = 'COUNTY' )

#Run regression to determine if there is a relationship
Generation_County_lm <- lm(Total_Generation ~ RPL_THEMES, data=Generation_SVI)
#Residual standard error: 14690000 on 74 degrees of freedom
# Multiple R-squared:  0.005408,	Adjusted R-squared:  -0.008033 
# F-statistic: 0.4023 on 1 and 74 DF,  p-value: 0.5278
# All coefficient p values are > .05

```

---

###### Table 7.1: Linear Regression Results - SVI and Total Generation
```{r SummaryTableofSVITotalGenlm,echo=FALSE}

summary_table_SVI <- summary(Generation_County_lm)$coef

# knitr::kable(summary(Generation_County_lm)$coef, format = "html", 
#              caption = "Linear Regression Results - SVI and Total Generation")

summary(Generation_County_lm)$coef %>%
  kbl() %>%
  kable_classic(html_font = "Helvetica")

```

---

Examining the positive coefficient of 3643958 alone suggested that an increase in the overall SVI aggregated theme (RPL_THEMES) leads to an increase in generation. However, the multiple R-squared value was very small (0.005408), signaling that this model does not fit the data well; with an R-squared so low, RPL Themes could only explain 0.5% of total generation by county across North Carolina in 2021. Ultimately, the p-value was not statistically significant (0.5278 > .05). The null hypothesis that there is no relationship between generation by county and RPL Themes in North Carolina in 2021 therefore could not be rejected. As apparent in Figure 26, at the county level across North Carolina in 2021, percentile rank for the Social Vulnerability Index across themes cannot be concluded to have a significant relationship to total power generation within this dataset.


##### Figure 26: The relationship between the Social Vulnerability Index (SVI) and 2021 annual generation in MWh across all power plants in a county.{-}

```{r County SVI and Total Power Generation Plot}
#Visualize the linear regression
tract_generation_SVI_plot <- ggplot(Generation_SVI, 
                                    aes(x = log(Total_Generation), 
                                        y = RPL_THEMES)) +
  geom_point()+
  #ylim(0,1)+
  stat_smooth(method = "lm", col = "red")+labs(y='Overall SVI Value', x='Total Generation in 2021 (MWh)',title= 
"Total Power Plant Generation and SVI by county")
print(tract_generation_SVI_plot) 

```

#### Sub-question: Does publicly available data show a relationship between power generation and environmental burden?

Given that power plants have historically made up a major stationary point source of air pollution including, for example, including SO2 and NO2, and given that both SO2 and NOx can contribute to the formation of atmospheric ozone and particulate matter, the relationship between power plant generation and emissions and the environmental burden module (EBM) was explored next. First, a single linear regression was run to examine whether the overall environmental burden module, RPL_EBM (percentile rank), could be at all explained by total generation per tract. Generation did not ultimately perform as a significant explanatory variable of RPL_EBM; the p-value of 0.93 was well above the 0.05 threshold for significance, and the R-squared value was very low (R-squared was 0.000025) as seen in Table 7.2. 

```{r Tract Environmental Burden and Total Power Generation, include=FALSE}

EB_totalgen_lm <- lm(data = sums_intersection_tractlevel, RPL_EBM ~ Tract_Generation)
summary(EB_totalgen_lm)
# Residual standard error: 0.2474 on 300 degrees of freedom
#   (10 observations deleted due to missingness)
# Multiple R-squared:  2.516e-05,	Adjusted R-squared:  -0.003308 
# F-statistic: 0.007547 on 1 and 300 DF,  p-value: 0.9308

####### ADDITIONAL EXPLORATIONS OF EB VARIABLES ########
EB_namepcap_lm <- lm(data = sums_intersection_tractlevel, RPL_EBM ~ Tract_NAMEPCAP)
summary(EB_namepcap_lm)
# Residual standard error: 0.2461 on 308 degrees of freedom
#   (2 observations deleted due to missingness)
# Multiple R-squared:  0.0002723,	Adjusted R-squared:  -0.002974 
# F-statistic: 0.08388 on 1 and 308 DF,  p-value: 0.7723

ozone_namep_lm <- lm(data = sums_intersection_tractlevel, E_OZONE ~ Tract_NAMEPCAP)
summary(ozone_namep_lm)
# Residual standard error: 0.3692 on 310 degrees of freedom
# Multiple R-squared:  0.001639,	Adjusted R-squared:  -0.001581 
# F-statistic: 0.509 on 1 and 310 DF,  p-value: 0.4761

DSLPM_namep_lm <- lm(data = sums_intersection_tractlevel, E_DSLPM ~ Tract_NAMEPCAP)
# summary(DSLPM_namep_lm)
# Residual standard error: 0.09596 on 309 degrees of freedom
#   (1 observation deleted due to missingness)
# Multiple R-squared:  0.003594,	Adjusted R-squared:  0.0003698 
# F-statistic: 1.115 on 1 and 309 DF,  p-value: 0.2919

PM_namep_lm <- lm(data = sums_intersection_tractlevel, E_PM ~ Tract_NAMEPCAP)
# summary(PM_namep_lm)
# Residual standard error: 0.7152 on 310 degrees of freedom
# Multiple R-squared:  0.0003096,	Adjusted R-squared:  -0.002915 
# F-statistic: 0.09601 on 1 and 310 DF,  p-value: 0.7569

#Full multiple regression to evaluate relationship between
#plant nameplate capacity and PM, atmospheric ozone, and DSLPM levels by tract
multivarEB_totalgen_lm <- lm(data = sums_intersection_tractlevel, 
                             Tract_NAMEPCAP ~ E_PM + E_OZONE + E_DSLPM)
step(multivarEB_totalgen_lm)

#The output of the full multiple regression was re-run with 
#the optimized variable combination
opt_multivarEB_totalgen_lm <- lm(data = sums_intersection_tractlevel, 
                             Tract_NAMEPCAP ~ E_OZONE + E_DSLPM)
summary(opt_multivarEB_totalgen_lm)
```

---

```{r SummaryTableofEBTotalGenlm,echo=FALSE}

summary_table_EB_totalgen_lm <- summary(EB_totalgen_lm)$coef

# knitr::kable(summary(EB_totalgen_lm)$coef, format = "html", 
#              caption = "Linear Regression Results - Environmental Burden and Total Generation",
#              align = "lrrrr",
#              full_width = F)

summary(EB_totalgen_lm)$coef %>%
  kbl() %>%
  kable_classic(html_font = "Helvetica")

```

---

Another linear regression run on nameplate capacity (maximum possible generation) returned an R-squared of .00027 and a p-value of 0.77, meaning nameplate capacity could not be considered a worthwhile explanatory variable to explore for the overall environmental burden module either. Ultimately, these analyses were insufficient to reject the null hypothesis that there is no relationship between environmental burden and nameplate capacity, or power generation by tract. An existing relationship cannot be concluded. The lack of clear relationship is demonstrated in Figure 27 below.


##### Figure 27: The relationship between the overall Environmental Burden Module (EBM) percentile rank and total power generation by tract. {-}
```{r EB and Total Power Generation Plot}
#Visualize the linear regression
tract_generation_EB_plot <- ggplot(sums_intersection_tractlevel, 
                                    aes(x = log(Tract_Generation), 
                                        y = RPL_EBM)) +
  geom_point()+
  #ylim(0,1)+
  stat_smooth(method = "lm", col = "red")+
  labs(y = 'Overall EB Value (Percentile Rank)', 
       x = 'Log of Total Generation in 2021 (MWh)',
       title = "Total Power Plant Generation and Environmental Burden by Tract")
print(tract_generation_EB_plot)
```

#### Sub-question: Does publicly available data show a relationship between power generation and human health vulnerability?

As the last high-level, aggregated theme index value to test in order to answer Question 3, analyses were conducted to test whether a statistically significant relationship could be determined between the health vulnerability module (HVM) and total power generation (actual or maximum possible). As mentioned in the Exploratory Analysis section and illustrated in Figure 16, health vulnerability as a variable exists in this data set at values of 0.0, 0.2, 0.4, 0.6, 0.8, and 1.0 (percentile rank). The specific methodology for calculating Health Vulnerability can be found on page 16 of the EJI data documentation in the 'Metadata' folder. Treating the variable as continuous proved unhelpful toward rejecting a null hypothesis that there is no relationship between tract-level HVM and total generation per tract (see Figure 28 for a visual representation of the linear regression treating RPL_HVM as continuous), therefore a series of one-way ANOVA analyses followed in which the variable was treated as categorical. The objective was to see if total generation per tract (treated as the factor) is meaningfully different across percentile ranks of HVM (RPL_HVM, treated as the levels) by testing if the mean generation is equal across all percentile rank categories. It is important to note that the percentile ranks do not have equal sample sizes and so we cannot assume totally normal distribution (as seen in Figure 16). The mean RPL_HVN across tracts is 0.56 for the data relevant to this project.

##### Figure 28: The relationship between the overall Health Vulnerability Module (HVM) percentile rank and total power generation by tract. As evidenced visually, total generation does not explain variability in HVM.{-}
```{r HV and Total Power Generation Plot}
#Visualize the linear regression
tract_generation_HV_plot <- ggplot(sums_intersection_tractlevel, 
                                    aes(x = log(Tract_Generation), 
                                        y = RPL_HVM)) +
  geom_point()+
  #ylim(0,1)+
  stat_smooth(method = "lm", col = "red")+
  labs(y = 'Overall HV Value (Percentile Rank)', 
       x = 'Log of Total Generation in 2021 (MWh)',
       title = "Total Power Plant Generation and Health Vulnerability by Tract")
print(tract_generation_HV_plot)
```


```{r Test for Normality of HVM, include=FALSE}

# Shapiro-Wilk test of the null that data follows a normal distribution
# shapiro.test(sums_intersection_tractlevel$Tract_Generation[sums_intersection_tractlevel$RPL_HVM == "0.2"])
# shapiro.test(sums_intersection_tractlevel$Tract_Generation[sums_intersection_tractlevel$RPL_HVM == "0.4"])
# shapiro.test(sums_intersection_tractlevel$Tract_Generation[sums_intersection_tractlevel$RPL_HVM == "0.6"])
# shapiro.test(sums_intersection_tractlevel$Tract_Generation[sums_intersection_tractlevel$RPL_HVM == "0.8"])

#Bartlett's test to check the null hypothesis that the variance at each of the percentile ranks is the same (because ANOVA is robust against departures from equal variance)
bartlett.test(sums_intersection_tractlevel$Tract_Generation ~ sums_intersection_tractlevel$RPL_HVM)
#Bartlett's K-squared = 237.49, df = 5, p-value < 2.2e-16

#Change RPM_HVM to character to treat as ordered categorical
sums_intersection_tractlevel <- sums_intersection_tractlevel %>%
  mutate(RPL_HVM = as.character(RPL_HVM))

#Run ANOVA
Gen_HVM_anova <- aov(data=sums_intersection_tractlevel, Tract_Generation ~ RPL_HVM)
summary(Gen_HVM_anova)
#              Df    Sum Sq   Mean Sq F value Pr(>F)
# RPL_HVM       5 8.505e+12 1.701e+12   1.056  0.385
# Residuals   296 4.766e+14 1.610e+12               
# 10 observations deleted due to missingness
# Cannot reject the null hypothesis that the mean of generation is the same across percentile ranks. 
```

Bartlett's test was run to check the null hypothesis that the variance at each of the percentile ranks is the same, and yielded a K-squared of 237.49 with 5 degrees of freedom and a p-value < 2.2e-16. ANOVA (function 'aov') was then run on tract generation and RPL_HVM (see Figure 29 below), yielding a p-value well above 0.05 (0.385). The null hypothesis that the mean of generation is the same across percentile ranks therefore could not be rejected. Lastly, a Tukey HSD test was conducted to examine the differences between pairs of percentile ranks, but every p-value generated was above 0.05. 

##### Figure 29: Analysis of Variance performed on Generation and Health Vulnerability by Tract. {-}
```{r HVM ANOVA Plots, echo=FALSE}
par(mfrow = c(2,2), mar=c(4,4,4,4))
plot(Gen_HVM_anova)
par(mfrow = c(1,1))
```

```{r HVM PostHoc Tests, include=FALSE}
#Which differences between pairs of means are significant?
#Tukey HSD
TukeyHSD(Gen_HVM_anova)
```

```{r Tract Health Vulnerability and Total Power Generation, include=FALSE}

HV_totalgen_lm <- lm(data = sums_intersection_tractlevel, RPL_HVM ~ Tract_Generation)
summary(HV_totalgen_lm)
# Residual standard error: 0.3204 on 300 degrees of freedom
#   (10 observations deleted due to missingness)
# Multiple R-squared:  4.249e-05,	Adjusted R-squared:  -0.003291 
# F-statistic: 0.01275 on 1 and 300 DF,  p-value: 0.9102

multivarHV_totalgen_lm <- lm(data = sums_intersection_tractlevel, 
                             Tract_NAMEPCAP ~ EP_ASTHMA + EP_BPHIGH + 
                                        EP_CANCER + EP_MHLTH)
step(multivarHV_totalgen_lm)
multivarEB_totalgen_lm <- lm(Tract_NAMEPCAP ~ EP_CANCER, data = sums_intersection_tractlevel)
summary(multivarEB_totalgen_lm)
# Residual standard error: 334.4 on 308 degrees of freedom
#   (2 observations deleted due to missingness)
# Multiple R-squared:  0.007909,	Adjusted R-squared:  0.004688 
# F-statistic: 2.455 on 1 and 308 DF,  p-value: 0.1181

cancer_namep_lm <- lm(data = sums_intersection_tractlevel, EP_CANCER ~ Tract_NAMEPCAP)
summary(cancer_namep_lm)
# Residual standard error: 1.132 on 308 degrees of freedom
#   (2 observations deleted due to missingness)
# Multiple R-squared:  0.007909,	Adjusted R-squared:  0.004688 
# F-statistic: 2.455 on 1 and 308 DF,  p-value: 0.1181

cnamep_plot <- ggplot(sums_intersection_tractlevel, 
                          aes(x=log(Tract_NAMEPCAP), y=EP_CANCER)) +
  geom_point() +
  # adjusting axes to hide extreme values
  # xlim(0, 550) +
  # ylim(0,700) +
  # finding a line of best fit
  geom_smooth(method = lm, color = "black") +
  ggtitle("Relationship between Estimated Cancer Prevalence and Log of Nameplate Capacity") + 
  labs(x="Log of Nameplate Capacity (MWh)", y="Estimated Cancer Prevalence (%)")
print(cnamep_plot)

BP_namep_lm <- lm(data = sums_intersection_tractlevel, EP_BPHIGH ~ Tract_NAMEPCAP)
summary(BP_namep_lm)
# Residual standard error: 5.5 on 308 degrees of freedom
#   (2 observations deleted due to missingness)
# Multiple R-squared:  6.466e-06,	Adjusted R-squared:  -0.00324 
# F-statistic: 0.001991 on 1 and 308 DF,  p-value: 0.9644

```

---

```{r SummaryTableofHVTotalGenlm,echo=FALSE}

summary_table_HV_totalgen_lm <- summary(HV_totalgen_lm)$coef

knitr::kable(summary(HV_totalgen_lm)$coef, format = "html", caption = "Linear Regression Results - Health Vulnerability and Total Generation")

```

---

Across regression tests run on the health vulnerability index value percentile rank (RPL_HVM) and total annual generation by tract, R-squared values were low and p-values were high. The regression results from this data and set of analyses are not sufficient to suggest that total generation can explain RPL_HVM with any significance. The analysis was insufficient to reject the null hypothesis that there is no relationship between health vulnerability and total generation by tract in our dataset. At the tract level across North Carolina in 2021, a relationship cannot be determined between percentile rank for Health Vulnerability and total power generation.


## Summary
This study used data from CDC's Social Vulnerability (county resolution) and Environmental Justice (tract resolution) Indices to test hypotheses that greater generation by power plants is correlated with elevated percentile ranks on social vulnerability, environmental burden, and health vulnerability modules as defined by the CDC. The CDC documentation reminds us that "a percentile ranking represents the proportion of tracts (or counties) that are equal to or lower than a tract of interest in environmental burden. For example, a EJI ranking of 0.85 signifies that 85% of tracts in the nation likely experience less severe cumulative impacts from environmental burden than the tract of interest, and that 15% of tracts in the nation likely experience more severe cumulative impacts from environmental burden" (https://www.atsdr.cdc.gov/placeandhealth/eji/faq_eji.html). Analyses did not yield results that allow us to reject the null hypothesis that there is no relationship between power plant distribution and social vulnerability, health vulnerability, or environmental burden.

# References
*Supporting the nations coal workers and communities in a changing energy landscape. Union of Concerned Scientists. (2021).
https://www.ucsusa.org/resources/support-coal-workers#read-online-content.  

*United States Environmental Protection Agency (EPA). 2023. Emissions & Generation Resource Integrated Database (eGRID), 2021 Washington, DC: Office of Atmospheric Protection, Clean Air Markets Division. Available from EPAs eGRID web site: https://www.epa.gov/egrid. Accessed on 11/1/2023.

*United States Census Bureau. Cartographic Boundary Files - Shapefile. 2018 County. https://www.census.gov/geographies/mapping-files/time-series/geo/carto-boundary-file.html. Accessed on 11/15/2023.

*United States Department of Agriculture / Economic Research Service. Poverty estimates for the U.S., States, and counties, 2021. https://www.ers.usda.gov/data-products/county-level-data-sets/county-level-data-sets-download-data/. Accessed on 11/1/2023.

*United States Department of Agriculture / Economic Research Service. Unemployment and median household income for the U.S., States, and counties, 200022. https://www.ers.usda.gov/data-products/county-level-data-sets/county-level-data-sets-download-data/. Accessed on 11/1/2023.

*Centers for Disease Control and Prevention and Agency for Toxic Substances Disease Registry/ Geospatial Research, Analysis, and Services Program. CDC/ATSDR Social Vulnerability Index 2020. Database North Carolina. https://www.atsdr.cdc.gov/placeandhealth/svi/data_documentation_download.html. Accessed on 12/6/2023.

*Centers for Disease Control and Prevention and Agency for Toxic Substances Disease Registry. 2022 Environmental Justice Index. https://www.atsdr.cdc.gov/placeandhealth/eji/index.html. Accessed on 12/5/2023.

*Zhu, Hao. "knitr::kable and kableExtra". 19 Feb. 2021. https://cran.r-project.org/web/packages/kableExtra/vignettes/awesome_table_in_html.html. Accessed on 12/13/2023.

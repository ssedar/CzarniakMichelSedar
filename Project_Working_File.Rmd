---
title: "Examining the Socioeconomic Dimension of Power Plant Impacts"
author: "Gaby Czarniak, Mara Michel, Sam Sedar"
date: "12-11-2023"
output: 
  html_document:
    toc: true
  
---
# Research Rationale
The impetus behind this research lies in the imperative to address the intricate interplay between socioeconomic factors and power plants. As the global energy landscape undergoes a transformative shift toward sustainability, it becomes paramount to understand how these changes might impact communities, particularly those situated in lower-income communities. The socio-spatial lens through which this study is conducted aims to unearth patterns of power plant distribution across North Carolina. North Carolina is home to 100 counties and 843 power plants made up of 1190 generators (US EPA, 2021). The overarching question is whether certain communities bear a disproportionate burden of environmentally impactful energy sources, framing the discourse within the realms of environmental justice and equity.

As a key aspect of this exploration, the research considers the connection between power plant location and emissions and various socioeconomic indicators, including but not limited to unemployment rates. This exploration is motivated by the awareness that power plants have often served as major employers in low-income areas (Union of Concerned Scientists, 2021). This research extends its focus beyond energy sources to examine the broader impacts of power plants on health and social vulnerability, and scrutinizes disparities in pollution exposure and associated health risks at a high level, using publicly available data. Through an exploration that encompasses various socioeconomic indicators, this research contributes to a more nuanced understanding of the multifaceted impacts of power plants.


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,warning = FALSE,message=FALSE)
library(tidyverse)
library(lubridate)
library(here); here()
library(rvest)
library(cowplot)
library(agricolae)
library(dplyr)
library(tidyverse)
library(lubridate)
library(trend)
library(zoo) 
library(Kendall)
library(tseries)
library(sf)
library(leaflet)
library(tseries)
library(knitr)
library(mapview); mapviewOptions(fgb = FALSE)
getwd()
```
# Data Set Information
Data used in this analysis comes from a variety of sources. A brief overview of each source is outlined below and full citations can be found at the end of this report. More information on the metadata for each source can be found in the 'Metadata' folder.


### Emissions & Generation Resource Integrated Database (eGRID)
The study utilizes the 2020 and 2021 eGRID provided by the U.S. Environmental Protection Agency to acquire essential power plant characteristics. This annually updated database offers comprehensive details on emissions, emission rates, generation, heat input, resource mix, location, and various other indicators. For the specific analyses undertaken in this research, key data elements employed included the plant Federal Information Processing Standards (FIPS) code, generation, nameplate capacity, and emissions by plant.
To process this dataset, the plant and generator sheets undergo individual modifications before being integrated. Notably, columns relevant to the analyses were selected, an additional column was introduced to consolidate state and county FIPS codes into a unified county FIPS code, and the overall dataset was filtered to North Carolina, exclusively. A parallel procedure is executed for the generator sheet before merging the two datasets using the unique ORISPL code.

It is important to highlight that although the most recent eGRID database available was from 2021, this version lacked historical generator retirement data. Consequently, the 2020 eGRID database is incorporated to facilitate the analysis of unemployment trends related to generator retirements.

### Economic Research Service Data Sets: Median Household Income
To establish a nexus between power plants and socioeconomic factors, household income data is derived from data compiled by the Economic Research Service of the United States Department of Agriculture. This data includes metrics such as household income and poverty rates at the county level, with identification facilitated by the Federal Information Processing Standards (FIPS) Code. The preparation of this dataset involves the extraction of pertinent columns, specifically median household income, followed by integration with the initial eGRID dataframe. The unifying factor for this integration is the FIPS Code, which served as the common column linking the two datasets.

### Economic Research Service Data Sets: Unemployment
As an additional facet of investigation, the analysis incorporates unemployment data obtained from the Economic Research Service of the United States Department of Agriculture. The dataset, spanning the years 2000 through 2021, comprises comprehensive information on the total labor force, the number of employed individuals, the number of unemployed individuals, and the unemployment rate. The data wrangling process for this dataset unfolds in two distinct stages. Initially, the columns of interest, specifically those pertaining to the unemployment rate, are  selected. Following this, the identified columns undergo appropriate conversions to their intended data types before being merged with the existing dataset, utilizing the county FIPS code as the linking identifier.

The subsequent phase of data wrangling introduces additional steps specifically tailored for conducting regression analyses between generator retirements and unemployment rates. To facilitate this analysis, the code executes a transposition of the data. This transformation presents North Carolina county unemployment rates by year in a more streamlined format, allocating a dedicated column for each year. 

### Social Vulnerability Index – 
2020 data from the US CDC on key vulnerability criteria including socioeconomic status, household characteristics, racial & ethnic minority status, and house type & transportation.

### Environmental Justice Index - 
2022 report on environmental burden, social vulnerability, and health vulnerability indicators. The Environmental Protection Agency (EPA) Environmental Justice Index (EJI) team selected the indicators based on a literature review conducted between December 2020 and December 2021.


Table: Table 1: Dataset Information

Dataset |  Attribute    | Description
----------- |---------------| -------------
eGRID  |  Key Variables | Plant locations, production, capacity, retirements, and emissions.
eGRID  |Data Hierarchy | Generators are associated to plants, plants are associated to counties and FIPS codes
eGRID  |Data Range | 2020 (data set used only to reference historical retirement data) and 2021 (all other data)
eGRID  |Data Source |The United States Environmental Protection Agency
Income  |  Key Variables | Median Household Income, FIPS codes
Income |Data Hierarchy | Income data is associated with FIPS county code
Income |Data Range | 2021
Income |Data Source | The Economic Research Service of the United States Department of Agriculture
Unemployment  |  Key Variables | Unemployment rate, FIPS code
Unemployment    |Data Hierarchy | Unemployment rates are associated with FIPS county code
Unemployment    |Data Range | 2000 to 2021
Unemployment  |Data Source | The Economic Research Service of the United States Department of Agriculture
Social Vulnerability Index  |  Key Variables | Socioeconomic status, household characteristics, racial & ethnic minority status, and house type & transportation
Social Vulnerability Index  |Data Hierarchy | Indicator data is available at the tract level
Social Vulnerability Index  |Data Range | 2020
Social Vulnerability Index  |Data Source | The United States Centers for Disease Control and Prevention/Agency for Toxic Substances and Disease Registry Social Vulnerability Index (CDC/ATSDR SVI)
Environmental Justice Index  |  Key Variables | Environmental burden, social vulnerability, and health vulnerability
Environmental Justice Index  |Data Hierarchy | Indicator data is available at the tract level
Environmental Justice Index  |Data Range | 2020 to 2021
Environmental Justice Index  |Data Source | The United States Agency for Toxic Substances and Disease


```{r, Data_Load, echo=FALSE, warning=FALSE, error= FALSE}

#Loading Data into Raw Data folder

plant <- read.csv(here('Data/Raw/PLNT21.csv'),
                  stringsAsFactors = FALSE, skip = 1, 
                  colClasses = c('FIPSST' = 'character', 
                                 'FIPSCNTY' = 'character',
                                 'ORISPL' = 'character'))

gen <- read.csv(here('Data/Raw/GEN21.csv'), 
                stringsAsFactors = FALSE, skip = 1, 
                  colClasses = c('ORISPL' = 'character'))

gen20 <- read.csv(here('Data/Raw/GEN20.csv'),                 
                  stringsAsFactors = FALSE, skip = 1, 
                  colClasses = c('ORISPL' = 'character'))

income <- read.csv(here('Data/Raw/PovertyEstimates.csv'), 
                  stringsAsFactors = TRUE, skip = 4)

unemployment <- read.csv(here('Data/Raw/Unemployment.csv'), 
                  stringsAsFactors = TRUE, skip = 4)

SVI_county_raw <-read.csv(here('Data/Raw/SVI_NorthCarolina_county.csv'),
                  stringsAsFactors = TRUE)

EJI_countytract <-read.csv(here('Data/Raw/EBM_NorthCarolina.csv'),
                  stringsAsFactors = TRUE)

SVI_2018_tract <-read.csv(here('Data/Raw/SVI2018_NorthCarolina.csv'),
                  stringsAsFactors = TRUE)
```

# Data Wrangling
The intial step in our research, once loaded, was data wrangling on the eGRID, unemployment, and income datasets. For the eGRID dataset, the code selects specific columns related to power plant information in North Carolina, converts certain columns to numeric format, and then combines the generator and plant data based on a common identifier. Duplicate columns are removed, resulting in the plant_gen_data dataframe. The code then proceeds to handle the unemployment dataset, selecting relevant columns covering the years 2002-2022 and merging it with the plant_gen_data dataframe using the FIPS code as a key. Similarly, the income dataset is processed by selecting specific columns, and the final step involves merging this income data with the previously created dataframe. The resulting dataset, named processed_data, contains information on power plants, unemployment rates, and income data, and the column names are displayed at the end of the code.


```{r, echo=FALSE, warning=FALSE, error=FALSE}
######  DATA WRANGLING - BASELINE  ######

#EGRID DATA

#Selecting columns of interest from plant data
plant_select <- plant %>%
  select(PSTATABB, ORISPL, FIPSST, FIPSCNTY, PLFUELCT, NAMEPCAP,
         PLNGENAN,PLSO2RTA, PLCO2RTA, PLCH4RTA, PLN2ORTA, PLCO2AN, PLN2OAN,PLNOXAN,
         PLSO2AN,PLCH4AN, CNTYNAME, LAT,
         LON, COALFLAG) %>%
  filter(PSTATABB == "NC") %>%
  unite(FIPS_Code, FIPSST, FIPSCNTY, sep = "")

plant_select$PLNGENAN <- as.numeric(plant_select$PLNGENAN)
plant_select$PLCO2RTA <- as.numeric(plant_select$PLCO2RTA)
plant_select$PLCO2AN <- as.numeric(plant_select$PLCO2AN)
plant_select$NAMEPCAP <- as.numeric(plant_select$NAMEPCAP)


#Combining Generator and Plant df based on ORISPL
plant_gen <- gen %>%
  inner_join(plant_select, by = 'ORISPL', 
             suffix = c("_gen", "_plant"))

plant_gen$CFACT <- as.numeric(plant_gen$CFACT)
plant_gen$GENNTOZ <- as.numeric(plant_gen$GENNTOZ)
plant_gen$NAMEPCAP_gen <- as.numeric(plant_gen$NAMEPCAP_gen)
plant_gen$GENNTAN <- as.numeric(plant_gen$GENNTAN)

#Removing duplicate state abbreviation column
plant_gen_data <- plant_gen[, -which(names(plant_gen) == "PSTATABB_plant")]

#Exporting to CSV:
write.csv(plant_gen_data,'Data/Processed/PLNT_GEN21.csv', row.names=FALSE)

#UNEMPLOYMENT DATA

#Selecting columns of interest: unemployment rates: 2002-2022

ue <- unemployment %>%
  select(FIPS_Code,	Unemployment_rate_2000,	Unemployment_rate_2001,	Unemployment_rate_2002,	Unemployment_rate_2003,	Unemployment_rate_2004,	Unemployment_rate_2005,	Unemployment_rate_2006,	Unemployment_rate_2007,	Unemployment_rate_2008,	Unemployment_rate_2009,	Unemployment_rate_2010,	Unemployment_rate_2011,	Unemployment_rate_2012,	Unemployment_rate_2013,	Unemployment_rate_2014,	Unemployment_rate_2015,	Unemployment_rate_2016,	Unemployment_rate_2017,	Unemployment_rate_2018,	Unemployment_rate_2019,	Unemployment_rate_2020,	Unemployment_rate_2021,	Unemployment_rate_2022)

#Exporting to CSV:
write.csv(ue,'Data/Processed/Unemployment2000_2022.csv', row.names=FALSE)

#Merging with eGrid
ue_egrid <- merge(plant_gen_data, ue, by = "FIPS_Code")

#Exporting to CSV:
write.csv(ue_egrid,'Data/Processed/Unemployment2000_2022_eGrid21.csv', row.names=FALSE)

#INCOME DATA

#Selecting columns of interest: 
inc <- income %>%
  select(FIPS_Code, PCTPOVALL_2021, MEDHHINC_2021)

#Exporting to CSV:
write.csv(inc,'Data/Processed/Income2021.csv', row.names=FALSE)

#Merging
processed_data <- merge(ue_egrid, inc, by = "FIPS_Code")

#Exporting to CSV:
write.csv(processed_data,'Data/Processed/Income_Unemployment_eGrid.csv', row.names=FALSE)
```

# Exploratory Analysis
This analysis initiates data exploration and visualization for the processed_data dataframe, focusing on fuel types, income, and electricity generation in North Carolina. Figure 1 generates a pie chart to illustrate the percentage makeup of primary fuel types in North Carolina based on total annual generation. Subsequently, the scatter plot in Figure 2 depicts the relationship between median household income and total plant annual generation, with points colored by fuel type. The exploratory analysis further drills down to scatter plots excluding nuclear data and for a selected set of fuel types (COAL, SOLAR, OIL, WIND, GAS). Additionally, stacked bar plots in Figures 5 and 6  visualize the total annual generation by fuel type and county, and for better clarity, separate plots are created for the top 10 and bottom 10 counties based on median household income. These visualizations help explore and understand the relationships between fuel types, income levels, and electricity generation in different counties of North Carolina.

##### Figure 1: Pie chart illustrating the percentage distribution of primary fuel types in North Carolina based on total annual generation.

```{r, Exploration, echo=FALSE, warning=FALSE, error=FALSE}

########### DATA EXPLORATION - FUEL TYPES ###########

#NC Breakdown of Fuel by Category
fuel_summarized <- processed_data %>%
  group_by(PLFUELCT) %>%
  summarise(total_generation = sum(PLNGENAN, na.rm = TRUE))

#In percentages
fuel_summarized$percentage <- fuel_summarized$total_generation / sum(fuel_summarized$total_generation) * 100

#Pie chart with percent makeup of fuel in  NC
pie_chart_percentage <- ggplot(fuel_summarized, aes(x = "", fill = PLFUELCT, y = percentage)) +
  geom_bar(width = 1, stat = "identity") +
  coord_polar(theta = "y") +
  labs(
    title = "North Carolina Primary Fuel (% of Total Annual Generation)",
    fill = "Primary Fuel Type",
    y = "Percentage of Total Generation (%)",
    x = NULL)
print(pie_chart_percentage)
```

##### Figure 2: Scatter plot illustrating the correlation between median household income and total annual generation, color-coded by fuel type. Owing to the unique characteristics of nuclear power plants, operating at significantly higher capacity factors than other sources, the plot lacks a discernible relationship, prompting necessary adjustments. 

```{r, income_type, echo=FALSE, warning=FALSE, error=FALSE}
#Relationship between income and fuel type
processed_data$MEDHHINC_2021 <- as.numeric(processed_data$MEDHHINC_2021)

#Scatter visualization
scatter_income_generation <- ggplot(processed_data, aes(x = MEDHHINC_2021, y = PLNGENAN, color = PLFUELCT)) +
  geom_point() +
  labs(title = "Income and Annual Generation by Fuel Type",
       x = "Median Household Income ($)",
       y = "Total Plant Annual Generation (MWh)",
       color = "Fuel Type",
caption = "")
print(scatter_income_generation)
```

##### Figure 3: Exploring energy patterns, this scatter plot analyzes the connection between median household income and total annual generation, excluding nuclear energy. The updated chart reveals a potential trend, especially around the $70,000 median income mark, where data points for generation are sparse.

```{r, ex_nuclear, echo=FALSE, warning=FALSE, error=FALSE}
#Scatter ex-nuclear
scatter_income_generation_ex_nuc <- ggplot(subset(processed_data, PLFUELCT != "NUCLEAR"), 
                                     aes(x = MEDHHINC_2021, y = PLNGENAN, color = PLFUELCT)) +
  geom_point() +
  labs(title = "Relationship Between Annual Generation, Fuel Type, and Income",
       x = "Median Household Income ($)",
       y = "Total Plant Annual Generation (MWh)",
       color = "Fuel Type")
print(scatter_income_generation_ex_nuc)

```

##### Figure 4: To narrow our exploration further, we selected key energy sources: coal, gas, oil, wind, and solar.

```{r, select, echo=FALSE, warning=FALSE, error=FALSE}

selected_fuel_data <- subset(processed_data, PLFUELCT %in% c("COAL", "SOLAR", "OIL", "WIND", "GAS"))

# Scatter plot for selected fuel types
scatter_income_generation_selected <- ggplot(selected_fuel_data, 
                                              aes(x = MEDHHINC_2021, y = PLNGENAN, color = PLFUELCT)) +
  geom_point() +
  labs(title = "Relationship Between Annual Generation, Fuel Type, and Income",
       x = "Median Household Income ($)",
       y = "Total Plant Annual Generation (MWh)",
       color = "Fuel Type")
print(scatter_income_generation_selected)

```

##### Figure 5: Stacked bar plot illustrating the total annual generation by fuel type in the top 10 counties (by median income) in North Carolina.

```{r, top10, echo=FALSE, warning=FALSE, error=FALSE}
#Top 10 counties based on median household income
top_income_counties <- processed_data %>%
  group_by(CNTYNAME) %>%
  summarize(median_income = median(MEDHHINC_2021, na.rm = TRUE)) %>%
  top_n(10, median_income) %>%
  pull(CNTYNAME)

filtered_data_income <- processed_data %>%
  filter(CNTYNAME %in% top_income_counties)

#Stacked bar plot
stacked_barplot_top_income_counties <- ggplot(filtered_data_income, aes(x = CNTYNAME, y = PLNGENAN, fill = PLFUELCT)) +
  geom_bar(stat = "sum", position = "stack") +
  labs(title = "Total Annual Generation by Fuel Type and County \n (Top 10 by Median Income)",
       x = "County",
       y = "Total Plant Annual Generation (MWh)",
       fill = "Fuel Type") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
print(stacked_barplot_top_income_counties)
```

##### Figure 6: To get a balanced view of the total annual generation by fuel type and county, we then show the bottom 10 counties (by median income) in North Carolina. This identified Richmond county as a county of interest.

```{r, bottom10, echo=FALSE, warning=FALSE, error=FALSE}
#Bottom 10 counties based on median household income
bottom_income_counties <- processed_data %>%
  group_by(CNTYNAME) %>%
  summarize(median_income = median(MEDHHINC_2021, na.rm = TRUE)) %>%
  arrange(median_income) %>%
  slice_head(n = 10) %>%
  pull(CNTYNAME)

filtered_data_bottom_income <- processed_data %>%
  filter(CNTYNAME %in% bottom_income_counties)

#Stacked bar plot
stacked_barplot_bottom_income_counties <- ggplot(filtered_data_bottom_income, aes(x = CNTYNAME, y = PLNGENAN, fill = PLFUELCT)) +
  geom_bar(stat = "sum", position = "stack") +
  labs(title = "Total Annual Generation by Fuel Type and County \n (Bottom 10 by Median Income)",
       x = "County",
       y = "Total Plant Annual Generation (MWh)",
       fill = "Fuel Type") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
print(stacked_barplot_bottom_income_counties)
```



We then created initial maps to better understand the landscape of North Carolina in terms of socioeconomic status and geographic distribution of power plants. Figure 8 below shows the mapping of power plants across the state and helped us to visualize the concentration of power plants across the state. Figure 9 maps the nameplate capacity of those power plants by county. We noticed that multiple counties, especially Richmond county, stood out as having a high concentration of capacity. Figure 10 demonstrates a heat map of the percentage of each county's population living in poverty as of 2021. Richmond county is once again a clear visual outlier on this map.

##### Figure 8: Active power plants across North Carolina as of 2021. Each black dot is a power plant.

```{r Initial Maps - Power plant locations}
#Load in counties spatial data
counties_sf<- st_read(here('Data/Spatial/cb_2018_us_county_20m.shp')) %>% 
  filter(STATEFP==37)

#Convert eGrid tabular data to spatial data
plant_gen_sf <-plant_gen_data %>% st_as_sf(coords = c('LON','LAT'), crs=4269)
#Create initial map of power plants
gens_counties_map <-ggplot()+
  geom_sf(data=counties_sf)+
  geom_sf(data=plant_gen_sf,size=0.8)+
  labs(title = "Locations of NC Power Plants")
print(gens_counties_map)
```

##### Figure 9: This map shows the total nameplate capacity in Megawatts of each county in North Carolina. Multiple counties have no power plants and are blank. Richmond County is an interesting outlier which the highest capacity of all the counties.
```{r Initial Maps - Nameplate capacity}

#Compute sum of nameplate capacity by county
nameplate_capacity <-plant_gen_data %>%
  group_by(CNTYNAME)%>%
  summarize(Sum_NAMEPCAP = sum(NAMEPCAP_plant))
#Join the eGrid attributes to the county spatial features
counties_sf_join <-  merge(x = counties_sf,
                           y = plant_gen_data, 
                           by.x = 'NAME', 
                           by.y = 'CNTYNAME' )
#Map total generator capacity by county
gen_cap_map <-ggplot(data=counties_sf_join)+
  geom_sf(aes(fill=NAMEPCAP_plant))+labs(title="Capacity by County",fill="Capacity (MW)")
print(gen_cap_map)
```

##### Figure 10: Percent of total county population living in poverty in 2021, as defined by the USDA Economic Research Service.
```{r Initial Maps - Income by county}
## Heat map of Income Data by County ##
#Create data frame of NC income data
income_NC <-income %>% 
  filter(Stabr=='NC')
#Join the income attributes to the county spatial features
income_NC_sf_join <-  merge(x = counties_sf,
                           y = income_NC, 
                           by.x = 'GEOID', 
                           by.y = 'FIPS_Code')
#Map pct in poverty by county
income_heat_map <-ggplot(data=income_NC_sf_join)+
  geom_sf(aes(fill=PCTPOV017_2021))+labs(title= "% of County in Poverty - 2021", fill="%")
print (income_heat_map)
```

Our final stage of exploratory analysis was to visualize the power plant emissions geographically. Figures 11-15 demonstrate the aggregated power plant emissions per county in 2021 for CO2, NOx, SO2, N20, and CH4 respectively. Unfortunately eGrid did not provide data for Mercury (Hg) in 2021 so that was not analyzed. N20 and CH4 are provided in lbs while CO2, NOx, and SO2 are in short tons. For CO2 emissions, Richmond county stood out. For NOx emissions, Catawba county stood out. For SO2 emissions, Catawba, Haywood, and Person counties stood out.For N20 and CH4 emissions, Catawba and Person counties stood out.

##### Figure 11: Total CO2 Emissions in 2021 across North Carolina Power Plants.
```{r Power Plant Emissions Heat Maps}
#Heat map of CO2 emissions by county
#Compute sum of CO2 Emissions by county
CO2_emissions <-plant_gen_data %>%
  drop_na(PLCO2AN)%>%
  group_by(CNTYNAME)%>%
  summarize(Sum_CO2 = sum(PLCO2AN))
#Join the eGrid attributes to the county spatial features
CO2_counties_sf_join <-  merge(x = counties_sf,
                           y = CO2_emissions, 
                           by.x = 'NAME', 
                           by.y = 'CNTYNAME')
#Map CO2 emissions by county
CO2_map <-ggplot(data=CO2_counties_sf_join)+geom_sf(data=counties_sf)+
  geom_sf(aes(fill=Sum_CO2))+
  labs(title="2021 CO2 Emissions",
       fill="CO2 Emissions (tn)")
print(CO2_map)
```

##### Figure 12: Total NOx Emissions in 2021 across North Carolina Power Plants.

```{r, NOX Emissions}
#Heat map of NOx emissions by county
#Compute sum of NOx Emissions by county
NOx_emissions <-plant_gen_data %>%
  drop_na(PLNOXAN)%>%
  group_by(CNTYNAME)%>%
  summarize(Sum_NOx = sum(PLNOXAN))
#Join the eGrid attributes to the county spatial features
NOx_counties_sf_join <-  merge(x = counties_sf,
                           y = NOx_emissions, 
                           by.x = 'NAME', 
                           by.y = 'CNTYNAME')

#Map NOx emissions by county
NOx_map <-ggplot(data= NOx_counties_sf_join)+
  geom_sf(data=counties_sf)+
  geom_sf(aes(fill=Sum_NOx))+
  labs(title="2021 NOx Emissions",
       fill=" NOx Emissions (tn)")
print(NOx_map)
```

##### Figure 13: Total SO2 Emissions in 2021 across North Carolina Power Plants.

```{r, SO2 Emissions}
#Heat map of SO2 emissions by county
#Compute sum of SO2 Emissions by county
SO2_emissions <-plant_gen_data %>%
  drop_na(PLSO2AN)%>%
  group_by(CNTYNAME)%>%
  summarize(Sum_SO2 = sum(PLSO2AN))
#Join the eGrid attributes to the county spatial features
SO2_counties_sf_join <-  merge(x = counties_sf,
                           y = SO2_emissions, 
                           by.x = 'NAME', 
                           by.y = 'CNTYNAME')
#Map SO2 emissions by county
SO2_map <-ggplot(data=SO2_counties_sf_join)+
  geom_sf(data=counties_sf)+
  geom_sf(aes(fill=Sum_SO2))+
  labs(title="2021 SO2 Emissions",
       fill="SO2 Emissions (tn)")
print(SO2_map)
```

##### Figure 14: Total N20 Emissions in 2021 across North Carolina Power Plants.

```{r, N20 Emissions}
#Heat map of N2O emissions by county
#Compute sum of N2O Emissions by county
N2O_emissions <-plant_gen_data %>%
  drop_na(PLN2OAN)%>%
  group_by(CNTYNAME)%>%
  summarize(Sum_N2O = sum(PLN2OAN))
#Join the eGrid attributes to the county spatial features
N2O_counties_sf_join <- merge(x = counties_sf,
                           y = N2O_emissions, 
                           by.x = 'NAME', 
                           by.y = 'CNTYNAME')
#Map N2O emissions by county
N2O_map <-ggplot(data= N2O_counties_sf_join)+
  geom_sf(data=counties_sf)+
  geom_sf(aes(fill=Sum_N2O))+
  labs(title="2021 N2O Emissions",
       fill=" N2O Emissions (lbs)")
print(N2O_map)
```

##### Figure 15: Total CH4 Emissions in 2021 across North Carolina Power Plants.

```{r, CH4 Emissions}
#Heat map of CH4 emissions by county
#Compute sum of CH4 Emissions by county
CH4_emissions <-plant_gen_data %>%
  drop_na(PLCH4AN)%>%
  group_by(CNTYNAME)%>%
  summarize(Sum_CH4 = sum(PLCH4AN))
#Join the eGrid attributes to the county spatial features
CH4_counties_sf_join <- merge(x = counties_sf,
                           y = CH4_emissions, 
                           by.x = 'NAME', 
                           by.y = 'CNTYNAME')
#Map CH4 emissions by county
CH4_map <-ggplot(data= CH4_counties_sf_join)+
  geom_sf(data=counties_sf)+
  geom_sf(aes(fill=Sum_CH4))+
  labs(title="2021 CH4 Emissions",
       fill="CH4 Emissions (lbs)")
print(CH4_map)
```


# Question 1: How does income impact power plant characteristics at the county level?
This analysis begins by examining the impact that income has on various power plant characteristics. This first analysis uses income as the highest-level socioeconomic indicator, as income often dictates an array of follow-on indicators. Several regressions are conducted including the impact of income on the fuel type (differentiating between clean and dirty sources), number of plants, and nameplate capacity. 

Examining only the impact of income on coal plants, the estimated coefficient is approximately -134.6. This suggests that for each one-unit increase in income, the predicted value of coal generation decreases by approximately 134.6 MWh. The coefficient's p-value (0.1049) is greater than 0.05, indicating that it is not statistically significant at the 0.05 significance level. Furthermore, the R^2 suggests that only about 13.24% of the variability in coal generation is explained by income. Figure 16 below visualizes this relationship.

```{r, Income_and_Fuel, echo=FALSE, warning=FALSE, error=FALSE}

########### DATA ANALYSIS - INCOME AND FUEL TYPE ###########

#Coal linear regression
coal_data <- subset(processed_data, PLFUELCT == "COAL")
linear_model_coal <- lm(PLNGENAN ~ MEDHHINC_2021, data = coal_data)
summary_table <- summary(linear_model_coal)$coef

knitr::kable(summary(linear_model_coal)$coef, format = "html", caption = "Linear Regression Results - Coal")

```

##### Figure 16: Relationship of median household income ($) on coal generation (MWh) in 2021 by county.

```{r warning=TRUE}
#Visualize relationship
scatter_coal <- ggplot(coal_data, aes(x = MEDHHINC_2021, y = PLNGENAN)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, color = "blue") +
  labs(title = "County Income and Coal Generation",
       x = "Median Household Income ($)",
       y = "Coal Generation (MWh)")
print(scatter_coal)
```

The linear regression shown in Figure 17 below suggests that there might be a relationship between income and solar generation. The statistically significant p-value (0.04707) indicates that there is evidence to suggest that an increase in median household income is associated with a decrease in the predicted value of solar generation However, it's important to note that the explained variance is quite low (about 0.56%), and so other factors not included in the model likely contribute to the variability in generation for solar.

```{r echo=FALSE, error=FALSE, warning=FALSE, solar}

#Solar linear regression
solar_data <- subset(processed_data, PLFUELCT == "SOLAR")
linear_model_solar <- lm(PLNGENAN ~ MEDHHINC_2021, data = solar_data)

knitr::kable(summary(linear_model_solar)$coef, format = "html", caption = "Linear Regression Results - Solar")
```

##### Figure 17: Relationship of median household income ($) on solar generation (MWh) in 2021 by county.

```{r, solar plot, echo = FALSE}
#Visualize relationship
scatter_solar <- ggplot(solar_data, aes(x = MEDHHINC_2021, y = PLNGENAN)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, color = "blue") +
  labs(title = "County Income and Solar Generation",
       x = "Median Household Income ($)",
       y = "Solar Generation (MWh)")
print(scatter_solar)
```

The next stage of analysis examined if there was a relationship between the quantity of generators and median household income. The linear regression results indicate that median household income does not show a statistically significant association with the number of plants. The coefficient is estimated to be -0.0000786, with a standard error of 0.0000922, a t-value of -0.85, and a p-value of 0.3962. This suggests that, based on the available data, changes in median household income do not appear to be statistically linked to variations in the number of plants. Figure 18 below illustrates this relationship.

```{r, viz_solar, echo=FALSE, warning=FALSE, error=FALSE}

################ DATA ANALYSIS: INCOME AND POWER PLANTS ####################

#Regression on Income and the Number of Power Plants

### Pre-Analysis Wrangling ###
online_plants <- processed_data %>%
  drop_na(GENYRONL) %>%
  select(FIPS_Code, CNTYNAME, SEQGEN, YEAR, PNAME, 
         GENID, GENSTAT, GENYRONL, NAMEPCAP_plant, 
         PLNGENAN, PLCO2AN, COALFLAG, MEDHHINC_2021,	
         Unemployment_rate_2000,	Unemployment_rate_2001,	
         Unemployment_rate_2002,	Unemployment_rate_2003,	
         Unemployment_rate_2004,	Unemployment_rate_2005,	
         Unemployment_rate_2006,	Unemployment_rate_2007,	
         Unemployment_rate_2008,	Unemployment_rate_2009,	
         Unemployment_rate_2010,	Unemployment_rate_2011,	
         Unemployment_rate_2012,	Unemployment_rate_2013,	
         Unemployment_rate_2014,	Unemployment_rate_2015,	
         Unemployment_rate_2016,	Unemployment_rate_2017,	
         Unemployment_rate_2018,	Unemployment_rate_2019,	
         Unemployment_rate_2020,	Unemployment_rate_2021,	
         Unemployment_rate_2022)

# Creating separate df with plants by FIPS_Code
county_plants_table <- table(online_plants$FIPS_Code)
view(county_plants_table)
county_plants_df <- as.data.frame(county_plants_table)

#Renaming columnnames
colnames(county_plants_df)[colnames(county_plants_df) == "Var1"] <- "FIPS_Code"
colnames(county_plants_df)[colnames(county_plants_df) == "Freq"] <- "Num_Plants"
#add in income data
merged_data <- merge(county_plants_df, income[, c("FIPS_Code", "MEDHHINC_2021")], by = "FIPS_Code", all.x = TRUE)
# Merge back to original
county_plants_df <- merged_data

### Regression Analysis ###

#Run simple regression
inc_plants_model <- lm(Num_Plants ~ MEDHHINC_2021, data = county_plants_df)

knitr::kable(summary(inc_plants_model)$coef, format = "html", caption = "Linear Regression Results - Number of Plants")
```

##### Figure 18: Relationship of Median Household Income and Number of Power Plants in NC in 2021 by county.

```{r,power plants number}
#Plot relationship
ggplot(county_plants_df, aes(x = MEDHHINC_2021, y = Num_Plants)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  labs(title = "County Income and Number of Power Plants",
       x = "Median Household Income($)",
       y = "Number of Power Plants")
```



As different power plants are different sizes, especially across different fuel types, we analyzed if the average nameplate capacity of plants in a county was related to median household income.The linear regression on this relationship yields a coefficient of 0.0019239, accompanied by a standard error of 0.0023465. This implies that, theoretically, an increase in median household income is associated with a slight corresponding increase in Nameplate Capacity. However, the non-significant p-value of 0.4145 means we do not have sufficient evidence to reject the null hypothesis and the observed association between median household income and Nameplate Capacity may be coincidental.Figure 19 below demonstrates this relationship.

```{r, npcap, echo=FALSE, warning=FALSE, error=FALSE}
#Regression on Income and Nameplate Capacity

## Pre-Analysis Wrangling ##

#Calculate average nameplate capacity by county
average_capacity <- aggregate(NAMEPCAP_plant ~ FIPS_Code, data = online_plants, FUN = mean)
merged_data_capacity <- merge(average_capacity, income, by = "FIPS_Code")

## Regression Analysis ##

#Run simple regression
capacity_income_model <- lm(NAMEPCAP_plant ~ MEDHHINC_2021, data = merged_data_capacity)

knitr::kable(summary(capacity_income_model)$coef, format = "html", caption = "Linear Regression Results - Nameplate Capacity")
```

##### Figure 19: Relationship of Median Household Income on Average Nameplate Capacity (MW) by county in 2021.

```{r,nameplate capacity}

#Plot relationship
ggplot(merged_data_capacity, aes(x = MEDHHINC_2021, y = NAMEPCAP_plant)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  labs(title = "County Income and Nameplate",
       x = "Median Household Income($)",
       y = "Average Nameplate Capacity (MW)")

```

Finally, we briefly explored if we could find a statistical relationship between power plants and the social vulnerability index (SVI) instead of income. A linear regression of SVI on total annual generation by county was conducted. The coefficient is 3643958 and is positive, suggesting that an increase in the SVI leads to an increase in generation. However, the multiple R-squared value is very small (0.005408), signaling that this model does not fit the data well. Ultimately, the p-value is not statistically significant (0.5278) and so conclusions can not be drawn here. Figure 20 illustrates this relationship.

```{r Generation and SVI Relationship Analysis LM}
#Wrangle SVI DATA

#Selecting columns of interest:
SVI_county<-SVI_county_raw %>% select(ST_ABBR, STCNTY,COUNTY,FIPS, LOCATION, RPL_THEMES, RPL_THEME1, RPL_THEME2, RPL_THEME3, RPL_THEME4)

#Exporting to CSV:
write.csv(SVI_county,'Data/Processed/SVI_County_Processed.csv', row.names=FALSE)

#Calculate sum of generation by county
Total_Generation_County <-plant_gen_data %>%
  group_by(CNTYNAME)%>%
  summarize(Total_Generation = sum(PLNGENAN))

#Merge SVI and total generation by county data
Generation_SVI <-merge(x = Total_Generation_County,
                           y = SVI_county, 
                           by.x = 'CNTYNAME', 
                           by.y = 'COUNTY' )

#Run regression to determine if there is a relationship
Generation_County_lm <- lm(Total_Generation ~ RPL_THEMES, data=Generation_SVI)

summary_table_SVI <- summary(Generation_County_lm)$coef

knitr::kable(summary(Generation_County_lm)$coef, format = "html", caption = "Linear Regression Results - SVI and Total Generation")

```

##### Figure 20: The relationship between the Social Vulnerability Index (SVI) and 2021 annual generation in MWh across all power plants in a county.
```{r Generation and SVI Relationship Analysis Plot}
#Visualize the linear regression
tract_generation_SVI_plot <- ggplot(Generation_SVI, 
                                    aes(x = Total_Generation, 
                                        y = RPL_THEMES)) +
  geom_point()+ylim(0,1)+
  stat_smooth(method = "lm", col = "red")+labs(y='Overall SVI Value', x='Total Generation in 2021 (MWh)',title= 
"Total Power Plant Generation and SVI by county")
print(tract_generation_SVI_plot) 

```


```{r Data Wrangling}

#Filter by North Carolina
Plant_NC <- plant %>% filter(PSTATABB=='NC')
gen_NC <-gen %>% filter(PSTATABB=='NC')

#Create Joined Plot
PowerPlants_DF <-merge(x=gen_NC,y=Plant_NC, by='ORISPL',all.x=TRUE)
```

```{r Creating income groupings, echo=FALSE}

# GENYRRET = Generator planned or actual retirement year (four-digit)
# GENYRONL - year the generator came online (four-digit)

retired_year <- processed_data$GENYRRET %>%
  na.omit()
# earliest year of plant retirement was 2021
# can't run time series analysis with this data, 
# but could run regression analysis to understand relationship between
# planned retirement and 2021 avg household income or
# 2021 retirement and 2021 unemployment

online_plants <- processed_data %>%
  # drop observations with NAs in GENYRONL
  # which means we don't know what year they came online
  # new number of observations should be 1175 (dropping 15 NAs)
  drop_na(GENYRONL) %>%
  select(FIPS_Code, CNTYNAME, SEQGEN, YEAR, PNAME, 
         GENID, GENSTAT, GENYRONL, NAMEPCAP_plant, 
         PLNGENAN, PLCO2AN, COALFLAG, MEDHHINC_2021,	
         Unemployment_rate_2000,	Unemployment_rate_2001,	
         Unemployment_rate_2002,	Unemployment_rate_2003,	
         Unemployment_rate_2004,	Unemployment_rate_2005,	
         Unemployment_rate_2006,	Unemployment_rate_2007,	
         Unemployment_rate_2008,	Unemployment_rate_2009,	
         Unemployment_rate_2010,	Unemployment_rate_2011,	
         Unemployment_rate_2012,	Unemployment_rate_2013,	
         Unemployment_rate_2014,	Unemployment_rate_2015,	
         Unemployment_rate_2016,	Unemployment_rate_2017,	
         Unemployment_rate_2018,	Unemployment_rate_2019,	
         Unemployment_rate_2020,	Unemployment_rate_2021,	
         Unemployment_rate_2022)

online_year <- online_plants$GENYRONL

online_month_day_ <- rep(c("01-01-"), length(online_year))

# repeating month_day_ to fill in month and day
# for as many year entries as are found in 
# dropping NAs but may need to keep them in; decide as group
Date_Online <- paste0(online_month_day_,online_year)
# 1175 observations in Date_Online

# change years to date formats
Date_Online <- as.Date(Date_Online, format = "%m-%d-%Y")

# ensure date column is in date format
online_plants <- online_plants %>%
  mutate(GENYRONL = Date_Online)

# identifying the county with the most power plants
county_freq_table <- table(online_plants$CNTYNAME)
# view(county_freq_table)
max(county_freq_table) # 48, Robeson County
county_freq_table <- sort(county_freq_table, decreasing = TRUE)
# view(county_freq_table)
robeson_online_plants <- online_plants %>%
  filter(CNTYNAME == "Robeson")
# unique(robeson_online_plants$PNAME) # 44 unique power plant names
# unique(robeson_online_plants$GENID) # 32 unique GENIDs

# multiple regression for just one county, Robeson 
# the one with highest total number of existing plants in 2021
# to understand relationship between year online for each power plant and unemployment 
# need to make table by year
# with 5 columns: Year, FIPS code, number of plants in existence that year, unemployment rate
robeson_year <- year(robeson_online_plants$GENYRONL)
robeson_FIPS_code <- robeson_online_plants$FIPS_Code
## MARKING WHERE GC LEFT OFF
#robeson_plant_count <- tally(robeson_online_plants$PNAME, wt = NULL, sort = FALSE, name = NULL)
#is.Date(robeson_online_plants$GENYRONL)

```

## Summary
This study's initial inquiry sought to uncover how income, a significant socioeconomic indicator, relates to power plant characteristics. The investigation focused on the fuel type, the number, and the total nameplate capacity of power plants, each representing distinct dimensions of interest. Although the study did not produce definitive and statistically significant results regarding the influence of income on the number of power plants or nameplate capacity, it is suggested that this may be due to the complexity of the energy landscape. While one might expect lower generation capacity and fewer power plants in wealthier areas due to potential opposition, it is crucial to consider that energy consumption is often linked to a higher standard of living. Consequently, having generation capacity in higher-income areas may be necessary to meet the increased demand. Although this aspect of the exploration did not yield statistically significant results, it is noteworthy that the type of fuel generation, specifically solar, displayed some significance. The analysis indicated that an increase in median household income is associated with a decrease in solar generation. However, it is important to recognize that, despite being statistically significant, the coefficient of determination (r2) suggests that the explained variance is quite modest, standing at only 0.56%.

# Question 2: Do power plant retirements have a significant impact on unemployment?
The primary motivation behind this analysis is to delve into the nuanced equilibrium inherent in a just energy transition. The imperative of shifting energy fuel sources from carbon-intensive to fossil fuel-free must be achieved without detriment to communities. In this examination, we initially pinpoint counties in North Carolina with the highest and lowest numbers of retirements, comparing them to their respective unemployment rates over time. To conduct a more pointed analysis, a statistical examination is performed on a specific county of interest.

Power plant retirements were analyzed (using data contained in the 2020 eGRID dataset) to identify which counties had the most number of retired power plants.Counties with no retirements were also selected to provide a comparison. 

##### Figure 21: Number of historical power plant retirements per county based on 2020 eGRID data set
```{r, Unemployment_Retirements, echo=FALSE, warning=FALSE, error=FALSE}

################ DATA ANALYSIS: UNEMPLOYMENT AND GENERATOR RETIREMENTS ################ 

### Pre-Analysis Wrangling ###

#Set to numeric
gen20$NAMEPCAP <- as.numeric(gen20$NAMEPCAP)
gen20$GENNTOZ <- as.numeric(gen20$GENNTOZ)


#Combining gen20 and plant dataframes based on ORISPL
plant_gen20 <- gen20 %>%
  inner_join(plant_select, by = 'ORISPL', 
             suffix = c("_gen", "_plant"))

#Removing duplicate state abbreviation column
plant_gen_data_20 <- plant_gen20[, -which(names(plant_gen) == "PSTATABB_plant")]

#Merging with eGrid
ue_egrid_20 <- merge(plant_gen_data_20, ue, by = "FIPS_Code")

#Merging with income
processed_data_20 <- merge(ue_egrid_20, inc, by = "FIPS_Code")


#Transposing and wrangling both in order to view:
#   1. NC county unemployment by year, where we have a column for all years rather than each year having its own column
#   2. Generator retirement by year, selecting only those with instances of retired generators

#Unemployment
transposed_ue <- ue %>%
  filter(str_starts(FIPS_Code, "37")) %>%  # Filter to include only NC
  pivot_longer(cols = starts_with("Unemployment_rate_"), 
               names_to = "Year", 
               values_to = "Unemployment") %>%
  mutate(Year = gsub("Unemployment_rate_", "", Year, fixed = TRUE)) %>%
  pivot_wider(names_from = "FIPS_Code", values_from = "Unemployment")

#Generator
generator_retirement_data <- processed_data_20 %>% 
  select(FIPS_Code, GENYRRET) %>%
  na.omit()  #showing only generators that have retired


###### EXPLORATION #######

#Use table to count the occurrences of each unique FIPS code to select counties of interest
fips_counts <- table(generator_retirement_data$FIPS_Code)

for (i in seq_along(fips_counts)) {
  fips <- names(fips_counts)[i]
  count <- fips_counts[i]
  cat("FIPS Code:", fips, "has", count, "rows.\n")}

fips_counts <- table(generator_retirement_data$FIPS_Code)#identifies 2 counties with 7 instances of retirements

```

Based on the data set above, FIPS Code 37159 (Rowan) and 37191 (Wayne) each have the highest number of retirements at 7 rows.FIPS Code 37023  (Burke) 37041 (Chowan) 37049  (Craven) 37063 (Durham) 37067 (Forsyth) 37069 (Franklin) 37125 (Moore) each have 1 row.

In this analysis, counties experiencing both high (blue) and low (green) numbers of generator retirements, such as Rowan and Wayne (high retirements) and Burke and Craven (low retirements), are singled out. The objective is to investigate whether fluctuations in unemployment rates are influenced by generator retirements or if the rates exhibit similar trends irrespective of such retirements. Through this exploratory analysis, the goal is to discern any distinctive patterns in unemployment dynamics. As the plot in Figure 22 below shows instances in which the unemployment rates do not follow the hypothesized pattern, another variable was chosen for statistical analysis.

##### Figure 22: Historical unemployment rates in Wayne, Rowan, Durham, and Chowan Counties
```{r, cols_interest, echo=FALSE, warning=FALSE, error=FALSE}

#Creating df for only columns.counties of interest
rowan_ue <- transposed_ue[, c("Year", "37159")]
wayne_ue <- transposed_ue[, c("Year", "37191")]
durham_ue <- transposed_ue[, c("Year", "37063")] 
Chowan_ue <- transposed_ue[, c("Year", "37049")] 

rowan_ret <-  generator_retirement_data[generator_retirement_data$FIPS_Code == 37159, ]
wayne_ret <-  generator_retirement_data[generator_retirement_data$FIPS_Code == 37191, ]
durham_ret <-  generator_retirement_data[generator_retirement_data$FIPS_Code == 37063, ]
Chowan_ret <-  generator_retirement_data[generator_retirement_data$FIPS_Code == 37049, ]


#Converting to date format
rowan_ue$Year <- as.Date(rowan_ue$Year, format = "%Y")
wayne_ue$Year <- as.Date(wayne_ue$Year, format = "%Y")
durham_ue$Year <- as.Date(durham_ue$Year, format = "%Y")
Chowan_ue$Year <- as.Date(durham_ue$Year, format = "%Y")

#Plot
combined_plot <- ggplot() +
  geom_line(data = rowan_ue, aes(x = Year, y = `37159`, color = "Rowan"), size = 1) +
  geom_line(data = wayne_ue, aes(x = Year, y = `37191`, color = "Wayne"), size = 1) +
  geom_line(data = durham_ue, aes(x = Year, y = `37063`, color = "Durham"), size = 1) +
  geom_line(data = Chowan_ue, aes(x = Year, y = `37049`, color = "Chowan"), size = 1) +
  geom_vline(xintercept = 2012, linetype = "dashed", color = "black", size = 1) +
  labs(title = "Unemployment in Wayne, Rowan, Durham, and Chowan Counties",
       x = "Year",
       y = "Unemployment Rate (%)",
       color = "Dataset") +
  scale_color_manual(values = c("Rowan" = "blue", "Wayne" = "lightblue", "Durham" = "darkgreen", "Chowan" = "lightgreen")) +
  theme(legend.title = element_blank())

print(combined_plot)
```

Contrary to the initial hypothesis, this regression indicates that for each MW increase in retired nameplate capacity, the unemployment rate unemployment rate in Rowan is expected to decrease by approximately 0.02428 percentage points. The p-value is greater than 0.05, but given that it is only marginally higher (at 0.0619) we can theoretically interpret there to be a weak relationship. It must also be understood that the sample size is small and therefore we would need much more data for any reliable conclusions.

The Multiple R-squared value of 0.5346 represents the proportion of the variance in the response variable (Rowan UE (%)) that can be explained by the predictor variable retired nameplate capacity (MW).

```{r Rowan analysis, echo=FALSE, warning=FALSE, error=FALSE}
#Selecting Rowan only
rowan_data <- generator_retirement_data[generator_retirement_data$FIPS_Code == 37159, ]

#Rename generator retirement year to year in order to combine for analysis
colnames(rowan_data)[colnames(rowan_data) == "GENYRRET"] <- "Year"

#Reformat year in rowan_ue as numeric for merging
rowan_ue$Year <- as.numeric(format(rowan_ue$Year, "%Y"))

#Merge by year
rowan_merged_data <- merge(rowan_data, rowan_ue, by = "Year", all.x = TRUE)


### Data Wrangling ###

#Renaming columnn
names(rowan_ue)[trimws(names(rowan_ue)) == "37159"] <- "Rowan UE (%)"

#Adding nameplate capacity to generator
rowan_generator_retirement_NPACP <- processed_data_20 %>% 
  select(FIPS_Code, GENYRRET, NAMEPCAP_gen) %>%
  filter(FIPS_Code == "37159") %>%  # Filter for Rowan county
  na.omit() %>% #selecting only data with retirements
  rename(Year = GENYRRET)  # Renaming the column

#Merging
rowan_merged_data_NPCAP <- merge(rowan_generator_retirement_NPACP, rowan_ue, by = "Year", all.x = TRUE)

#### Data Analysis ###

#Linear regression
lm_result <- lm(`Rowan UE (%)` ~ NAMEPCAP_gen, data = rowan_merged_data_NPCAP)
# summary(lm_result) 
```


## Summary
The examination of the impact resulting from the retirement of power plant generators failed to produce definitive results; nevertheless, it contributes to the expanding field of advocating for an environmental justice perspective. This research goes beyond the reliance on the reduction of tons of carbon dioxide equivalents in emissions as a measure of the energy transition's success. It underscores the importance of adopting a holistic approach to key performance indicators, particularly given that large power plants are often situated in rural areas where communities heavily depend on utilities for employment. The analytical methodology adheres to best practices, incorporating counties with varying numbers of retirements to control for factors external to the retirements themselves. Additionally, the analysis delves into the actual nameplate capacity of retired assets, recognizing the plausible implication that a smaller capacity may employ fewer individuals compared to a larger plant. Contrary to the initial hypothesis, the findings reveal a statistically significant relationship, wherein each megawatt increase in retired nameplate capacity is associated with a marginal decrease in the unemployment rate. However, the inherent data limitations within this relatively small sample size necessitate cautious interpretation. It is crucial to acknowledge that while this analysis falls short of providing conclusive results, it serves as a foundation for further exploration in subsequent analyses and environmental justice research.

# Question 3: Is there a relationship between power plant distribution and impacts to human health?

Null hypothesis: there is no relationship between power plant distribution and impacts to human health.

Among the emissions types tracked as part of the eGRID data set used in Questions 1 and 2, nitrogen oxides (NOx) and sulfur dioxide merit further exploration, as they form part of criteria air pollutants regulated by EPA. Under the Clean Air Act, US EPA has set National Ambient Air Quality Standards on six criteria air pollutants: particulate matter (PM2.5 and PM10), atmospheric ozone, carbon monoxide, lead, nitrogen dioxide, and sulfur dioxide. These pollutants reach widespread exposure--millions of people--due to their numerous and diverse sources. Causal or likely causal evidence pointing to a variety of negative health endpoints exists for each one of them. 

Power plants have historically made up a major stationary point source of air pollution, including SO2 and NO2, in particular. For nitrogen dioxide (NO2) and sulfur dioxide (SO2), the regulatory emissions standard-setting has been most heavily informed by research on respiratory effects. It should be noted that nitrogen oxides (NOx) also contribute to the formation of atmospheric ozone, which causes respiratory problems. 

The following section of analyses explore relationships between emissions of SO2 and NOx and respiratory effects using eGRID data as well as data from the Environmental Burden and Health Vulnerability modules in the Environmental Justice Index (EJI). The development of the EJI is relatively new and the index has limitations. In accordance with its limitations, which can be found in detail within the technical documentation linked in the Metadata folder, this high-level exploration is not intended to define individuals at risk, represent risk or exposure for a community, or suggest that the markers explored form a full or near-full representation of environmental or health characteristics. This brief exploration merely examines whether a statistically significant relationship can be detected among select local factors such as power plant emissions and human health effects at a point in time across North Carolina. Based on established knowledge regarding air pollution and its impacts to human health, the expectation would be that higher emissions of NOx and SO2 are associated with higher rates of respiratory disease. 

```{r Distribution of Respiratory Illness}

### DEFINITIONS ###

# E_PM = Annual mean days above PM2.5 regulatory standard - 3-year average
# E_DSLPM = Ambient concentrations of diesel PM/m3
# E_OZONE = Annual mean days above O3 regulatory standard - 3-year average
# EP_BPHIGH = Percentage of individuals with Raw high blood pressures values
# EP_ASTHMA = Percentage of individuals with asthma
# PLNOXAN = Plant Annual NOx Emissions (PLNOXAN) – The total annual NOx emissions, in short tons, for the plant. Biogas components are adjusted. For CHP plants, the value is adjusted by the electric allocation factor. This adjusted emissions field is estimated by first making the biogas adjustment (if it exists) and then applying the electric allocation factor (if the plant is a CHP).
# PLSO2AN = Plant Annual SO2 Emissions (PLSO2AN) – The total annual SO2 emissions, in short tons, for the plant. Landfill gas components are adjusted. For CHP plants, the value is adjusted by the electric allocation factor. This adjusted emissions field is estimated by first making the landfill gas adjustment (if it exists) and then applying the electric allocation factor (if the plant is a CHP).
# NOx_emissions = sum of NOx emissions by county across plants
# SO2_emissions = sum of SO2 emissions by county across plants
# NOx_map = map of NOx emissions by county
# NOx_counties_sf_join = attribute of total NOx emissions attached to spatial frame
# SO2_counties_sf_join = attribute of total SO2 emissions attached to spatial frame

#### DATA WRANGLING ####

#Establish shared GEOID format
EJI_countytract$CountyFIPS <- stringr::str_extract(EJI_countytract$GEOID, "^.{5}")

#Get 2021 spatial census data to convert tract GEOID to mapped coordinates
spatial_tracts <- tigris::tracts(state = 37) %>% 
  st_as_sf()
class(spatial_tracts)
st_crs(spatial_tracts) # NAD1983, EPSG 4269

#Join the eGrid attributes to the county spatial features
tracts_EJI_sf_join <-  merge(x = spatial_tracts,
                           y = EJI_countytract, 
                           by.x = 'GEOID', 
                           by.y = 'GEOID' )
#Some EJI tracts did not GEOIDs that matched the spatial tracts

#Select variables of interest
tracts_EJI_sf_select <- tracts_EJI_sf_join %>%
  select(GEOID, CountyFIPS, TRACTCE.x, StateAbbr, COUNTY, E_TOTPOP, M_TOTPOP, 
         E_PM, E_OZONE, E_DSLPM, E_COAL, E_LEAD, EP_UNINSUR, EP_AGE65, 
         EP_ASTHMA, EP_BPHIGH, EP_CANCER, EP_MHLTH, geometry) %>%
  rename(TractCode = TRACTCE.x)

#Map asthma prevalence by tract
Asthma_by_tract_map <- ggplot(data = tracts_EJI_sf_select) +
  geom_sf(data = tracts_EJI_sf_join)+
  geom_sf(aes(fill = EP_ASTHMA)) +
  labs(title = "Estimated Asthma Prevalence by NC Tract",
       subtitle = "2021",
       fill = "Percentage of Individuals with Asthma")
print(tracts_map)
```



```{r Power Plant Data by Tract}

#Check coordinates of plant geometry (point) data
st_crs(plant_gen_sf$geometry) # NAD1983, EPSG 4269

#Match coordinates of plants_NC to tract geometry
#plants_within_tracts <- plant_gen_sf[tracts_EJI_sf_select,]
tracts_containing_plants <- tracts_EJI_sf_select[plant_gen_sf,]

#Map of plants across NC tracts, shown over NC tract boundaries 
mapview(spatial_tracts, col.regions='pink', layer.name = 'North Carolina Tracts') + 
 mapview(plants_within_tracts,
          layer.name = 'Plants Within Each Tract',
          alpha=.5)

#Map of just NC tracts that contain power plants
mapview(spatial_tracts, col.regions='grey', layer.name = 'North Carolina Tracts') + 
  mapview(tracts_containing_plants, col.regions=, layer.name = 'NC Tracts Containing Power Plants')

#Zoom in on tracts within one county: Robeson, the county with highest total number of existing plants in 2021
#Filter for Robeson tracts
Robeson_tracts <- tracts_EJI_sf_select %>%
  filter(COUNTY == "Robeson")
#Filter for Robeson plants
tract_plants_Robeson <- filter(plants_within_tracts, CNTYNAME == "Robeson")

#Show plants within Robeson tracts, specifically
mapview(Robeson_tracts, col.regions='pink', 
        layer.name = 'Robeson County Tracts, NC') +
 mapview(tract_plants_Robeson,
          layer.name = 'Plants Within Each Tract',
          alpha=.5)

#Convert NC eGrid tabular county data to spatial data
plants_NC_sf <- Plant_NC %>% st_as_sf(coords = c('LON','LAT'), crs=4269)

#Table of plant data with the tract that corresponds to each plant
intersection_plants_EJI <- st_intersection(plants_NC_sf, tracts_EJI_sf_select)

#Exporting to CSV:
#write.csv(intersect_plants_EJI,'Data/Processed/EBM_Processed.csv', row.names=FALSE)
```


```{r Relationship between Asthma Prevalence and Power Plant Count}
##Visualize the relationship between asthma prevalence and number of power plants per tract ##

#Power plant count
plantcount_per_tract <- intersection_plants_EJI %>%
  group_by(GEOID) %>%
  summarise(plantcount = n())

#Asthma prevalence by tract
HealthImpacts_by_tract <- intersection_plants_EJI %>% 
  select(GEOID, EP_ASTHMA, EP_BPHIGH) %>%
  st_drop_geometry()
class(HealthImpacts_by_tract)

#Join plant count and 
join_HealthImpacts_plantcount <- merge(HealthImpacts_by_tract, plantcount_per_tract, 
                                    by = "GEOID")
#Remove duplicates
join_HealthImpacts_plantcount <- distinct(join_HealthImpacts_plantcount, GEOID, .keep_all = TRUE)

#Check normal distributions of continuous variables
qqnorm(join_HealthImpacts_plantcount$EP_ASTHMA); qqline(join_HealthImpacts_plantcount$EP_ASTHMA)
qqnorm(join_HealthImpacts_plantcount$EP_BPHIGH); qqline(join_HealthImpacts_plantcount$EP_BPHIGH)
#The data does not follow a normal distribution

#Bartlett's test checks null hyp that the variance in each of the groups are the same. We want to run this because ANOVA is robust against departures from equal variance, however, if the test result is false, we can still run ANOVA. Can't use bc each group must have at least two observations.

Asthma_plantcount_lm <- lm(data = join_HealthImpacts_plantcount, EP_ASTHMA ~ plantcount)
summary(Asthma_plantcount_lm)

Asthma_plantcount_plot <- ggplot(join_HealthImpacts_plantcount, 
                          aes(x = plantcount, y = EP_ASTHMA)) +
      geom_point() +
      ggtitle("Test") + 
      labs(x="Number of Plants in Tract",
           y="Percentage of Tract with Asthma (%)")
print(Asthma_plantcount_plot)
```


```{r Relationship between Asthma Prevalence and Health Insurance Status}
##Visualize the relationship between asthma prevalence and health insurance status ##
Asthma_uninsur_plot <- ggplot(intersect_plants_tracts, 
                          aes(x=EP_ASTHMA, y=EP_UNINSUR)) +
      geom_point() +
      geom_smooth(method = lm, color = "black") +
      ggtitle("Relationship between Percentage without Health Insurance and Asthma Prevalence") + 
      labs(x="Percentage of Population with Asthma (%)",
           y="Percentage of Population without Health Insurance (%)")
print(Asthma_uninsur_plot)
```

```{r Relationship between NOx Emissions and SO2 Emissions}

## Might plants those plants that emit high levels of NOx overlap with those that emit high levels of SO2? ## 
NOx_SO2_plot <- ggplot(intersect_plants_tracts, 
                          aes(x=PLNOXAN, y=PLSO2AN)) +
  geom_point() +
  # adjusting axes to hide extreme values
  xlim(0, 800) +
  ylim(0,600) +
  # finding a line of best fit
  geom_smooth(method = lm, color = "black") +
  ggtitle("Relationship between NOx and SO2 Emissions") + 
  labs(x="Plant Annual NOx Emissions (tn)", y="SO2")
print(NOx_SO2_plot)

SO2_NOx_lm <- lm(data = intersect_plants_tracts, PLSO2AN ~ PLNOXAN)
summary(SO2_NOx_lm)
# Residuals range from -491.27 to 1260.12
# Intercept is 0.46503 so there is a positive relationship which means when NOx increase, SO2 tend to increase as well. p-value: < 2.2e-16 which is <.05, therefore it is worthwhile to try to estimate SO2 based on depth information. Although the residual standard error is 238.7 on 199 degrees of freedom, the R-squared value of 0.8274 shows that NOx emissions explain around 82.74% of the variability of SO2 emissions. 
plot(SO2_NOx_lm)
cor.test(intersect_plants_tracts$PLSO2AN, intersect_plants_tracts$PLNOXAN)
# The correlation test returns a correlation strength of 0.9096, which signifies a strong correlation between NOx emissions and SO2 emissions. In summary, there is a strong positive correlation.  
```

```{r Other Exploratory Regression Analyses}

## Visualize the relationship between NOx and Asthma ##
NOx_asthma_plot <- ggplot(intersect_plants_tracts, 
                          aes(x=PLNOXAN, y=EP_ASTHMA,
                              color = PLFUELCT)) +
  geom_point() +
  # adjusting axes to hide extreme values
  xlim(0, 4000) +
  # ylim(0,35) +
  # finding a line of best fit
  geom_smooth(method = lm, color = "black") +
  ggtitle("Prevalence of Asthma  by Depth (meters)") + 
  labs(x="NOx Emissions from Power Plants in Tract (tn)", y="Percentage of Population with Asthma (%)")
print(NOx_asthma_plot)
# unclear relationship when all power plants are included

#Filter for Gas, Biomass, Oil, Coal
ff_intersect_plants_tracts <- intersect_plants_tracts %>%
  filter(PLFUELCT %in% c("GAS", "OIL", "COAL", "BIOMASS"))

## Visualize the relationship between NOx and Asthma  ##
NOx_asthma_ff_plot <- ggplot(ff_intersect_plants_tracts, 
                          aes(x=PLNOXAN, y=EP_ASTHMA,
                              color = PLFUELCT)) +
  geom_point() +
  # adjusting axes to hide extreme values
   xlim(0, 1000) +
  # ylim(0,35) +
  # finding a line of best fit
  geom_smooth(method = lm, color = "black") +
  ggtitle("Prevalence of Asthma in Relation to NOx Emissions") + 
  labs(x="NOx Emissions from Power Plants in Tract (tn)", y="Percentage of Population with Asthma (%)")
print(NOx_asthma_ff_plot)

drop_intersect_plants_tracts <- intersect_plants_tracts %>%
  drop_na(EP_ASTHMA, PLFUELCT, PLNOXAN, PLSO2AN, E_PM, E_DSLPM, E_OZONE)

## Multiple Regression Analysis ##
#Running Akaike's Information Criterion to determine what set of explanatory variables might be best suited to explain asthma prevalence.
Asthma_AIC <- lm(data = drop_intersect_plants_tracts, EP_ASTHMA ~ 
                           PLFUELCT + PLNOXAN + PLSO2AN + 
                           E_PM + E_DSLPM + E_OZONE)
# Choosing a model by AIC in a Stepwise Algorithm
step(Asthma_AIC)
# Starting AIC is -15.48
# From the original, full regression, removing PLSO2AN reduces AIC to -17.4763--it is the most important variable to remove, since a lower AIC is desirable. After removing PLSO2AN to obtain an AIC of -17.48, the next best move would be to remove PLNOXAN, returning an AIC of -19.4554. From there, the last variable to remove would be E_DSLPM, which would further reduce AIC to -19.5518. Removal of each of these variables would make for a better regression than the full, starting regression. Removing E_PM, PLFUELCT, or E_OZONE would make the model worse, as the removal of each increases the AIC from its starting value (increasing AIC to -10.3231, -8.4663, and 7.1690, respectively). Given the 6 starting explanatory variables, the best regression available is to consider PLFUELTCT, E_PM, and E_OZONE. 

#Run regression with the three optimal explanatory variables
Asthma_AIC_opt <- lm(data = drop_intersect_plants_tracts, EP_ASTHMA ~ 
                           PLFUELCT + E_PM + E_OZONE)
summary(Asthma_AIC_opt)
# Multiple R-squared 0.2169 so only 21.69% of the variability on asthma prevalence across tracsts is due to EPM, EOZONE, and PFUEL. Adjusted R-squared 0.1927. p-value is 1.235e-08 so < .05, therefore the relationship among the variable is significantly different than zero. 194 degrees of freedom with residual standard error of 0.9364. Increasing the number of variables in the model should reduce the degrees of freedom.

#Plot relationship between ozone and asthma prevalence
Ozone_asthma_plot <- ggplot(subset(drop_intersect_plants_tracts, COUNTY="Robeson"), 
                          aes(x=E_OZONE, y=EP_ASTHMA)) +
  geom_point() +
  # adjusting axes to hide extreme values
  # xlim(0, 1000) +
  # ylim(0,35) +
  # finding a line of best fit
  geom_smooth(method = lm, color = "black") +
  ggtitle("Prevalence of Asthma") + 
  labs(x="Annual mean days above O3 regulatory standard", y="Percentage of Population with Asthma (%)")
print(Ozone_asthma_plot)

# PLNOXAN ~ Asthma
NOx_asthma_lm <- lm(EP_ASTHMA ~ PLNOXAN, data = intersect_plants_tracts)
summary(NOx_asthma_lm)
# p-value < .05 (p-value = .004137) 
# we can reject the null hypothesis that there is no statistically significant relationship between asthma prevalence and NOx emitted from power plants
# 199 degrees of freedom
# residual standard error of 1.023
cor.test(intersect_plants_tracts$EP_ASTHMA, intersect_plants_tracts$PLNOXAN)
# -0.20 signifies a negative correlation, but 
# a weak correlation between the two variables
plot(NOx_asthma_lm)

namepcap_healtheff <- lm(Sum_NAMEPCAP ~ EP_BPHIGH + EP_ASTHMA + E_PM + E_DSLPM + E_OZONE, data = EBM_nameplate_merge)
step(namepcap_healtheff)
#Keep only EP_ASTHMA (AIC = 34593) because all other variables increase AIC
knitr::kable(summary(namepcap_healtheff)$coef, format = "html", caption = "Linear Regression Results - Nameplate Capacity and Air Quality")

namepcap_asthma <- lm(data = EBM_nameplate_merge, Sum_NAMEPCAP ~ EP_ASTHMA)
summary(namepcap_asthma)
plot(namepcap_asthma)

#Run simple regression
capacity_income_model <- lm(NAMEPCAP_plant ~ MEDHHINC_2021, data = merged_data_capacity)

knitr::kable(summary(capacity_income_model)$coef, format = "html", caption = "Linear Regression Results - Namepate Capacity")

#To what extent does high PM exposure explain asthma in NC 
PM_asthma_lm<- lm(data = EBM_countytract, EP_ASTHMA ~ E_PM)
summary(PM_asthma_lm)
# p-value < 0.05
# the R-squared value of .0097 signifies that elevated PM concentrations only explain less than 1% of the variability in asthma in NC tracts
cor.test(EBM_countytract$EP_ASTHMA, EBM_countytract$E_PM)
# -.098 signifies a negative and significant but not super strong correlation

#To what extent does high PM exposure explain high blood pressure in NC 
PM_bphigh_lm<- lm(data = EBM_countytract, EP_BPHIGH ~ E_PM)
summary(PM_bphigh_lm)
# p-value < 0.05
# the R-squared value of .0927 signifies that elevated PM concentrations explain 9.27% of the variability in high blood pressure in NC tracts
cor.test(EBM_countytract$EP_BPHIGH, EBM_countytract$E_PM)
# -0.30 signifies a negative and significant but not super strong correlation

#Multiple regression looking at whether coal proximity, PM, and ozone might explain high blood pressure
EBM_highbp_lm <- lm(EP_BPHIGH ~ E_PM + E_DSLPM + E_OZONE, data=EBM_countytract)
step(EBM_highbp_lm)

#Multiple regression looking at whether coal proximity, PM, and ozone might explain asthma
EBM_asthma_lm <- lm(EP_ASTHMA ~ E_PM + E_DSLPM + E_OZONE, data=EBM_countytract)
step(EBM_asthma_lm)

#Run the multiple regression to determine whether there is a relationship
EBM_multivar_lm <- lm(EP_UNINSUR ~ EP_ASTHMA + EP_BPHIGH + E_IMPWTR + 
                        E_COAL + E_PM + E_OZONE,
                        data=EBM_countytract)
step(EBM_multivar_lm)

EBM_lead_wtr_lm <- lm(EP_UNINSUR ~ E_IMPWTR + 
                        E_PM,
                        data=EBM_countytract)
step(EBM_lead_wtr_lm)
#Summarize the multiple regression
summary(EBM_multivar_lm)
```
## Summary
This study used data from CDC's Environmental Burden piece of its Environmental Justice Index to test the hypothesis that greater presence of power plants in a county is correlated with elevated NOx and SOx levels in that county, and consequently more respiratory and cardiovascular problems in comparison to those counties with fewer power plants.
- Results 
- Expect that in the 2020s, NO2 and SO2 emissions would be showing effects of decades of regulation / technologies used to decrease NO2 emissions (changing temperature of combustion in power plants to reduce their formation) and SO2 (touch on atmospheric deposition)

While the Clean Air Act and its various amendments have been in effect for decades, its effectiveness in reducing air pollution in the U.S. by way of regulating emissions of criteria air pollutants has varied over time and varied by pollutant. Air pollution continues to affect millions in the United States. 
- Future tracking of PM in eGRID
- PM currently regulated based on particle size
- Hypothesis that PM associated with coal-fired power plants has higher toxicity than general particulate matter https://www.science.org/doi/10.1126/science.adf4915 


# References
*Supporting the nation’s coal workers and communities in a changing energy landscape. Union of Concerned Scientists. (2021).https://www.ucsusa.org/resources/support-coal-workers#read-online-content 

*United States Environmental Protection Agency (EPA). 2023. “Emissions & Generation Resource Integrated Database (eGRID), 2021” Washington, DC: Office of Atmospheric Protection, Clean Air Markets Division. Available from EPA’s eGRID web site: https://www.epa.gov/egrid. Accessed on 11/1/2023.

*United States Census Bureau. Cartographic Boundary Files - Shapefile. 2018 County. https://www.census.gov/geographies/mapping-files/time-series/geo/carto-boundary-file.html. Accessed on 11/15/2023.

*United States Department of Agriculture / Economic Research Service. Poverty estimates for the U.S., States, and counties, 2021. https://www.ers.usda.gov/data-products/county-level-data-sets/county-level-data-sets-download-data/. Accessed on 11/1/2023.

*United States Department of Agriculture / Economic Research Service. Unemployment and median household income for the U.S., States, and counties, 2000–22. https://www.ers.usda.gov/data-products/county-level-data-sets/county-level-data-sets-download-data/. Accessed on 11/1/2023.

*Centers for Disease Control and Prevention and Agency for Toxic Substances Disease Registry/ Geospatial Research, Analysis, and Services Program. CDC/ATSDR Social Vulnerability Index 2020. Database North Carolina. https://www.atsdr.cdc.gov/placeandhealth/svi/data_documentation_download.html. Accessed on 12/6/2023.

*Centers for Disease Control and Prevention and Agency for Toxic Substances Disease Registry. 2022 Environmental Justice Index. https://www.atsdr.cdc.gov/placeandhealth/eji/index.html. Accessed on 12/5/2023.

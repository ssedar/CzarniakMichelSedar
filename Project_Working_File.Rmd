----
title: "EDE Group Project"
author: "Gaby Czarniak, Mara Michel, Sam Sedar"
date: "2023-11-14"
output: html_document
---
# Research Rationale
### The impetus behind this research lies in the imperative to address the intricate interplay between socioeconomic factors and the power plants. As the global energy landscape undergoes a transformative shift towards sustainability, it becomes paramount to understand how these changes might impact communities, particularly those situated in lower-income communities. The socio-spatial lens through which this study is conducted aims to unearth patterns of power plant distribution across North Carolina. The overarching question is whether certain communities bear a disproportionate burden of environmentally impactful energy sources, framing the discourse within the realms of environmental justice and equity.

### As a key aspect of this exploration, the research considers various socioeconomic indicators, including but not limited to unemployment rates. This is motivated by a concern and eye for environmental justice, as power plants have often served as major employers in low income areas. This research extends its focus beyond energy sources to examine the broader impacts of power plants on health, social vulnerability, and scrutinizes disparities in pollution exposure and associated health risks. Through a comprehensive exploration, encompassing various socioeconomic indicators, this research contributes to a nuanced understanding of the multifaceted impacts of power plants.


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)
library(lubridate)
library(here); here()
library(rvest)
library(cowplot)
library(agricolae)
library(dplyr)
library(tidyverse)
library(lubridate)
library(trend)
library(zoo) 
library(Kendall)
library(tseries)
library(sf)
library(leaflet)
library(tseries)
library(knitr)
library(mapview); mapviewOptions(fgb = FALSE)
knitr::opts_chunk$set (warning = FALSE, echo = FALSE)
getwd()
```


```{r, Data_Load, echo=FALSE, warning=FALSE, error= FALSE}

#Loading Data into Raw Data folder

plant <- read.csv(here('Data/Raw/PLNT21.csv'),
                  stringsAsFactors = FALSE, skip = 1, 
                  colClasses = c('FIPSST' = 'character', 
                                 'FIPSCNTY' = 'character',
                                 'ORISPL' = 'character'))

gen <- read.csv(here('Data/Raw/GEN21.csv'), 
                stringsAsFactors = FALSE, skip = 1, 
                  colClasses = c('ORISPL' = 'character'))

gen20 <- read.csv(here('Data/Raw/GEN20.csv'),                 
                  stringsAsFactors = FALSE, skip = 1, 
                  colClasses = c('ORISPL' = 'character'))

income <- read.csv(here('Data/Raw/PovertyEstimates.csv'), 
                  stringsAsFactors = TRUE, skip = 4)

unemployment <- read.csv(here('Data/Raw/Unemployment.csv'), 
                  stringsAsFactors = TRUE, skip = 4)

SVI_county <-read.csv(here('Data/Raw/SVI_NorthCarolina_county.csv'),
                  stringsAsFactors = TRUE)

EBM_countytract <-read.csv(here('Data/Raw/EBM_NorthCarolina.csv'),
                  stringsAsFactors = TRUE)

SVI_2018_tract <-read.csv(here('Data/Raw/SVI2018_NorthCarolina.csv'),
                  stringsAsFactors = TRUE)
```

# Data Wrangling
### The intial step in our research, once loaded, was data wrangling on the three distinct datasets: eGRID, unemployment, and income data. For the eGRID dataset, the code selects specific columns related to power plant information in North Carolina, converts certain columns to numeric format, and then combines the generator and plant data based on a common identifier. Duplicate columns are removed, resulting in the plant_gen_data dataframe. The code then proceeds to handle the unemployment dataset, selecting relevant columns covering the years 2002-2022 and merging it with the plant_gen_data dataframe using the FIPS code as a key. Similarly, the income dataset is processed by selecting specific columns, and the final step involves merging this income data with the previously created dataframe. The resulting dataset, named processed_data, contains information on power plants, unemployment rates, and income data, and the column names are displayed at the end of the code.


```{r, echo=FALSE, warning=FALSE, error=FALSE}
######  DATA WRANGLING - BASELINE  ######

#EGRID DATA

#Selecting columns of interest from plant data
plant_select <- plant %>%
  select(PSTATABB, ORISPL, FIPSST, FIPSCNTY, PLFUELCT, NAMEPCAP,
         PLNGENAN,PLSO2RTA, PLCO2RTA, PLCH4RTA, PLN2ORTA, PLCO2AN, PLN2OAN,PLNOXAN,
         PLSO2AN,PLCH4AN, CNTYNAME, LAT,
         LON, COALFLAG) %>%
  filter(PSTATABB == "NC") %>%
  unite(FIPS_Code, FIPSST, FIPSCNTY, sep = "")

plant_select$PLNGENAN <- as.numeric(plant_select$PLNGENAN)
plant_select$PLCO2RTA <- as.numeric(plant_select$PLCO2RTA)
plant_select$PLCO2AN <- as.numeric(plant_select$PLCO2AN)
plant_select$NAMEPCAP <- as.numeric(plant_select$NAMEPCAP)


#Combining Generator and Plant df based on ORISPL
plant_gen <- gen %>%
  inner_join(plant_select, by = 'ORISPL', 
             suffix = c("_gen", "_plant"))

plant_gen$CFACT <- as.numeric(plant_gen$CFACT)
plant_gen$GENNTOZ <- as.numeric(plant_gen$GENNTOZ)
plant_gen$NAMEPCAP_gen <- as.numeric(plant_gen$NAMEPCAP_gen)
plant_gen$GENNTAN <- as.numeric(plant_gen$GENNTAN)

#Removing duplicate state abbreviation column
plant_gen_data <- plant_gen[, -which(names(plant_gen) == "PSTATABB_plant")]


#UNEMPLOYMENT DATA

#Selecting columns of interest: unemployment rates: 2002-2022

ue <- unemployment %>%
  select(FIPS_Code,	Unemployment_rate_2000,	Unemployment_rate_2001,	Unemployment_rate_2002,	Unemployment_rate_2003,	Unemployment_rate_2004,	Unemployment_rate_2005,	Unemployment_rate_2006,	Unemployment_rate_2007,	Unemployment_rate_2008,	Unemployment_rate_2009,	Unemployment_rate_2010,	Unemployment_rate_2011,	Unemployment_rate_2012,	Unemployment_rate_2013,	Unemployment_rate_2014,	Unemployment_rate_2015,	Unemployment_rate_2016,	Unemployment_rate_2017,	Unemployment_rate_2018,	Unemployment_rate_2019,	Unemployment_rate_2020,	Unemployment_rate_2021,	Unemployment_rate_2022)

#Merging with eGrid
ue_egrid <- merge(plant_gen_data, ue, by = "FIPS_Code")


#INCOME DATA

#Selecting columns of interest: 
inc <- income %>%
  select(FIPS_Code, PCTPOVALL_2021, MEDHHINC_2021)

#Merging
processed_data <- merge(ue_egrid, inc, by = "FIPS_Code")



```

# Exploratory Analysis
### This analysis then initiates data exploration and visualization for the processed_data dataframe, focusing on fuel types, income, and electricity generation in North Carolina. The summary(processed_data) provides a general overview of the dataset. The code then generates a pie chart to illustrate the percentage makeup of primary fuel types in North Carolina based on total annual generation. Subsequently, scatter plots depict the relationship between median household income and total plant annual generation, with points colored by fuel type. The analysis further drills down to scatter plots excluding nuclear data and for a selected set of fuel types (COAL, SOLAR, OIL, WIND, GAS). Additionally, stacked bar plots visualize the total annual generation by fuel type and county, and for better clarity, separate plots are created for the top 10 and bottom 10 counties based on median household income. These visualizations help explore and understand the relationships between fuel types, income levels, and electricity generation in different counties of North Carolina.

```{r, Exploration, echo=FALSE, warning=FALSE, error=FALSE}

########### DATA EXPLORATION - FUEL TYPES ###########

#NC Breakdown of Fuel by Category
fuel_summarized <- processed_data %>%
  group_by(PLFUELCT) %>%
  summarise(total_generation = sum(PLNGENAN, na.rm = TRUE))


#In percentages
fuel_summarized$percentage <- fuel_summarized$total_generation / sum(fuel_summarized$total_generation) * 100

#Pie chart with percent makeup of fuel in  NC
pie_chart_percentage <- ggplot(fuel_summarized, aes(x = "", fill = PLFUELCT, y = percentage)) +
  geom_bar(width = 1, stat = "identity") +
  coord_polar(theta = "y") +
  labs(
    title = "North Carolina Primary Fuel (% of Total Annual Generation)",
    fill = "Primary Fuel Type",
    y = "Percentage of Total Generation (%)",
    x = NULL)
print(pie_chart_percentage)
```

##### Figure 1: Pie chart illustrating the percentage distribution of primary fuel types in North Carolina based on total annual generation. 


```{r, income_type, echo=FALSE, warning=FALSE, error=FALSE}
#Relationship between income and fuel type
processed_data$MEDHHINC_2021 <- as.numeric(processed_data$MEDHHINC_2021)

#Scatter visualization
scatter_income_generation <- ggplot(processed_data, aes(x = MEDHHINC_2021, y = PLNGENAN, color = PLFUELCT)) +
  geom_point() +
  labs(title = "Income and Annual Generation by Fuel Type",
       x = "Median Household Income ($)",
       y = "Total Plant Annual Generation (MWh)",
       color = "Fuel Type",
caption = "")
print(scatter_income_generation)
```

##### Figure 2: Scatter plot illustrating the correlation between median household income and total annual generation, color-coded by fuel type. Owing to the unique characteristics of nuclear power plants, operating at significantly higher capacity factors than other sources, the plot lacks a discernible relationship, prompting necessary adjustments. 


```{r, ex_nuclear, echo=FALSE, warning=FALSE, error=FALSE}
#Scatter ex-nuclear
scatter_income_generation_ex_nuc <- ggplot(subset(processed_data, PLFUELCT != "NUCLEAR"), 
                                     aes(x = MEDHHINC_2021, y = PLNGENAN, color = PLFUELCT)) +
  geom_point() +
  labs(title = "Relationship Between Annual Generation, Fuel Type, and Income",
       x = "Median Household Income ($)",
       y = "Total Plant Annual Generation (MWh)",
       color = "Fuel Type")
print(scatter_income_generation_ex_nuc)

```

##### Figure 3: Exploring energy patterns, this scatter plot analyzes the connection between median household income and total annual generation, excluding nuclear energy. The updated chart reveals a potential trend, especially around the $70,000 median income mark, where data points for generation are sparse.

```{r, select, echo=FALSE, warning=FALSE, error=FALSE}

selected_fuel_data <- subset(processed_data, PLFUELCT %in% c("COAL", "SOLAR", "OIL", "WIND", "GAS"))

# Scatter plot for selected fuel types
scatter_income_generation_selected <- ggplot(selected_fuel_data, 
                                              aes(x = MEDHHINC_2021, y = PLNGENAN, color = PLFUELCT)) +
  geom_point() +
  labs(title = "Relationship Between Annual Generation, Fuel Type, and Income",
       x = "Median Household Income ($)",
       y = "Total Plant Annual Generation (MWh)",
       color = "Fuel Type")
print(scatter_income_generation_selected)

```

##### Figure 4: To narrow our exploration further, we selected key energy sources: coal, gas, oil, wind, and solar.

```{r, top10, echo=FALSE, warning=FALSE, error=FALSE}
#Top 10 counties based on median household income
top_income_counties <- processed_data %>%
  group_by(CNTYNAME) %>%
  summarize(median_income = median(MEDHHINC_2021, na.rm = TRUE)) %>%
  top_n(10, median_income) %>%
  pull(CNTYNAME)

filtered_data_income <- processed_data %>%
  filter(CNTYNAME %in% top_income_counties)

#Stacked bar plot
stacked_barplot_top_income_counties <- ggplot(filtered_data_income, aes(x = CNTYNAME, y = PLNGENAN, fill = PLFUELCT)) +
  geom_bar(stat = "sum", position = "stack") +
  labs(title = "Total Annual Generation by Fuel Type and County (Top 10 by Median Income)",
       x = "County",
       y = "Total Plant Annual Generation (MWh)",
       fill = "Fuel Type") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
print(stacked_barplot_top_income_counties)
```


##### Figure 5: Stacked bar plot illustrating the total annual generation by fuel type in the top 10 counties (by median income) in North Carolina by income.

```{r, bottom10, echo=FALSE, warning=FALSE, error=FALSE}
#Bottom 10 counties based on median household income
bottom_income_counties <- processed_data %>%
  group_by(CNTYNAME) %>%
  summarize(median_income = median(MEDHHINC_2021, na.rm = TRUE)) %>%
  arrange(median_income) %>%
  slice_head(n = 10) %>%
  pull(CNTYNAME)

filtered_data_bottom_income <- processed_data %>%
  filter(CNTYNAME %in% bottom_income_counties)

#Stacked bar plot
stacked_barplot_bottom_income_counties <- ggplot(filtered_data_bottom_income, aes(x = CNTYNAME, y = PLNGENAN, fill = PLFUELCT)) +
  geom_bar(stat = "sum", position = "stack") +
  labs(title = "Total Annual Generation by Fuel Type and County (Bottom 10 by Median Income)",
       x = "County",
       y = "Total Plant Annual Generation (MWh)",
       fill = "Fuel Type") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
print(stacked_barplot_bottom_income_counties)
```

##### Figure 6: To get a balanced view of the total annual generation by fuel type and county, we then show the bottom 10 counties (by median income) in North Carolina. This identified Richmond county as a county of interest.


#Question 1: How does income impact power plant characteristics at the county level?
##### This analysis begins by examining the impact that income has on various power plant characteristics. This first analysis uses income as the highest-level socioeconomic indicator, as income often dictates an array of follow-on indicators. Several regresions are conducted including the impact of income on the fuel type (differentiating between clean and dirty sources), number of plants, and nameplate capacity. 

```{r, Income_and_Fuel, echo=FALSE, warning=FALSE, error=FALSE}

########### DATA ANALYSIS - INCOME AND FUEL TYPE ###########

#Coal linear regression
coal_data <- subset(processed_data, PLFUELCT == "COAL")
linear_model_coal <- lm(PLNGENAN ~ MEDHHINC_2021, data = coal_data)
summary_table <- summary(linear_model_coal)$coef

knitr::kable(summary(linear_model_coal)$coef, format = "html", caption = "Linear Regression Results - Coal")

#Visualize relationship
scatter_coal <- ggplot(coal_data, aes(x = MEDHHINC_2021, y = PLNGENAN)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, color = "blue") +
  labs(title = "County Income and Coal Generation",
       x = "Median Household Income ($)",
       y = "Coal Generation (MWh)")
print(scatter_coal)
```

##### The estimated coefficient is approximately -134.6. This suggests that for each one-unit increase in income, the predicted value of coal generation decreases by approximately 134.6 MWh. The coefficient's p-value (0.1049) is greater than 0.05, indicating that it is not statistically significant at the 0.05 significance level. However, the R^2 suggests that only about 13.24% of the variability in coal generation is explained by income.

```{r, solar, echo=FALSE, warning=FALSE, error=FALSE}


#Solar linear regression
solar_data <- subset(processed_data, PLFUELCT == "SOLAR")
linear_model_solar <- lm(PLNGENAN ~ MEDHHINC_2021, data = solar_data)
summary(linear_model_solar) 

knitr::kable(summary(linear_model_solar)$coef, format = "html", caption = "Linear Regression Results - Solar")

#Visualize relationship
scatter_solar <- ggplot(solar_data, aes(x = MEDHHINC_2021, y = PLNGENAN)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, color = "blue") +
  labs(title = "County Income and Solar Generation",
       x = "Median Household Income ($)",
       y = "Solar Generation (MWh)")
print(scatter_solar)
```

##### The linear regression suggests that there might be a relationship between income and solar generation. The statistically significant coefficient indicates that there is evidence to suggest that an increase in median household income is associated with a decrease in the predicted value of solar generation However, it's important to note that the explained variance is relatively low (about 0.56%), and other factors not included in the model may contribute to the variability in generation for solar.

```{r, viz_solar, echo=FALSE, warning=FALSE, error=FALSE}


################ DATA ANALYSIS: INCOME AND POWER PLANTS ####################

#Regression on Income and the Number of Power Plants

### Pre-Analysis Wrangling ###
online_plants <- processed_data %>%
  drop_na(GENYRONL) %>%
  select(FIPS_Code, CNTYNAME, SEQGEN, YEAR, PNAME, 
         GENID, GENSTAT, GENYRONL, NAMEPCAP_plant, 
         PLNGENAN, PLCO2AN, COALFLAG, MEDHHINC_2021,	
         Unemployment_rate_2000,	Unemployment_rate_2001,	
         Unemployment_rate_2002,	Unemployment_rate_2003,	
         Unemployment_rate_2004,	Unemployment_rate_2005,	
         Unemployment_rate_2006,	Unemployment_rate_2007,	
         Unemployment_rate_2008,	Unemployment_rate_2009,	
         Unemployment_rate_2010,	Unemployment_rate_2011,	
         Unemployment_rate_2012,	Unemployment_rate_2013,	
         Unemployment_rate_2014,	Unemployment_rate_2015,	
         Unemployment_rate_2016,	Unemployment_rate_2017,	
         Unemployment_rate_2018,	Unemployment_rate_2019,	
         Unemployment_rate_2020,	Unemployment_rate_2021,	
         Unemployment_rate_2022)

# Creating separate df with plants by FIPS_Code
county_plants_table <- table(online_plants$FIPS_Code)
view(county_plants_table)
county_plants_df <- as.data.frame(county_plants_table)

#Renaming columnnames
colnames(county_plants_df)[colnames(county_plants_df) == "Var1"] <- "FIPS_Code"
colnames(county_plants_df)[colnames(county_plants_df) == "Freq"] <- "Num_Plants"
#add in income data
merged_data <- merge(county_plants_df, income[, c("FIPS_Code", "MEDHHINC_2021")], by = "FIPS_Code", all.x = TRUE)
# Merge back to original
county_plants_df <- merged_data

### Regression Analysis ###

#Run simple regression
inc_plants_model <- lm(Num_Plants ~ MEDHHINC_2021, data = county_plants_df)

knitr::kable(summary(inc_plants_model)$coef, format = "html", caption = "Linear Regression Results - Number of Plants")

#Plot relationship
ggplot(county_plants_df, aes(x = MEDHHINC_2021, y = Num_Plants)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  labs(title = "County Income and Number of Power Plants",
       x = "Median Household Income",
       y = "Number of Power Plants")
```

##### The linear regression results indicate that median household income does not show a statistically significant association with the number of plants. The coefficient is estimated to be -0.0000786, with a standard error of 0.0000922, a t-value of -0.85, and a p-value of 0.3962. This suggests that, based on the available data, changes in median household income do not appear to be statistically linked to variations in the number of plants.


```{r, npcap, echo=FALSE, warning=FALSE, error=FALSE}
#Regression on Income and Nameplate Capacity

## Pre-Analysis Wrangling ##

#Calculate average nameplate capacity by county
average_capacity <- aggregate(NAMEPCAP_plant ~ FIPS_Code, data = online_plants, FUN = mean)
merged_data_capacity <- merge(average_capacity, income, by = "FIPS_Code")

## Regression Analysis ##

#Run simple regression
capacity_income_model <- lm(NAMEPCAP_plant ~ MEDHHINC_2021, data = merged_data_capacity)

knitr::kable(summary(capacity_income_model)$coef, format = "html", caption = "Linear Regression Results - Namepate Capacity")

#Plot relationship
ggplot(merged_data_capacity, aes(x = MEDHHINC_2021, y = NAMEPCAP_plant)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  labs(title = "County Income and Nameplate",
       x = "Median Household Income",
       y = "Average Nameplate Capacity")

```

##### The linear regression yields a coefficient of 0.0019239, accompanied by a standard error of 0.0023465. This implies that, theoretically, an increase in median household income is associated with a slight corresponding increase in Nameplate Capacity. However, the non-significant p-value of 0.4145 means we do not have sufficient evidence to reject the null hypothesis and the observed association between median household income and Nameplate Capacity may be coincidental.




```{r Generation and SVI Relationship Analysis}
#Calculate sum of generation by county
Total_Generation_County <-plant_gen_data %>%
  group_by(CNTYNAME)%>%
  summarize(Total_Generation = sum(PLNGENAN))

#Merge SVI and total generation by county data
Generation_SVI <-merge(x = Total_Generation_County,
                           y = SVI_county, 
                           by.x = 'CNTYNAME', 
                           by.y = 'COUNTY' )

#Run regression to determine if there is a relationship
Generation_County_lm <- lm(Total_Generation ~ RPL_THEMES, data=Generation_SVI)

#Summary shows no relationship at the county level
summary(Generation_County_lm)

#Visualize the linear regression
tract_generation_SVI_plot <- ggplot(Generation_SVI, 
                                    aes(x = Total_Generation, 
                                        y = RPL_THEMES)) +
  geom_point()+ylim(0,1)+
  stat_smooth(method = "lm", col = "red")+labs(Y='Overall SVI Value', X='Total Generation in 2021 (mWh)',title= 
"Total Power Plant Generation and SVI by county",caption="The chart above shows the relationship between the Social Vulnerability Index (SVI) and 2021 annual generation across all power plants in a county.")
print(tract_generation_SVI_plot) 


```


```{r Heat Maps}
## Heat map of Income Data by County ##
#Create data frame of NC income data
income_NC <-income %>% 
  filter(Stabr=='NC')

#Join the income attributes to the county spatial features
income_NC_sf_join <-  merge(x = counties_sf,
                           y = income_NC, 
                           by.x = 'GEOID', 
                           by.y = 'FIPS_Code')

#Map pct in poverty by county
income_heat_map <-ggplot(data=income_NC_sf_join)+
  geom_sf(aes(fill=PCTPOV017_2021))+labs(title= "% of County in Poverty - 2021", fill="%")
income_heat_map

#Heat map of CO2 emissions by county
#Compute sum of CO2 Emissions by county
CO2_emissions <-plant_gen_data %>%
  drop_na(PLCO2AN)%>%
  group_by(CNTYNAME)%>%
  summarize(Sum_CO2 = sum(PLCO2AN))

#Join the eGrid attributes to the county spatial features
CO2_counties_sf_join <-  merge(x = counties_sf,
                           y = CO2_emissions, 
                           by.x = 'NAME', 
                           by.y = 'CNTYNAME')

#Map CO2 emissions by county
CO2_map <-ggplot(data=CO2_counties_sf_join)+
  geom_sf(aes(fill=Sum_CO2))+
  labs(title="2021 CO2 Emissions",
       fill="CO2 Emissions (tn)")
CO2_map

#Heat map of NOx emissions by county
#Compute sum of NOx Emissions by county
NOx_emissions <-plant_gen_data %>%
  drop_na(PLNOXAN)%>%
  group_by(CNTYNAME)%>%
  summarize(Sum_NOx = sum(PLNOXAN))

#Join the eGrid attributes to the county spatial features
NOx_counties_sf_join <-  merge(x = counties_sf,
                           y = NOx_emissions, 
                           by.x = 'NAME', 
                           by.y = 'CNTYNAME')

#Map NOx emissions by county
NOx_map <-ggplot(data= NOx_counties_sf_join)+
  geom_sf(aes(fill=Sum_NOx))+
  labs(title="2021 NOx Emissions",
       fill=" NOx Emissions (tn)")
NOx_map

#Heat map of SO2 emissions by county
#Compute sum of SO2 Emissions by county
SO2_emissions <-plant_gen_data %>%
  drop_na(PLSO2AN)%>%
  group_by(CNTYNAME)%>%
  summarize(Sum_SO2 = sum(PLSO2AN))

#Join the eGrid attributes to the county spatial features
SO2_counties_sf_join <-  merge(x = counties_sf,
                           y = SO2_emissions, 
                           by.x = 'NAME', 
                           by.y = 'CNTYNAME')

#Map SO2 emissions by county
SO2_map <-ggplot(data=SO2_counties_sf_join)+
  geom_sf(aes(fill=Sum_SO2))+
  labs(title="2021 SO2 Emissions",
       fill="SO2 Emissions (tn)")
SO2_map

#Heat map of N2O emissions by county
#Compute sum of N2O Emissions by county
N2O_emissions <-plant_gen_data %>%
  drop_na(PLN2OAN)%>%
  group_by(CNTYNAME)%>%
  summarize(Sum_N2O = sum(PLN2OAN))

#Join the eGrid attributes to the county spatial features
N2O_counties_sf_join <- merge(x = counties_sf,
                           y = N2O_emissions, 
                           by.x = 'NAME', 
                           by.y = 'CNTYNAME')

#Map N2O emissions by county
N2O_map <-ggplot(data= N2O_counties_sf_join)+
  geom_sf(aes(fill=Sum_N2O))+
  labs(title="2021 N2O Emissions",
       fill=" N2O Emissions (lbs)")
N2O_map


#Heat map of CH4 emissions by county
#Compute sum of CH4 Emissions by county
CH4_emissions <-plant_gen_data %>%
  drop_na(PLCH4AN)%>%
  group_by(CNTYNAME)%>%
  summarize(Sum_CH4 = sum(PLCH4AN))

#Join the eGrid attributes to the county spatial features
CH4_counties_sf_join <- merge(x = counties_sf,
                           y = CH4_emissions, 
                           by.x = 'NAME', 
                           by.y = 'CNTYNAME')

#Map CH4 emissions by county
CH4_map <-ggplot(data= CH4_counties_sf_join)+
  geom_sf(aes(fill=Sum_CH4))+
  labs(title="2021 CH4 Emissions",
       fill="CH4 Emissions (lbs)")
CH4_map

```


```{r}
#Load in counties spatial data
counties_sf<- st_read(here('Data/Spatial/cb_2018_us_county_20m.shp')) %>% 
  filter(STATEFP==37)

#Convert eGrid tabular data to spatial data
plant_gen_sf <-plant_gen_data %>% st_as_sf(coords = c('LON','LAT'), crs=4269)

```


```{r}
#Create initial map of power plants
gens_counties_map <-ggplot()+
  geom_sf(data=counties_sf)+
  geom_sf(data=plant_gen_sf,size=0.8)+
  labs(title = "Locations of NC Power Plants")

gens_counties_map

#Compute sum of nameplate capacity by county
nameplate_capacity <-plant_gen_data %>%
  group_by(CNTYNAME)%>%
  summarize(Sum_NAMEPCAP = sum(NAMEPCAP_plant))

#Join the eGrid attributes to the county spatial features
counties_sf_join <-  merge(x = counties_sf,
                           y = plant_gen_data, 
                           by.x = 'NAME', 
                           by.y = 'CNTYNAME' )

#Map total generator capacity by county
gen_cap_map <-ggplot(data=counties_sf_join)+
  geom_sf(aes(fill=NAMEPCAP_plant))+labs(title="Capacity by County",fill="Capacity (MW)")
gen_cap_map

```


```{r Data Wrangling}

#Filter by North Carolina
Plant_NC <- plant %>% filter(PSTATABB=='NC')
gen_NC <-gen %>% filter(PSTATABB=='NC')

#Create Joined Plot
PowerPlants_DF <-merge(x=gen_NC,y=Plant_NC, by='ORISPL',all.x=TRUE)
```

```{r Creating income groupings}

# GENYRRET = Generator planned or actual retirement year (four-digit)
# GENYRONL - year the generator came online (four-digit)

summary(processed_data$GENYRRET) # 1161 NA's
retired_year <- processed_data$GENYRRET %>%
  na.omit()
# earliest year of plant retirement was 2021
# can't run time series analysis with this data, 
# but could run regression analysis to understand relationship between
# planned retirement and 2021 avg household income or
# 2021 retirement and 2021 unemployment
summary(retired_year)

summary(processed_data$GENYRONL) # no NA's
online_plants <- processed_data %>%
  # drop observations with NAs in GENYRONL
  # which means we don't know what year they came online
  # new number of observations should be 1175 (dropping 15 NAs)
  drop_na(GENYRONL) %>%
  select(FIPS_Code, CNTYNAME, SEQGEN, YEAR, PNAME, 
         GENID, GENSTAT, GENYRONL, NAMEPCAP_plant, 
         PLNGENAN, PLCO2AN, COALFLAG, MEDHHINC_2021,	
         Unemployment_rate_2000,	Unemployment_rate_2001,	
         Unemployment_rate_2002,	Unemployment_rate_2003,	
         Unemployment_rate_2004,	Unemployment_rate_2005,	
         Unemployment_rate_2006,	Unemployment_rate_2007,	
         Unemployment_rate_2008,	Unemployment_rate_2009,	
         Unemployment_rate_2010,	Unemployment_rate_2011,	
         Unemployment_rate_2012,	Unemployment_rate_2013,	
         Unemployment_rate_2014,	Unemployment_rate_2015,	
         Unemployment_rate_2016,	Unemployment_rate_2017,	
         Unemployment_rate_2018,	Unemployment_rate_2019,	
         Unemployment_rate_2020,	Unemployment_rate_2021,	
         Unemployment_rate_2022)
summary(online_plants)

online_year <- online_plants$GENYRONL
summary(online_year)

online_month_day_ <- rep(c("01-01-"), length(online_year))

# repeating month_day_ to fill in month and day
# for as many year entries as are found in 
# dropping NAs but may need to keep them in; decide as group
Date_Online <- paste0(online_month_day_,online_year)
summary(Date_Online)
head(Date_Online)
# 1175 observations in Date_Online

# change years to date formats
is.Date(Date_Online) # not a date
Date_Online <- as.Date(Date_Online, format = "%m-%d-%Y")
is.Date(Date_Online) # true

# ensure date column is in date format
online_plants <- online_plants %>%
  mutate(GENYRONL = Date_Online)
is.Date(online_plants$GENYRONL) # true

# identifying the county with the most power plants
county_freq_table <- table(online_plants$CNTYNAME)
view(county_freq_table)
max(county_freq_table) # 48, Robeson County
county_freq_table <- sort(county_freq_table, decreasing = TRUE)
view(county_freq_table)
robeson_online_plants <- online_plants %>%
  filter(CNTYNAME == "Robeson")
unique(robeson_online_plants$PNAME) # 44 unique power plant names
unique(robeson_online_plants$GENID) # 32 unique GENIDs

# multiple regression for just one county, Robeson 
# the one with highest total number of existing plants in 2021
# to understand relationship between year online for each power plant and unemployment 
# need to make table by year
# with 5 columns: Year, FIPS code, number of plants in existence that year, unemployment rate
robeson_year <- year(robeson_online_plants$GENYRONL)
robeson_FIPS_code <- robeson_online_plants$FIPS_Code
## MARKING WHERE GC LEFT OFF
#robeson_plant_count <- tally(robeson_online_plants$PNAME, wt = NULL, sort = FALSE, name = NULL)
is.Date(robeson_online_plants$GENYRONL)

```


# Question 2: Do power plant retirements have a significant impact on unemployment?
### The primary motivation behind this analysis is to delve into the nuanced equilibrium inherent in a just energy transition. The imperative of shifting energy fuel sources from carbon-intensive to fossil fuel-free must be achieved without detriment to communities. In this examination, we initially pinpoint counties in North Carolina with the highest and lowest numbers of retirements, comparing them to their respective unemployment rates over time. To conduct a more pointed analysis, a statistical examination is performed on a specific county of interest.
```{r, Unemployment_Retirements, echo=FALSE, warning=FALSE, error=FALSE}

################ DATA ANALYSIS: UNEMPLOYMENT AND GENERATOR RETIREMENTS ################ 

### Pre-Analysis Wrangling ###

#Set to numeric
gen20$NAMEPCAP <- as.numeric(gen20$NAMEPCAP)
gen20$GENNTOZ <- as.numeric(gen20$GENNTOZ)


#Combining gen20 and plant dataframes based on ORISPL
plant_gen20 <- gen20 %>%
  inner_join(plant_select, by = 'ORISPL', 
             suffix = c("_gen", "_plant"))

#Removing duplicate state abbreviation column
plant_gen_data_20 <- plant_gen20[, -which(names(plant_gen) == "PSTATABB_plant")]

#Merging with eGrid
ue_egrid_20 <- merge(plant_gen_data_20, ue, by = "FIPS_Code")

#Merging with income
processed_data_20 <- merge(ue_egrid_20, inc, by = "FIPS_Code")


#Transposing and wrangling both in order to view:
#   1. NC county unemployment by year, where we have a column for all years rather than each year having its own column
#   2. Generator retirement by year, selecting only those with instances of retired generators

#Unemployment
transposed_ue <- ue %>%
  filter(str_starts(FIPS_Code, "37")) %>%  # Filter to include only NC
  pivot_longer(cols = starts_with("Unemployment_rate_"), 
               names_to = "Year", 
               values_to = "Unemployment") %>%
  mutate(Year = gsub("Unemployment_rate_", "", Year, fixed = TRUE)) %>%
  pivot_wider(names_from = "FIPS_Code", values_from = "Unemployment")

#Generator
generator_retirement_data <- processed_data_20 %>% 
  select(FIPS_Code, GENYRRET) %>%
  na.omit()  #showing only generators that have retired


###### EXPLORATION #######

#Use table to count the occurrences of each unique FIPS code to select counties of interest
fips_counts <- table(generator_retirement_data$FIPS_Code)

for (i in seq_along(fips_counts)) {
  fips <- names(fips_counts)[i]
  count <- fips_counts[i]
  cat("FIPS Code:", fips, "has", count, "rows.\n")}

fips_counts <- table(generator_retirement_data$FIPS_Code)#identifies 2 counties with 7 instances of retirements

```

### FIPS Code 37159 (Rowan) and 37191 (Wayne) each have the highest number of retirements at 7 rows.
### FIPS Code 37023  (Burke) 37041 (Chowan) 37049  (Craven) 37063 (Durham) 37067 (Forsyth) 37069 (Franklin) 37125 (Moore) each have 1 row.


```{r, cols_interest, echo=FALSE, warning=FALSE, error=FALSE}

#Creating df for only columns.counties of interest
rowan_ue <- transposed_ue[, c("Year", "37159")]
wayne_ue <- transposed_ue[, c("Year", "37191")]
durham_ue <- transposed_ue[, c("Year", "37063")] 
Chowan_ue <- transposed_ue[, c("Year", "37049")] 

rowan_ret <-  generator_retirement_data[generator_retirement_data$FIPS_Code == 37159, ]
wayne_ret <-  generator_retirement_data[generator_retirement_data$FIPS_Code == 37191, ]
durham_ret <-  generator_retirement_data[generator_retirement_data$FIPS_Code == 37063, ]
Chowan_ret <-  generator_retirement_data[generator_retirement_data$FIPS_Code == 37049, ]


#Converting to date format
rowan_ue$Year <- as.Date(rowan_ue$Year, format = "%Y")
wayne_ue$Year <- as.Date(wayne_ue$Year, format = "%Y")
durham_ue$Year <- as.Date(durham_ue$Year, format = "%Y")
Chowan_ue$Year <- as.Date(durham_ue$Year, format = "%Y")

#Plot
combined_plot <- ggplot() +
  geom_line(data = rowan_ue, aes(x = Year, y = `37159`, color = "Rowan"), size = 1) +
  geom_line(data = wayne_ue, aes(x = Year, y = `37191`, color = "Wayne"), size = 1) +
  geom_line(data = durham_ue, aes(x = Year, y = `37063`, color = "Durham"), size = 1) +
  geom_line(data = Chowan_ue, aes(x = Year, y = `37049`, color = "Chowan"), size = 1) +
  geom_vline(xintercept = 2012, linetype = "dashed", color = "black", size = 1) +
  labs(title = "Unemployment in Wayne, Rowan, Durham, and Chowan Counties",
       x = "Year",
       y = "Unemployment Rate (%)",
       color = "Dataset") +
  scale_color_manual(values = c("Rowan" = "blue", "Wayne" = "lightblue", "Durham" = "darkgreen", "Chowan" = "lightgreen")) +
  theme(legend.title = element_blank())

print(combined_plot)
```
##### In this analysis, counties experiencing both high (blue)and low (green)numbers of generator retirements, such as Rowan and Wayne (high retirements) and Burke and Craven (low retirements), are singled out. The objective is to investigate whether fluctuations in unemployment rates are influenced by generator retirements or if the rates exhibit similar trends irrespective of such retirements. Through this exploratory analysis, the goal is to discern any distinctive patterns in unemployment dynamics. As the plot shows instances in which the unemployment rates do not follow the hypothesized pattern, another variable was chosen for statistical analysis.


```{r, echo=FALSE, warning=FALSE, error=FALSE}
#Selecting Rowan only
rowan_data <- generator_retirement_data[generator_retirement_data$FIPS_Code == 37159, ]

#Rename generator retirement year to year in order to combine for analysis
colnames(rowan_data)[colnames(rowan_data) == "GENYRRET"] <- "Year"

#Merge by year
rowan_merged_data <- merge(rowan_data, rowan_ue, by = "Year", all.x = TRUE)


### Data Wrangling ###

#Renaming columnn
names(rowan_ue)[trimws(names(rowan_ue)) == "37159"] <- "Rowan UE (%)"

#Adding nameplate capacity to generator
rowan_generator_retirement_NPACP <- processed_data_20 %>% 
  select(FIPS_Code, GENYRRET, NAMEPCAP_gen) %>%
  filter(FIPS_Code == "37159") %>%  # Filter for Rowan county
  na.omit() %>% #selecting only data with retirements
  rename(Year = GENYRRET)  # Renaming the column

#Converting to date format
rowan_generator_retirement_NPACP$Year <- as.Date(paste(rowan_generator_retirement_NPACP$Year, "12-06", sep = "-"), format = "%Y-%m-%d")

#Merging
rowan_merged_data_NPCAP <- merge(rowan_generator_retirement_NPACP, rowan_ue, by = "Year", all.x = TRUE)

#### Data Analysis ###

#Linear regression
lm_result <- lm(`Rowan UE (%)` ~ NAMEPCAP_gen, data = rowan_merged_data_NPCAP)
summary(lm_result) 
```

##### Contrary to the initial hypothesis, this regression indicates that for each MW increase in retired nameplate capacity, the unemployment rate unemployment rate in Rowan is expected to decrease by approximately 0.02428 percentage points. The p-value is greater than 0.05,but given that it is only marginally higher (at 0.0619) we can theoretically interpret there to be a weak relationship. However, it must be understood that the sample size is small and therefore we would need much more data for any reliable conclusions.

##### The Multiple R-squared value of 0.5346 represents the proportion of the variance in the response variable (Rowan UE (%)) that can be explained by the predictor variable retired nameplate capacity (MW).

```

#Question 3: What is the relationship between air quality and health issues?
*[Description here]*

```{r EBM Variables Relationship Analysis}
#Environmental Burden

# E_PM = Annual mean days above PM2.5 regulatory standard - 3-year average
# E_DSLPM = Ambient concentrations of diesel PM/m3
# E_OZONE = Annual mean days above O3 regulatory standard - 3-year average
# EP_BPHIGH = Percentage of individuals with Raw high blood pressures values
# EP_ASTHMA = Percentage of individuals with asthma

#To what extent does high PM exposure explain asthma in NC 
PM_asthma_lm<- lm(data = EBM_countytract, EP_ASTHMA ~ E_PM)
summary(PM_asthma_lm)
# p-value < 0.05
# the R-squared value of .0097 signifies that elevated PM concentrations only explain less than 1% of the variability in asthma in NC tracts
cor.test(EBM_countytract$EP_ASTHMA, EBM_countytract$E_PM)
# -.098 signifies a negative and significant but not super strong correlation

#To what extent does high PM exposure explain high blood pressure in NC 
PM_bphigh_lm<- lm(data = EBM_countytract, EP_BPHIGH ~ E_PM)
summary(PM_bphigh_lm)
# p-value < 0.05
# the R-squared value of .0927 signifies that elevated PM concentrations explain 9.27% of the variability in high blood pressure in NC tracts
cor.test(EBM_countytract$EP_BPHIGH, EBM_countytract$E_PM)
# -0.30 signifies a negative and significant but not super strong correlation

#Multiple regression looking at whether coal proximity, PM, and ozone might explain high blood pressure
EBM_highbp_lm <- lm(EP_BPHIGH ~ E_PM + E_DSLPM + E_OZONE, data=EBM_countytract)
step(EBM_highbp_lm)

#Multiple regression looking at whether coal proximity, PM, and ozone might explain asthma
EBM_asthma_lm <- lm(EP_ASTHMA ~ E_PM + E_DSLPM + E_OZONE, data=EBM_countytract)
step(EBM_asthma_lm)

#Run the multiple regression to determine whether there is a relationship
EBM_multivar_lm <- lm(EP_UNINSUR ~ EP_ASTHMA + EP_BPHIGH + E_IMPWTR + 
                        E_COAL + E_PM + E_OZONE,
                        data=EBM_countytract)
step(EBM_multivar_lm)

EBM_lead_wtr_lm <- lm(EP_UNINSUR ~ E_IMPWTR + 
                        E_PM,
                        data=EBM_countytract)
step(EBM_lead_wtr_lm)
#Summarize the multiple regression
summary(EBM_multivar_lm)

# ------------- PROBABLY WON'T INCLUDE WHAT'S BELOW, LET'S DISCUSS -------------
# to what extent does proximity to coal explain PM -- FRUITLESS BC COAL IS ZEROES 
coal_PM_lm<- lm(data = EBM_countytract, E_PM ~ E_COAL)
summary(coal_PM_lm)

# to what extent does proximity to coal explain asthma -- FRUITLESS BC COAL IS ZEROES
coal_asthma_lm<- lm(data = EBM_countytract, EP_ASTHMA ~ E_COAL)
summary(coal_asthma_lm)

# to what extent does proximity to coal explain high blood pressure -- FRUITLESS BC COAL IS ZEROES
coal_highbp_lm<- lm(data = EBM_countytract, EP_BPHIGH ~ E_COAL)
summary(coal_highbp_lm)

```


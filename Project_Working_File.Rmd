----
title: "EDE Group Project"
author: "Gaby Czarniak, Mara Michel, Sam Sedar"
date: "2023-11-14"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(lubridate)
library(here); here()
library(rvest)
library(cowplot)
library(agricolae)
library(dplyr)
library(tidyverse)
library(lubridate)
library(trend)
library(zoo) 
library(Kendall)
library(tseries)
library(sf)
library(leaflet)
library(mapview); mapviewOptions(fgb = FALSE)
```



```{r Data Load}

#Loading Data into Raw Data folder

plant <- read.csv(here('Data/Raw/PLNT21.csv'),
                  stringsAsFactors = FALSE, skip = 1, 
                  colClasses = c('FIPSST' = 'character', 
                                 'FIPSCNTY' = 'character',
                                 'ORISPL' = 'character'))

gen <- read.csv(here('Data/Raw/GEN21.csv'), 
                stringsAsFactors = FALSE, skip = 1, 
                  colClasses = c('ORISPL' = 'character'))

income <- read.csv(here('Data/Raw/PovertyEstimates.csv'), 
                  stringsAsFactors = TRUE, skip = 4)

unemployment <- read.csv(here('Data/Raw/Unemployment.csv'), 
                  stringsAsFactors = TRUE, skip = 4)

```


```{r}
#####  DATA WRANGLING  #####

#eGRID Data

#Selecting columns of interest from plant data
plant_select <- plant %>%
  select(PSTATABB, ORISPL, FIPSST, FIPSCNTY, PLFUELCT, NAMEPCAP,
         PLNGENAN,PLSO2RTA, PLCO2RTA, PLCH4RTA, PLN2ORTA, PLCO2AN, 
         PLSO2AN,PLCH4AN, CNTYNAME, LAT,
         LON, COALFLAG) %>%
  filter(PSTATABB == "NC") %>%
  unite(FIPS_Code, FIPSST, FIPSCNTY, sep = "")

plant_select$PLNGENAN <- as.numeric(plant_select$PLNGENAN)
plant_select$PLCO2RTA <- as.numeric(plant_select$PLCO2RTA)
plant_select$PLCO2AN <- as.numeric(plant_select$PLCO2AN)
plant_select$NAMEPCAP <- as.numeric(plant_select$NAMEPCAP)



#Combining Generator and Plant df based on ORISPL
plant_gen <- gen %>%
  inner_join(plant_select, by = 'ORISPL', 
             suffix = c("_gen", "_plant"))

plant_gen$CFACT <- as.numeric(plant_gen$CFACT)
plant_gen$GENNTOZ <- as.numeric(plant_gen$GENNTOZ)
plant_gen$NAMEPCAP_gen <- as.numeric(plant_gen$NAMEPCAP_gen)
plant_gen$GENNTAN <- as.numeric(plant_gen$GENNTAN)

#Removing duplicate state abbreviation column
plant_gen_data <- plant_gen[, -which(names(plant_gen) == "PSTATABB_plant")]


#UNEMPLOYMENT

#Selecting columns of interest: unemployment rates: 2002-2022

ue <- unemployment %>%
  select(FIPS_Code,	Unemployment_rate_2000,	Unemployment_rate_2001,	Unemployment_rate_2002,	Unemployment_rate_2003,	Unemployment_rate_2004,	Unemployment_rate_2005,	Unemployment_rate_2006,	Unemployment_rate_2007,	Unemployment_rate_2008,	Unemployment_rate_2009,	Unemployment_rate_2010,	Unemployment_rate_2011,	Unemployment_rate_2012,	Unemployment_rate_2013,	Unemployment_rate_2014,	Unemployment_rate_2015,	Unemployment_rate_2016,	Unemployment_rate_2017,	Unemployment_rate_2018,	Unemployment_rate_2019,	Unemployment_rate_2020,	Unemployment_rate_2021,	Unemployment_rate_2022)

#Merging with eGrid
ue_egrid <- merge(plant_gen_data, ue, by = "FIPS_Code")


#INCOME

#Selecting columns of interest: 
inc <- income %>%
  select(FIPS_Code, PCTPOVALL_2021, MEDHHINC_2021)

#Merging
processed_data <- merge(ue_egrid, inc, by = "FIPS_Code")

colnames(processed_data)


```
```{r}
#EXPLORATION
summary(processed_data)


```

```{r}
#Load in counties data
counties_sf<- st_read(here('Data/Spatial/cb_2018_us_county_20m.shp')) %>% 
  filter(STATEFP==37)

#Convert eGrid tabular data to spatial data
plant_gen_sf <-plant_gen_data %>% st_as_sf(coords = c('LON','LAT'), crs=4269)

#Create initial map of power plants
gens_counties_map <-ggplot()+
  geom_sf(data=counties_sf)+
  geom_sf(data=plant_gen_sf,size=0.8)+
  labs(title = "Locations of NC Power Plants")

gens_counties_map

#Compute sum of nameplate capacity by county
nameplate_capacity <-plant_gen_data %>%
  group_by(CNTYNAME)%>%
  summarize(Sum_NAMEPCAP = sum(NAMEPCAP_plant))

#Join the eGrid attributes to the county spatial features
counties_sf_join <-  merge(x = counties_sf,
                           y = plant_gen_data, 
                           by.x = 'NAME', 
                           by.y = 'CNTYNAME' )

#Map total generator capacity by county
gen_cap_map <-ggplot(data=counties_sf_join)+
  geom_sf(aes(fill=NAMEPCAP_plant))
gen_cap_map

```



```{r Data Wrangling}

#Filter by North Carolina
Plant_NC <- plant %>% filter(PSTATABB=='NC')
gen_NC <-gen %>% filter(PSTATABB=='NC')

#Create Joined Plot
PowerPlants_DF <-merge(x=gen_NC,y=Plant_NC, by='ORISPL',all.x=TRUE)
```

```{r Creating income groupings}

summary(processed_data$MEDHHINC_2021)

low_threshold <- 44477
medium_threshold <- 52463

# Create subsets based on income thresholds
low_income_subset <- processed_data[processed_data$MEDHHINC_2021 < low_threshold, ]

medium_income_subset <- processed_data[processed_data$MEDHHINC_2021 >= low_threshold & processed_data$MEDHHINC_2021 < medium_threshold, ]

high_income_subset <- processed_data[processed_data$MEDHHINC_2021 >= medium_threshold, ]

ts_low_income <- ts(low_income_subset$Unemployment_rate_2000:low_income_subset$Unemployment_rate_2022, start = min(low_income_subset$YEAR), end = max(low_income_subset$YEAR))


```


```{r Income and Fuel Category}

#NC Breakdown of Fuel by Category
fuel_summarized <- processed_data %>%
  group_by(PLFUELCT) %>%
  summarise(total_generation = sum(PLNGENAN, na.rm = TRUE))
print(fuel_summarized)

#In percentages
fuel_summarized$percentage <- fuel_summarized$total_generation / sum(fuel_summarized$total_generation) * 100

#Pie chart with percent makeup of fuel in  NC
pie_chart_percentage <- ggplot(fuel_summarized, aes(x = factor(1), fill = PLFUELCT, y = percentage)) +
  geom_bar(width = 1, stat = "identity") +
  coord_polar(theta = "y") +
  labs(title = "North Carolina Primary Fuel (% of Total Annual Generation)",
       fill = "Primary Fuel Type",
       y = "Percentage of Total Generation (%)", x = NULL)
print(pie_chart_percentage)




#Relationship between income and fuel type
processed_data$MEDHHINC_2021 <- as.numeric(processed_data$MEDHHINC_2021)

#scatter vis
scatter_income_generation <- ggplot(processed_data, aes(x = MEDHHINC_2021, y = PLNGENAN, color = PLFUELCT)) +
  geom_point() +
  labs(title = "Relationship Between Annual Generation, Fuel Type, and Income",
       x = "Median Household Income",
       y = "Annual Generation",
       color = "Fuel Type")
print(scatter_income_generation)


####IN PROGRESS###
scatter_faceted_county <- ggplot(processed_data, aes(x = MEDHHINC_2021, y = PLNGENAN, color = PLFUELCT)) +
  geom_point() +
  facet_wrap(~CNTYNAME, scales = "free") +
  labs(title = "Relationship Between Annual Generation, Fuel Type, and Income by County",
       x = "Median Household Income",
       y = "Annual Generation",
       color = "Fuel Type")
print(scatter_faceted_county)

stacked_barplot_total_generation <- ggplot(processed_data, aes(x = CNTYNAME, y = PLNGENAN, fill = PLFUELCT)) +
  geom_bar(stat = "sum", position = "stack") +
  labs(title = "Total Annual Generation by Fuel Type and County",
       x = "County",
       y = "Total Annual Generation",
       fill = "Fuel Type") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
print(stacked_barplot_total_generation)

```
